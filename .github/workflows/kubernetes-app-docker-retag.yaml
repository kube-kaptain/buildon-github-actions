# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)

name: Kubernetes App - Docker Retag
on:
  workflow_call:
    inputs:
      # Build output
      output-sub-path:
        description: 'Build output directory (relative)'
        required: false
        type: string
        default: 'target'

      # Docker registry logins
      docker-registry-logins:
        description: 'YAML config for Docker registry logins (registry URL as key)'
        required: false
        type: string
        default: ''
      # Docker source image configuration
      docker-source-registry:
        description: 'Upstream registry (e.g., docker.io)'
        required: true
        type: string
      docker-source-base-path:
        description: 'Path between registry and image name (e.g., library)'
        required: false
        type: string
        default: ''
      docker-source-image-name:
        description: 'Upstream image name (e.g., nginx)'
        required: true
        type: string
      docker-source-tag:
        description: 'Upstream image tag (e.g., 1.25)'
        required: true
        type: string
      # Docker target config
      docker-target-registry:
        description: 'Target container registry'
        required: false
        type: string
        default: 'ghcr.io'
      docker-target-base-path:
        description: 'Path between registry and image name (auto-set for GHCR)'
        required: false
        type: string
        default: ''
      # Docker push targets
      docker-push-targets:
        description: 'JSON array of additional push targets [{registry, base-path?}]'
        required: false
        type: string
        default: ''

      # Manifests source
      manifests-sub-path:
        description: 'Directory containing Kubernetes manifests (relative)'
        required: false
        type: string
        default: 'src/kubernetes'
      # Manifests packaging
      manifests-repo-provider-type:
        description: 'Repo provider type for manifest storage (default: docker, currently the only supported provider)'
        required: false
        type: string
        default: 'docker'
      manifests-packaging-base-image:
        description: 'Base image for manifest packaging (default: scratch)'
        required: false
        type: string
        default: ''

      # Kubernetes generation
      kubernetes-global-additional-labels:
        description: 'Additional labels for all Kubernetes manifests (comma-separated key=value)'
        required: false
        type: string
        default: ''
      kubernetes-global-additional-annotations:
        description: 'Additional annotations for all Kubernetes manifests (comma-separated key=value)'
        required: false
        type: string
        default: ''
      # Kubernetes ConfigMap generation
      kubernetes-configmap-sub-path:
        description: 'Directory containing ConfigMap data files (relative)'
        required: false
        type: string
        default: 'src/configmap'
      kubernetes-configmap-name-checksum-injection:
        description: 'Enable checksum injection suffix in ConfigMap name (true: ProjectName-configmap-checksum, false: ProjectName)'
        required: false
        type: boolean
        default: true
      kubernetes-configmap-additional-labels:
        description: 'Additional labels specific to ConfigMap (comma-separated key=value)'
        required: false
        type: string
        default: ''
      kubernetes-configmap-additional-annotations:
        description: 'Additional annotations specific to ConfigMap (comma-separated key=value)'
        required: false
        type: string
        default: ''
      # Kubernetes Secret template generation
      kubernetes-secret-template-sub-path:
        description: 'Directory containing Secret template data files (relative)'
        required: false
        type: string
        default: 'src/secret.template'
      kubernetes-secret-template-name-checksum-injection:
        description: 'Enable checksum injection suffix in Secret name (true: ProjectName-secret-checksum, false: ProjectName)'
        required: false
        type: boolean
        default: true
      kubernetes-secret-template-additional-labels:
        description: 'Additional labels specific to Secret template (comma-separated key=value)'
        required: false
        type: string
        default: ''
      kubernetes-secret-template-additional-annotations:
        description: 'Additional annotations specific to Secret template (comma-separated key=value)'
        required: false
        type: string
        default: ''

      # Token substitution
      token-delimiter-style:
        description: 'Token delimiter syntax for variables (shell, mustache, helm, erb, github-actions, blade, stringtemplate, ognl, t4, swift)'
        required: false
        type: string
        default: 'shell'
      token-name-style:
        description: 'Case style for token names (UPPER_SNAKE, lower_snake, lower-kebab, UPPER-KEBAB, camelCase, PascalCase, lower.dot, UPPER.DOT)'
        required: false
        type: string
        default: 'PascalCase'
      token-name-validation:
        description: 'How to validate user token names (MATCH = must match token-name-style, ALL = accept any valid name)'
        required: false
        type: string
        default: 'MATCH'
      allow-builtin-token-override:
        description: 'Allow user tokens to override built-in tokens (for template/reusable projects)'
        required: false
        type: boolean
        default: false
      config-sub-path:
        description: 'Directory containing user-defined token files (relative)'
        required: false
        type: string
        default: 'src/config'
      config-value-trailing-newline:
        description: 'How to handle trailing newlines in config values (strip-for-single-line, preserve-all, always-strip-one-newline)'
        required: false
        type: string
        default: 'strip-for-single-line'

      # Naming, Versions, and Tags calculation
      release-branch:
        description: 'The release branch name'
        required: false
        type: string
        default: 'main'
      additional-release-branches:
        description: 'Comma-separated list of additional release branches'
        required: false
        type: string
        default: ''
      tag-version-max-parts:
        description: 'Maximum allowed version parts (fail if exceeded)'
        required: false
        type: number
        default: 3
      tag-version-calculation-strategy:
        description: 'Strategy for calculating version (git-auto-closest-highest, file-pattern-match)'
        required: false
        type: string
        default: 'git-auto-closest-highest'
      tag-version-pattern-type:
        description: 'Pattern type for file-pattern-match strategy (dockerfile-env-kubectl, retag-workflow-source-tag, custom)'
        required: false
        type: string
        default: 'dockerfile-env-kubectl'
      tag-version-prefix-parts:
        description: 'Number of parts from source version to use as prefix (default 2, output = prefix + 1 parts)'
        required: false
        type: string
        default: ''
      dockerfile-sub-path:
        description: 'Directory containing Dockerfile, relative to repo root.'
        required: false
        type: string
        default: 'src/docker'
      tag-version-source-sub-path:
        description: 'Override path to source directory (takes precedence over dockerfile-sub-path)'
        required: false
        type: string
        default: ''
      tag-version-source-file-name:
        description: 'Override source file name (defaults based on pattern type)'
        required: false
        type: string
        default: ''
      tag-version-source-custom-pattern:
        description: 'Regex with capture group for version extraction (required for custom pattern type)'
        required: false
        type: string
        default: ''

      # Quality check options
      block-slashes:
        description: 'DEPRECATED: Use block-slash-containing-branches instead'
        required: false
        type: boolean
        default: false
      qc-block-slash-containing-branches:
        description: 'Block branch names containing slashes'
        required: false
        type: boolean
        default: false
      qc-block-double-hyphen-containing-branches:
        description: 'Block branch names containing double hyphens (typo detection)'
        required: false
        type: boolean
        default: true
      qc-require-conventional-branches:
        description: 'Require branch names start with feature/, fix/, etc.'
        required: false
        type: boolean
        default: false
      qc-require-conventional-commits:
        description: 'Require commits use conventional commit format (feat:, fix:, etc.)'
        required: false
        type: boolean
        default: false
      qc-block-conventional-commits:
        description: 'Block commits that use conventional commit format'
        required: false
        type: boolean
        default: false

      # Hook script paths
      hook-pre-tagging-tests-script-sub-path:
        description: 'Path to pre-tagging test script relative to .github/ (e.g., bin/pre-tagging.bash)'
        required: false
        type: string
        default: ''
      hook-pre-package-prepare-script-sub-path:
        description: 'Path to pre-package prepare script relative to .github/ (e.g., bin/pre-package-prepare.bash)'
        required: false
        type: string
        default: ''
      hook-post-package-tests-script-sub-path:
        description: 'Path to post-package test script relative to .github/ (e.g., bin/post-package.bash)'
        required: false
        type: string
        default: ''

      # GitHub release
      github-release-enabled:
        description: 'Create a GitHub release on version tags'
        required: false
        type: boolean
        default: true
      github-release-substituted-files:
        description: 'Files with token substitution and version suffix (space-separated)'
        required: false
        type: string
        default: ''
      github-release-verbatim-files:
        description: 'Files copied as-is with version suffix only (space-separated)'
        required: false
        type: string
        default: ''
      github-release-notes:
        description: 'Release notes (leave empty for auto-generated)'
        required: false
        type: string
        default: ''
      github-release-add-version-to-filenames:
        description: 'Add version suffix to release filenames (e.g., file.yaml -> file-1.2.3.yaml)'
        required: false
        type: boolean
        default: true
    secrets:
      docker-registry-logins-secrets:
        description: 'JSON object of secrets for docker-registry-logins (e.g., {"DOCKER_USER": "x", "DOCKER_PASS": "y"})'
        required: false
    outputs:
      # Version outputs
      version:
        description: 'The generated version'
        value: ${{ jobs.build.outputs.version }}
      version-major:
        description: 'Major version number'
        value: ${{ jobs.build.outputs.version-major }}
      version-minor:
        description: 'Minor version number'
        value: ${{ jobs.build.outputs.version-minor }}
      version-patch:
        description: 'Patch version number'
        value: ${{ jobs.build.outputs.version-patch }}
      version-2-part:
        description: 'Version padded/truncated to 2 parts'
        value: ${{ jobs.build.outputs.version-2-part }}
      version-3-part:
        description: 'Version padded/truncated to 3 parts'
        value: ${{ jobs.build.outputs.version-3-part }}
      version-4-part:
        description: 'Version padded/truncated to 4 parts'
        value: ${{ jobs.build.outputs.version-4-part }}
      docker-tag:
        description: 'Tag for Docker images'
        value: ${{ jobs.build.outputs.docker-tag }}
      docker-image-name:
        description: 'Docker image name'
        value: ${{ jobs.build.outputs.docker-image-name }}
      git-tag:
        description: 'Tag for git'
        value: ${{ jobs.build.outputs.git-tag }}
      project-name:
        description: 'The repository/project name'
        value: ${{ jobs.build.outputs.project-name }}
      is-release:
        description: 'Whether this is a release build'
        value: ${{ jobs.build.outputs.is-release }}
      # Docker retag outputs
      docker-source-image-full-uri:
        description: 'Full source image reference'
        value: ${{ jobs.build.outputs.docker-source-image-full-uri }}
      docker-target-image-full-uri:
        description: 'Full target image reference'
        value: ${{ jobs.build.outputs.docker-target-image-full-uri }}
      docker-image-full-uri:
        description: 'Full docker image reference (alias for docker-target-image-full-uri)'
        value: ${{ jobs.build.outputs.docker-target-image-full-uri }}
      docker-image-pushed:
        description: 'Whether docker image was pushed'
        value: ${{ jobs.build.outputs.docker-image-pushed }}
      # Manifest package outputs
      manifests-zip-sub-path:
        description: 'Directory containing manifests zip file (relative)'
        value: ${{ jobs.build.outputs.manifests-zip-sub-path }}
      manifests-zip-file-name:
        description: 'Name of manifests zip file'
        value: ${{ jobs.build.outputs.manifests-zip-file-name }}
      # Manifest repo provider publish outputs
      manifests-uri:
        description: 'Reference to published manifests (format depends on repo provider)'
        value: ${{ jobs.build.outputs.manifests-uri }}
      manifests-published:
        description: 'Whether manifests were published'
        value: ${{ jobs.build.outputs.manifests-published }}
jobs:
  basic-quality-checks:
    name: Basic Quality Checks
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Parse workflow ref
        id: parse
        run: |
          # Extract caller's workflow file path from github.workflow_ref
          # Format: owner/repo/.github/workflows/file.yaml@ref
          workflow_path="${GITHUB_WORKFLOW_REF%%@*}"
          workflow_file=".github/workflows/${workflow_path##*/}"

          echo "Resolving ref for reusable workflow: kubernetes-app-docker-retag.yaml"
          echo "Caller workflow: $workflow_file"

          # Check for local call (dogfooding) - uses: ./.github/workflows/...
          if grep -q 'uses:[[:space:]]*\./.github/workflows/kubernetes-app-docker-retag\.yaml[[:space:]]*$' "$workflow_file" || \
             grep -q 'uses:[[:space:]]*\./.github/workflows/kubernetes-app-docker-retag\.yaml[[:space:]]*#' "$workflow_file"; then
            echo "Local workflow call detected (dogfooding)"
            echo "ref=LOCAL" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find all uses lines that call this workflow and extract refs
          refs=$(grep -o 'buildon-github-actions/.github/workflows/kubernetes-app-docker-retag\.yaml@[^[:space:]"'"'"']*' "$workflow_file" | sed 's/.*@//')

          if [ -z "$refs" ]; then
            echo "::error::Could not find buildon-github-actions ref in $workflow_file"
            exit 1
          fi

          # Check all refs are identical
          unique_refs=$(echo "$refs" | sort -u)
          ref_count=$(echo "$unique_refs" | wc -l | tr -d ' ')
          echo "Found $ref_count unique ref(s): $(echo "$unique_refs" | tr '\n' ' ')"

          if [ "$ref_count" -gt 1 ]; then
            echo "::error::Multiple different refs found in $workflow_file: $(echo "$unique_refs" | tr '\n' ' ')"
            exit 1
          fi

          echo "Resolved ref: $unique_refs"
          echo "ref=$unique_refs" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_WORKFLOW_REF: ${{ github.workflow_ref }}

      - name: Checkout actions
        if: steps.parse.outputs.ref != 'LOCAL' && success()
        uses: actions/checkout@v4.2.2
        with:
          repository: kube-kaptain/buildon-github-actions
          ref: ${{ steps.parse.outputs.ref }}
          path: .github/buildon-github-actions

      - name: Link local actions
        if: steps.parse.outputs.ref == 'LOCAL' && success()
        run: |
          echo "Linking local actions for dogfooding"
          ln -s "$(pwd)" .github/buildon-github-actions
      - name: Basic quality checks
        id: quality
        uses: ./.github/buildon-github-actions/src/actions/basic-quality-checks
        with:
          release-branch: ${{ inputs.release-branch }}
          additional-release-branches: ${{ inputs.additional-release-branches }}
          block-slashes: ${{ inputs.block-slashes }}
          qc-block-slash-containing-branches: ${{ inputs.qc-block-slash-containing-branches }}
          qc-block-double-hyphen-containing-branches: ${{ inputs.qc-block-double-hyphen-containing-branches }}
          qc-require-conventional-branches: ${{ inputs.qc-require-conventional-branches }}
          qc-require-conventional-commits: ${{ inputs.qc-require-conventional-commits }}
          qc-block-conventional-commits: ${{ inputs.qc-block-conventional-commits }}
  build:
    name: Build & Publish
    needs: basic-quality-checks
    if: always() && (needs.basic-quality-checks.result == 'success' || needs.basic-quality-checks.result == 'skipped')
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      packages: write
      checks: write
    outputs:
      version: ${{ steps.versions.outputs.version }}
      version-major: ${{ steps.versions.outputs.version-major }}
      version-minor: ${{ steps.versions.outputs.version-minor }}
      version-patch: ${{ steps.versions.outputs.version-patch }}
      version-2-part: ${{ steps.versions.outputs.version-2-part }}
      version-3-part: ${{ steps.versions.outputs.version-3-part }}
      version-4-part: ${{ steps.versions.outputs.version-4-part }}
      docker-tag: ${{ steps.versions.outputs.docker-tag }}
      docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
      git-tag: ${{ steps.versions.outputs.git-tag }}
      project-name: ${{ steps.versions.outputs.project-name }}
      is-release: ${{ steps.versions.outputs.is-release }}
      docker-source-image-full-uri: ${{ steps.docker-build.outputs.docker-source-image-full-uri }}
      docker-target-image-full-uri: ${{ steps.docker-build.outputs.docker-target-image-full-uri }}
      docker-image-pushed: ${{ steps.docker-push.outputs.image-pushed }}
      manifests-zip-sub-path: ${{ steps.manifest-package.outputs.manifests-zip-sub-path }}
      manifests-zip-file-name: ${{ steps.manifest-package.outputs.manifests-zip-file-name }}
      manifests-uri: ${{ steps.manifest-repo-provider-publish.outputs.manifests-uri }}
      manifests-published: ${{ steps.manifest-repo-provider-publish.outputs.manifests-published }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Parse workflow ref
        id: parse
        run: |
          # Extract caller's workflow file path from github.workflow_ref
          # Format: owner/repo/.github/workflows/file.yaml@ref
          workflow_path="${GITHUB_WORKFLOW_REF%%@*}"
          workflow_file=".github/workflows/${workflow_path##*/}"

          echo "Resolving ref for reusable workflow: kubernetes-app-docker-retag.yaml"
          echo "Caller workflow: $workflow_file"

          # Check for local call (dogfooding) - uses: ./.github/workflows/...
          if grep -q 'uses:[[:space:]]*\./.github/workflows/kubernetes-app-docker-retag\.yaml[[:space:]]*$' "$workflow_file" || \
             grep -q 'uses:[[:space:]]*\./.github/workflows/kubernetes-app-docker-retag\.yaml[[:space:]]*#' "$workflow_file"; then
            echo "Local workflow call detected (dogfooding)"
            echo "ref=LOCAL" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find all uses lines that call this workflow and extract refs
          refs=$(grep -o 'buildon-github-actions/.github/workflows/kubernetes-app-docker-retag\.yaml@[^[:space:]"'"'"']*' "$workflow_file" | sed 's/.*@//')

          if [ -z "$refs" ]; then
            echo "::error::Could not find buildon-github-actions ref in $workflow_file"
            exit 1
          fi

          # Check all refs are identical
          unique_refs=$(echo "$refs" | sort -u)
          ref_count=$(echo "$unique_refs" | wc -l | tr -d ' ')
          echo "Found $ref_count unique ref(s): $(echo "$unique_refs" | tr '\n' ' ')"

          if [ "$ref_count" -gt 1 ]; then
            echo "::error::Multiple different refs found in $workflow_file: $(echo "$unique_refs" | tr '\n' ' ')"
            exit 1
          fi

          echo "Resolved ref: $unique_refs"
          echo "ref=$unique_refs" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_WORKFLOW_REF: ${{ github.workflow_ref }}

      - name: Checkout actions
        if: steps.parse.outputs.ref != 'LOCAL' && success()
        uses: actions/checkout@v4.2.2
        with:
          repository: kube-kaptain/buildon-github-actions
          ref: ${{ steps.parse.outputs.ref }}
          path: .github/buildon-github-actions

      - name: Link local actions
        if: steps.parse.outputs.ref == 'LOCAL' && success()
        run: |
          echo "Linking local actions for dogfooding"
          ln -s "$(pwd)" .github/buildon-github-actions

      # === Docker Registry Logins ===
      - name: Docker registry logins
        uses: ./.github/buildon-github-actions/src/actions/docker-registry-logins
        with:
          config: ${{ inputs.docker-registry-logins }}
          secrets-json: ${{ secrets.docker-registry-logins-secrets || toJSON(secrets) }}
          docker-target-registry: ${{ inputs.docker-target-registry }}

      # === Pre-tagging Tests ===
      - name: Start check - Pre-tagging Tests
        if: inputs.hook-pre-tagging-tests-script-sub-path != '' && success()
        id: check-pre-tagging
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Pre-tagging Tests'
      - name: Run pre-tagging tests
        if: inputs.hook-pre-tagging-tests-script-sub-path != '' && success()
        id: pre-tagging-tests
        uses: ./.github/buildon-github-actions/src/actions/hook-pre-tagging-tests
        with:
          script-sub-path: ${{ inputs.hook-pre-tagging-tests-script-sub-path }}
          # === Workflow Inputs ===
          # Build output
          output-sub-path: ${{ inputs.output-sub-path }}

          # Docker registry logins
          docker-registry-logins: ${{ inputs.docker-registry-logins }}
          # Docker build options
          dockerfile-sub-path: ${{ inputs.dockerfile-sub-path }}
          dockerfile-squash: ${{ inputs.dockerfile-squash }}
          dockerfile-no-cache: ${{ inputs.dockerfile-no-cache }}
          # Docker target config
          docker-target-registry: ${{ inputs.docker-target-registry }}
          docker-target-base-path: ${{ inputs.docker-target-base-path }}
          # Docker push targets
          docker-push-targets: ${{ inputs.docker-push-targets }}

          # Manifests source
          manifests-sub-path: ${{ inputs.manifests-sub-path }}
          # Manifests packaging
          manifests-repo-provider-type: ${{ inputs.manifests-repo-provider-type }}
          manifests-packaging-base-image: ${{ inputs.manifests-packaging-base-image }}

          # Kubernetes Generation
          kubernetes-global-additional-labels: ${{ inputs.kubernetes-global-additional-labels }}
          kubernetes-global-additional-annotations: ${{ inputs.kubernetes-global-additional-annotations }}
          # Kubernetes ConfigMap Generation
          kubernetes-configmap-sub-path: ${{ inputs.kubernetes-configmap-sub-path }}
          kubernetes-configmap-name-checksum-injection: ${{ inputs.kubernetes-configmap-name-checksum-injection }}
          kubernetes-configmap-additional-labels: ${{ inputs.kubernetes-configmap-additional-labels }}
          kubernetes-configmap-additional-annotations: ${{ inputs.kubernetes-configmap-additional-annotations }}
          # Kubernetes Secret template generation
          kubernetes-secret-template-sub-path: ${{ inputs.kubernetes-secret-template-sub-path }}
          kubernetes-secret-template-name-checksum-injection: ${{ inputs.kubernetes-secret-template-name-checksum-injection }}
          kubernetes-secret-template-additional-labels: ${{ inputs.kubernetes-secret-template-additional-labels }}
          kubernetes-secret-template-additional-annotations: ${{ inputs.kubernetes-secret-template-additional-annotations }}

          # Token substitution
          token-delimiter-style: ${{ inputs.token-delimiter-style }}
          token-name-style: ${{ inputs.token-name-style }}
          token-name-validation: ${{ inputs.token-name-validation }}
          allow-builtin-token-override: ${{ inputs.allow-builtin-token-override }}
          config-sub-path: ${{ inputs.config-sub-path }}
          config-value-trailing-newline: ${{ inputs.config-value-trailing-newline }}

          # Naming, Versions, and Tags calculation
          release-branch: ${{ inputs.release-branch }}
          additional-release-branches: ${{ inputs.additional-release-branches }}
          tag-version-max-parts: ${{ inputs.tag-version-max-parts }}
          tag-version-calculation-strategy: ${{ inputs.tag-version-calculation-strategy }}
          tag-version-pattern-type: ${{ inputs.tag-version-pattern-type }}
          tag-version-prefix-parts: ${{ inputs.tag-version-prefix-parts }}
          tag-version-source-sub-path: ${{ inputs.tag-version-source-sub-path }}
          tag-version-source-file-name: ${{ inputs.tag-version-source-file-name }}
          tag-version-source-custom-pattern: ${{ inputs.tag-version-source-custom-pattern }}

          # Quality check options
          block-slashes: ${{ inputs.block-slashes }}
          qc-block-slash-containing-branches: ${{ inputs.qc-block-slash-containing-branches }}
          qc-block-double-hyphen-containing-branches: ${{ inputs.qc-block-double-hyphen-containing-branches }}
          qc-require-conventional-branches: ${{ inputs.qc-require-conventional-branches }}
          qc-require-conventional-commits: ${{ inputs.qc-require-conventional-commits }}
          qc-block-conventional-commits: ${{ inputs.qc-block-conventional-commits }}

          # Hook script paths
          hook-pre-tagging-tests-script-sub-path: ${{ inputs.hook-pre-tagging-tests-script-sub-path }}
          hook-pre-docker-prepare-script-sub-path: ${{ inputs.hook-pre-docker-prepare-script-sub-path }}
          hook-post-docker-tests-script-sub-path: ${{ inputs.hook-post-docker-tests-script-sub-path }}
          hook-pre-package-prepare-script-sub-path: ${{ inputs.hook-pre-package-prepare-script-sub-path }}
          hook-post-package-tests-script-sub-path: ${{ inputs.hook-post-package-tests-script-sub-path }}

          # GitHub release
          github-release-enabled: ${{ inputs.github-release-enabled }}
          github-release-substituted-files: ${{ inputs.github-release-substituted-files }}
          github-release-verbatim-files: ${{ inputs.github-release-verbatim-files }}
          github-release-notes: ${{ inputs.github-release-notes }}
          github-release-add-version-to-filenames: ${{ inputs.github-release-add-version-to-filenames }}
      - name: Pass check - Pre-tagging Tests
        if: inputs.hook-pre-tagging-tests-script-sub-path != '' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-pre-tagging.outputs.check-run-id }}
      - name: Fail check - Pre-tagging Tests
        if: inputs.hook-pre-tagging-tests-script-sub-path != '' && failure() && steps.check-pre-tagging.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-pre-tagging.outputs.check-run-id }}

      # === Versions & Naming ===
      - name: Start check - Versions & Naming
        id: check-versions
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Versions & Naming'
      - name: Generate versions and naming
        id: versions
        uses: ./.github/buildon-github-actions/src/actions/versions-and-naming
        with:
          release-branch: ${{ inputs.release-branch }}
          additional-release-branches: ${{ inputs.additional-release-branches }}
          tag-version-max-parts: ${{ inputs.tag-version-max-parts }}
          tag-version-calculation-strategy: ${{ inputs.tag-version-calculation-strategy }}
          tag-version-pattern-type: ${{ inputs.tag-version-pattern-type }}
          tag-version-prefix-parts: ${{ inputs.tag-version-prefix-parts }}
          dockerfile-sub-path: ${{ inputs.dockerfile-sub-path }}
          tag-version-source-sub-path: ${{ inputs.tag-version-source-sub-path }}
          tag-version-source-file-name: ${{ inputs.tag-version-source-file-name }}
          tag-version-source-custom-pattern: ${{ inputs.tag-version-source-custom-pattern }}
      - name: Pass check - Versions & Naming
        if: success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-versions.outputs.check-run-id }}
      - name: Fail check - Versions & Naming
        if: failure() && steps.check-versions.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-versions.outputs.check-run-id }}

      # === Docker Retag ===
      - name: Start check - Docker Retag
        id: check-docker-retag
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Docker Retag'
      - name: Pull and retag
        id: docker-build
        uses: ./.github/buildon-github-actions/src/actions/docker-build-retag
        with:
          docker-source-registry: ${{ inputs.docker-source-registry }}
          docker-source-base-path: ${{ inputs.docker-source-base-path }}
          docker-source-image-name: ${{ inputs.docker-source-image-name }}
          docker-source-tag: ${{ inputs.docker-source-tag }}
          docker-target-registry: ${{ inputs.docker-target-registry }}
          docker-target-base-path: ${{ inputs.docker-target-base-path }}
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}
      - name: Pass check - Docker Retag
        if: success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-docker-retag.outputs.check-run-id }}
      - name: Fail check - Docker Retag
        if: failure() && steps.check-docker-retag.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-docker-retag.outputs.check-run-id }}

      # === Docker Multi-Tag ===
      - name: Start check - Docker Multi-Tag
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && success()
        id: check-docker-multi-tag
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Docker Multi-Tag'
      - name: Tag images for additional registries
        id: docker-multi-tag
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/docker-multi-tag
        with:
          docker-image-full-uri: ${{ steps.docker-build.outputs.docker-target-image-full-uri }}
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}
          docker-push-targets: ${{ inputs.docker-push-targets }}
      - name: Pass check - Docker Multi-Tag
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-docker-multi-tag.outputs.check-run-id }}
      - name: Fail check - Docker Multi-Tag
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && failure() && steps.check-docker-multi-tag.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-docker-multi-tag.outputs.check-run-id }}

      # === Generate ConfigMap ===
      - name: Start check - Generate ConfigMap
        if: inputs.kubernetes-configmap-sub-path != '' && success()
        id: check-generate-configmap
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Generate ConfigMap'
      - name: Generate ConfigMap manifest
        id: generate-configmap
        if: inputs.kubernetes-configmap-sub-path != '' && success()
        uses: ./.github/buildon-github-actions/src/actions/generate-kubernetes-configmap
        with:
          kubernetes-configmap-sub-path: ${{ inputs.kubernetes-configmap-sub-path }}
          output-sub-path: ${{ inputs.output-sub-path }}
          token-name-style: ${{ inputs.token-name-style }}
          token-delimiter-style: ${{ inputs.token-delimiter-style }}
          kubernetes-configmap-name-checksum-injection: ${{ inputs.kubernetes-configmap-name-checksum-injection }}
          kubernetes-global-additional-labels: ${{ inputs.kubernetes-global-additional-labels }}
          kubernetes-global-additional-annotations: ${{ inputs.kubernetes-global-additional-annotations }}
          kubernetes-configmap-additional-labels: ${{ inputs.kubernetes-configmap-additional-labels }}
          kubernetes-configmap-additional-annotations: ${{ inputs.kubernetes-configmap-additional-annotations }}
      - name: Pass check - Generate ConfigMap
        if: inputs.kubernetes-configmap-sub-path != '' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-generate-configmap.outputs.check-run-id }}
      - name: Fail check - Generate ConfigMap
        if: inputs.kubernetes-configmap-sub-path != '' && failure() && steps.check-generate-configmap.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-generate-configmap.outputs.check-run-id }}

      # === Generate Secret Template ===
      - name: Start check - Generate Secret Template
        if: inputs.kubernetes-secret-template-sub-path != '' && success()
        id: check-generate-secret-template
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Generate Secret Template'
      - name: Generate Secret template manifest
        id: generate-secret-template
        if: inputs.kubernetes-secret-template-sub-path != '' && success()
        uses: ./.github/buildon-github-actions/src/actions/generate-kubernetes-secret-template
        with:
          kubernetes-secret-template-sub-path: ${{ inputs.kubernetes-secret-template-sub-path }}
          output-sub-path: ${{ inputs.output-sub-path }}
          token-name-style: ${{ inputs.token-name-style }}
          token-delimiter-style: ${{ inputs.token-delimiter-style }}
          kubernetes-secret-template-name-checksum-injection: ${{ inputs.kubernetes-secret-template-name-checksum-injection }}
          kubernetes-global-additional-labels: ${{ inputs.kubernetes-global-additional-labels }}
          kubernetes-global-additional-annotations: ${{ inputs.kubernetes-global-additional-annotations }}
          kubernetes-secret-template-additional-labels: ${{ inputs.kubernetes-secret-template-additional-labels }}
          kubernetes-secret-template-additional-annotations: ${{ inputs.kubernetes-secret-template-additional-annotations }}
      - name: Pass check - Generate Secret Template
        if: inputs.kubernetes-secret-template-sub-path != '' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-generate-secret-template.outputs.check-run-id }}
      - name: Fail check - Generate Secret Template
        if: inputs.kubernetes-secret-template-sub-path != '' && failure() && steps.check-generate-secret-template.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-generate-secret-template.outputs.check-run-id }}

      # === Pre-package Prepare ===
      - name: Start check - Pre-package Prepare
        if: inputs.hook-pre-package-prepare-script-sub-path != '' && success()
        id: check-pre-package-prepare
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Pre-package Prepare'
      - name: Run pre-package prepare
        if: inputs.hook-pre-package-prepare-script-sub-path != '' && success()
        id: pre-package-prepare
        uses: ./.github/buildon-github-actions/src/actions/hook-pre-package-prepare
        with:
          script-sub-path: ${{ inputs.hook-pre-package-prepare-script-sub-path }}
          # === Workflow Inputs ===
          # Build output
          output-sub-path: ${{ inputs.output-sub-path }}

          # Docker registry logins
          docker-registry-logins: ${{ inputs.docker-registry-logins }}
          # Docker build options
          dockerfile-sub-path: ${{ inputs.dockerfile-sub-path }}
          dockerfile-squash: ${{ inputs.dockerfile-squash }}
          dockerfile-no-cache: ${{ inputs.dockerfile-no-cache }}
          # Docker target config
          docker-target-registry: ${{ inputs.docker-target-registry }}
          docker-target-base-path: ${{ inputs.docker-target-base-path }}
          # Docker push targets
          docker-push-targets: ${{ inputs.docker-push-targets }}

          # Manifests source
          manifests-sub-path: ${{ inputs.manifests-sub-path }}
          # Manifests packaging
          manifests-repo-provider-type: ${{ inputs.manifests-repo-provider-type }}
          manifests-packaging-base-image: ${{ inputs.manifests-packaging-base-image }}

          # Kubernetes Generation
          kubernetes-global-additional-labels: ${{ inputs.kubernetes-global-additional-labels }}
          kubernetes-global-additional-annotations: ${{ inputs.kubernetes-global-additional-annotations }}
          # Kubernetes ConfigMap Generation
          kubernetes-configmap-sub-path: ${{ inputs.kubernetes-configmap-sub-path }}
          kubernetes-configmap-name-checksum-injection: ${{ inputs.kubernetes-configmap-name-checksum-injection }}
          kubernetes-configmap-additional-labels: ${{ inputs.kubernetes-configmap-additional-labels }}
          kubernetes-configmap-additional-annotations: ${{ inputs.kubernetes-configmap-additional-annotations }}
          # Kubernetes Secret template generation
          kubernetes-secret-template-sub-path: ${{ inputs.kubernetes-secret-template-sub-path }}
          kubernetes-secret-template-name-checksum-injection: ${{ inputs.kubernetes-secret-template-name-checksum-injection }}
          kubernetes-secret-template-additional-labels: ${{ inputs.kubernetes-secret-template-additional-labels }}
          kubernetes-secret-template-additional-annotations: ${{ inputs.kubernetes-secret-template-additional-annotations }}

          # Token substitution
          token-delimiter-style: ${{ inputs.token-delimiter-style }}
          token-name-style: ${{ inputs.token-name-style }}
          token-name-validation: ${{ inputs.token-name-validation }}
          allow-builtin-token-override: ${{ inputs.allow-builtin-token-override }}
          config-sub-path: ${{ inputs.config-sub-path }}
          config-value-trailing-newline: ${{ inputs.config-value-trailing-newline }}

          # Naming, Versions, and Tags calculation
          release-branch: ${{ inputs.release-branch }}
          additional-release-branches: ${{ inputs.additional-release-branches }}
          tag-version-max-parts: ${{ inputs.tag-version-max-parts }}
          tag-version-calculation-strategy: ${{ inputs.tag-version-calculation-strategy }}
          tag-version-pattern-type: ${{ inputs.tag-version-pattern-type }}
          tag-version-prefix-parts: ${{ inputs.tag-version-prefix-parts }}
          tag-version-source-sub-path: ${{ inputs.tag-version-source-sub-path }}
          tag-version-source-file-name: ${{ inputs.tag-version-source-file-name }}
          tag-version-source-custom-pattern: ${{ inputs.tag-version-source-custom-pattern }}

          # Quality check options
          block-slashes: ${{ inputs.block-slashes }}
          qc-block-slash-containing-branches: ${{ inputs.qc-block-slash-containing-branches }}
          qc-block-double-hyphen-containing-branches: ${{ inputs.qc-block-double-hyphen-containing-branches }}
          qc-require-conventional-branches: ${{ inputs.qc-require-conventional-branches }}
          qc-require-conventional-commits: ${{ inputs.qc-require-conventional-commits }}
          qc-block-conventional-commits: ${{ inputs.qc-block-conventional-commits }}

          # Hook script paths
          hook-pre-tagging-tests-script-sub-path: ${{ inputs.hook-pre-tagging-tests-script-sub-path }}
          hook-pre-docker-prepare-script-sub-path: ${{ inputs.hook-pre-docker-prepare-script-sub-path }}
          hook-post-docker-tests-script-sub-path: ${{ inputs.hook-post-docker-tests-script-sub-path }}
          hook-pre-package-prepare-script-sub-path: ${{ inputs.hook-pre-package-prepare-script-sub-path }}
          hook-post-package-tests-script-sub-path: ${{ inputs.hook-post-package-tests-script-sub-path }}

          # GitHub release
          github-release-enabled: ${{ inputs.github-release-enabled }}
          github-release-substituted-files: ${{ inputs.github-release-substituted-files }}
          github-release-verbatim-files: ${{ inputs.github-release-verbatim-files }}
          github-release-notes: ${{ inputs.github-release-notes }}
          github-release-add-version-to-filenames: ${{ inputs.github-release-add-version-to-filenames }}

          # === Step Outputs ===
          # Version outputs (from versions-and-naming)
          version: ${{ steps.versions.outputs.version }}
          version-major: ${{ steps.versions.outputs.version-major }}
          version-minor: ${{ steps.versions.outputs.version-minor }}
          version-patch: ${{ steps.versions.outputs.version-patch }}
          version-2-part: ${{ steps.versions.outputs.version-2-part }}
          version-3-part: ${{ steps.versions.outputs.version-3-part }}
          version-4-part: ${{ steps.versions.outputs.version-4-part }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          git-tag: ${{ steps.versions.outputs.git-tag }}
          project-name: ${{ steps.versions.outputs.project-name }}
          is-release: ${{ steps.versions.outputs.is-release }}
          # Docker outputs (from docker-build - empty in manifests-only workflows)
          docker-substituted-sub-path: ${{ steps.docker-build.outputs.docker-substituted-sub-path }}
          target-image-full-uri: ${{ steps.docker-build.outputs.docker-target-image-full-uri }}
          # Manifest outputs (computed path for this position)
          manifests-substituted-sub-path: ${{ inputs.output-sub-path }}/manifests/substituted/${{ steps.versions.outputs.project-name }}
      - name: Pass check - Pre-package Prepare
        if: inputs.hook-pre-package-prepare-script-sub-path != '' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-pre-package-prepare.outputs.check-run-id }}
      - name: Fail check - Pre-package Prepare
        if: inputs.hook-pre-package-prepare-script-sub-path != '' && failure() && steps.check-pre-package-prepare.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-pre-package-prepare.outputs.check-run-id }}

      # === Manifest Package ===
      - name: Start check - Package Manifests
        id: check-manifest-package
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Package Manifests'
      - name: Package manifests
        id: manifest-package
        uses: ./.github/buildon-github-actions/src/actions/kubernetes-manifests-package
        with:
          manifests-sub-path: ${{ inputs.manifests-sub-path }}
          project-name: ${{ steps.versions.outputs.project-name }}
          version: ${{ steps.versions.outputs.version }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          docker-image-full-uri: ${{ steps.docker-build.outputs.docker-target-image-full-uri }}
          docker-target-registry: ${{ steps.docker-build.outputs.docker-target-registry }}
          docker-target-base-path: ${{ steps.docker-build.outputs.docker-target-base-path }}
          is-release: ${{ steps.versions.outputs.is-release }}
          token-delimiter-style: ${{ inputs.token-delimiter-style }}
          token-name-style: ${{ inputs.token-name-style }}
          token-name-validation: ${{ inputs.token-name-validation }}
          allow-builtin-token-override: ${{ inputs.allow-builtin-token-override }}
          config-sub-path: ${{ inputs.config-sub-path }}
          config-value-trailing-newline: ${{ inputs.config-value-trailing-newline }}
          output-sub-path: ${{ inputs.output-sub-path }}
      - name: Pass check - Package Manifests
        if: success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-manifest-package.outputs.check-run-id }}
      - name: Fail check - Package Manifests
        if: failure() && steps.check-manifest-package.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-manifest-package.outputs.check-run-id }}

      # === Manifest Repo Provider Package ===
      - name: Start check - Package Manifests for Repo Provider
        id: check-manifest-repo-provider-package
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Package Manifests for Repo Provider'
      - name: Package manifests for repo provider
        id: manifest-repo-provider-package
        uses: ./.github/buildon-github-actions/src/actions/kubernetes-manifests-repo-provider-package
        with:
          manifests-repo-provider-type: ${{ inputs.manifests-repo-provider-type }}
          manifests-packaging-base-image: ${{ inputs.manifests-packaging-base-image }}
          manifests-zip-sub-path: ${{ steps.manifest-package.outputs.manifests-zip-sub-path }}
          manifests-zip-file-name: ${{ steps.manifest-package.outputs.manifests-zip-file-name }}
          docker-target-registry: ${{ steps.docker-build.outputs.docker-target-registry }}
          docker-target-base-path: ${{ steps.docker-build.outputs.docker-target-base-path }}
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}-manifests
          version: ${{ steps.versions.outputs.version }}
          output-sub-path: ${{ inputs.output-sub-path }}
      - name: Pass check - Package Manifests for Repo Provider
        if: success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-manifest-repo-provider-package.outputs.check-run-id }}
      - name: Fail check - Package Manifests for Repo Provider
        if: failure() && steps.check-manifest-repo-provider-package.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-manifest-repo-provider-package.outputs.check-run-id }}

      # === Manifest Multi-Tag ===
      - name: Start check - Manifest Multi-Tag
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && inputs.manifests-repo-provider-type == 'docker' && success()
        id: check-manifest-multi-tag
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Manifest Multi-Tag'
      - name: Tag manifest images for additional registries
        id: manifest-multi-tag
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && inputs.manifests-repo-provider-type == 'docker' && success()
        uses: ./.github/buildon-github-actions/src/actions/docker-multi-tag
        with:
          docker-image-full-uri: ${{ steps.manifest-repo-provider-package.outputs.manifests-uri }}
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}-manifests
          docker-push-targets: ${{ inputs.docker-push-targets }}
      - name: Pass check - Manifest Multi-Tag
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && inputs.manifests-repo-provider-type == 'docker' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-manifest-multi-tag.outputs.check-run-id }}
      - name: Fail check - Manifest Multi-Tag
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && inputs.manifests-repo-provider-type == 'docker' && failure() && steps.check-manifest-multi-tag.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-manifest-multi-tag.outputs.check-run-id }}

      # === Post-package Tests ===
      - name: Start check - Post-package Tests
        if: inputs.hook-post-package-tests-script-sub-path != '' && success()
        id: check-post-package
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Post-package Tests'
      - name: Run post-package tests
        if: inputs.hook-post-package-tests-script-sub-path != '' && success()
        id: post-package-tests
        uses: ./.github/buildon-github-actions/src/actions/hook-post-package-tests
        with:
          script-sub-path: ${{ inputs.hook-post-package-tests-script-sub-path }}
          # === Workflow Inputs ===
          # Build output
          output-sub-path: ${{ inputs.output-sub-path }}

          # Docker registry logins
          docker-registry-logins: ${{ inputs.docker-registry-logins }}
          # Docker build options
          dockerfile-sub-path: ${{ inputs.dockerfile-sub-path }}
          dockerfile-squash: ${{ inputs.dockerfile-squash }}
          dockerfile-no-cache: ${{ inputs.dockerfile-no-cache }}
          # Docker target config
          docker-target-registry: ${{ inputs.docker-target-registry }}
          docker-target-base-path: ${{ inputs.docker-target-base-path }}
          # Docker push targets
          docker-push-targets: ${{ inputs.docker-push-targets }}

          # Manifests source
          manifests-sub-path: ${{ inputs.manifests-sub-path }}
          # Manifests packaging
          manifests-repo-provider-type: ${{ inputs.manifests-repo-provider-type }}
          manifests-packaging-base-image: ${{ inputs.manifests-packaging-base-image }}

          # Kubernetes Generation
          kubernetes-global-additional-labels: ${{ inputs.kubernetes-global-additional-labels }}
          kubernetes-global-additional-annotations: ${{ inputs.kubernetes-global-additional-annotations }}
          # Kubernetes ConfigMap Generation
          kubernetes-configmap-sub-path: ${{ inputs.kubernetes-configmap-sub-path }}
          kubernetes-configmap-name-checksum-injection: ${{ inputs.kubernetes-configmap-name-checksum-injection }}
          kubernetes-configmap-additional-labels: ${{ inputs.kubernetes-configmap-additional-labels }}
          kubernetes-configmap-additional-annotations: ${{ inputs.kubernetes-configmap-additional-annotations }}
          # Kubernetes Secret template generation
          kubernetes-secret-template-sub-path: ${{ inputs.kubernetes-secret-template-sub-path }}
          kubernetes-secret-template-name-checksum-injection: ${{ inputs.kubernetes-secret-template-name-checksum-injection }}
          kubernetes-secret-template-additional-labels: ${{ inputs.kubernetes-secret-template-additional-labels }}
          kubernetes-secret-template-additional-annotations: ${{ inputs.kubernetes-secret-template-additional-annotations }}

          # Token substitution
          token-delimiter-style: ${{ inputs.token-delimiter-style }}
          token-name-style: ${{ inputs.token-name-style }}
          token-name-validation: ${{ inputs.token-name-validation }}
          allow-builtin-token-override: ${{ inputs.allow-builtin-token-override }}
          config-sub-path: ${{ inputs.config-sub-path }}
          config-value-trailing-newline: ${{ inputs.config-value-trailing-newline }}

          # Naming, Versions, and Tags calculation
          release-branch: ${{ inputs.release-branch }}
          additional-release-branches: ${{ inputs.additional-release-branches }}
          tag-version-max-parts: ${{ inputs.tag-version-max-parts }}
          tag-version-calculation-strategy: ${{ inputs.tag-version-calculation-strategy }}
          tag-version-pattern-type: ${{ inputs.tag-version-pattern-type }}
          tag-version-prefix-parts: ${{ inputs.tag-version-prefix-parts }}
          tag-version-source-sub-path: ${{ inputs.tag-version-source-sub-path }}
          tag-version-source-file-name: ${{ inputs.tag-version-source-file-name }}
          tag-version-source-custom-pattern: ${{ inputs.tag-version-source-custom-pattern }}

          # Quality check options
          block-slashes: ${{ inputs.block-slashes }}
          qc-block-slash-containing-branches: ${{ inputs.qc-block-slash-containing-branches }}
          qc-block-double-hyphen-containing-branches: ${{ inputs.qc-block-double-hyphen-containing-branches }}
          qc-require-conventional-branches: ${{ inputs.qc-require-conventional-branches }}
          qc-require-conventional-commits: ${{ inputs.qc-require-conventional-commits }}
          qc-block-conventional-commits: ${{ inputs.qc-block-conventional-commits }}

          # Hook script paths
          hook-pre-tagging-tests-script-sub-path: ${{ inputs.hook-pre-tagging-tests-script-sub-path }}
          hook-pre-docker-prepare-script-sub-path: ${{ inputs.hook-pre-docker-prepare-script-sub-path }}
          hook-post-docker-tests-script-sub-path: ${{ inputs.hook-post-docker-tests-script-sub-path }}
          hook-pre-package-prepare-script-sub-path: ${{ inputs.hook-pre-package-prepare-script-sub-path }}
          hook-post-package-tests-script-sub-path: ${{ inputs.hook-post-package-tests-script-sub-path }}

          # GitHub release
          github-release-enabled: ${{ inputs.github-release-enabled }}
          github-release-substituted-files: ${{ inputs.github-release-substituted-files }}
          github-release-verbatim-files: ${{ inputs.github-release-verbatim-files }}
          github-release-notes: ${{ inputs.github-release-notes }}
          github-release-add-version-to-filenames: ${{ inputs.github-release-add-version-to-filenames }}

          # === Step Outputs ===
          # Version outputs (from versions-and-naming)
          version: ${{ steps.versions.outputs.version }}
          version-major: ${{ steps.versions.outputs.version-major }}
          version-minor: ${{ steps.versions.outputs.version-minor }}
          version-patch: ${{ steps.versions.outputs.version-patch }}
          version-2-part: ${{ steps.versions.outputs.version-2-part }}
          version-3-part: ${{ steps.versions.outputs.version-3-part }}
          version-4-part: ${{ steps.versions.outputs.version-4-part }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          git-tag: ${{ steps.versions.outputs.git-tag }}
          project-name: ${{ steps.versions.outputs.project-name }}
          is-release: ${{ steps.versions.outputs.is-release }}
          # Docker outputs (from docker-build - empty in manifests-only workflows)
          docker-substituted-sub-path: ${{ steps.docker-build.outputs.docker-substituted-sub-path }}
          target-image-full-uri: ${{ steps.docker-build.outputs.docker-target-image-full-uri }}
          # Manifest outputs (from manifest-package)
          manifests-substituted-sub-path: ${{ inputs.output-sub-path }}/manifests/substituted/${{ steps.versions.outputs.project-name }}
          manifests-zip-sub-path: ${{ steps.manifest-package.outputs.manifests-zip-sub-path }}
          manifests-zip-file-name: ${{ steps.manifest-package.outputs.manifests-zip-file-name }}
          # Manifest repo provider outputs (from manifest-repo-provider-package)
          manifests-uri: ${{ steps.manifest-repo-provider-package.outputs.manifests-uri }}
      - name: Pass check - Post-package Tests
        if: inputs.hook-post-package-tests-script-sub-path != '' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-post-package.outputs.check-run-id }}
      - name: Fail check - Post-package Tests
        if: inputs.hook-post-package-tests-script-sub-path != '' && failure() && steps.check-post-package.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-post-package.outputs.check-run-id }}

      # === GitHub Release Prepare ===
      - name: Start check - GitHub Release Prepare
        if: inputs.github-release-enabled == true && success()
        id: check-github-release-prepare
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → GitHub Release Prepare'
      # Copy manifests zip directly (already has version in filename, binary file)
      - name: Copy manifests zip to release directory
        if: inputs.github-release-enabled == true && success()
        shell: bash
        run: |
          mkdir -p "${{ inputs.output-sub-path }}/github-release"
          cp "${{ steps.manifest-package.outputs.manifests-zip-sub-path }}/${{ steps.manifest-package.outputs.manifests-zip-file-name }}" \
             "${{ inputs.output-sub-path }}/github-release/"

      - name: Prepare release files
        id: github-release-prepare
        if: inputs.github-release-enabled == true && success()
        uses: ./.github/buildon-github-actions/src/actions/github-release-prepare
        with:
          github-release-substituted-files: ${{ inputs.github-release-substituted-files }}
          github-release-verbatim-files: ${{ inputs.github-release-verbatim-files }}
          output-sub-path: ${{ inputs.output-sub-path }}
          version: ${{ steps.versions.outputs.version }}
          project-name: ${{ steps.versions.outputs.project-name }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          is-release: ${{ steps.versions.outputs.is-release }}
          github-release-add-version-to-filenames: ${{ inputs.github-release-add-version-to-filenames }}
          token-delimiter-style: ${{ inputs.token-delimiter-style }}
          token-name-style: ${{ inputs.token-name-style }}
          token-name-validation: ${{ inputs.token-name-validation }}
          config-sub-path: ${{ inputs.config-sub-path }}
          allow-builtin-token-override: ${{ inputs.allow-builtin-token-override }}
          config-value-trailing-newline: ${{ inputs.config-value-trailing-newline }}
          docker-image-full-uri: ${{ steps.docker-build.outputs.docker-target-image-full-uri }}
          target-registry: ${{ inputs.docker-target-registry }}
          target-base-path: ${{ inputs.docker-target-base-path }}
          manifests-zip-file-name: ${{ steps.manifest-package.outputs.manifests-zip-file-name }}
      - name: Pass check - GitHub Release Prepare
        if: inputs.github-release-enabled == true && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-github-release-prepare.outputs.check-run-id }}
      - name: Fail check - GitHub Release Prepare
        if: inputs.github-release-enabled == true && failure() && steps.check-github-release-prepare.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-github-release-prepare.outputs.check-run-id }}

      # === Git Tag Push ===
      - name: Start check - Git Tag Push
        if: steps.versions.outputs.is-release == 'true' && success()
        id: check-git-push-tag
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Git Tag Push'
      - name: Push git tag
        if: steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/git-push-tag
        with:
          git-tag: ${{ steps.versions.outputs.git-tag }}
          is-release: ${{ steps.versions.outputs.is-release }}
      - name: Pass check - Git Tag Push
        if: steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-git-push-tag.outputs.check-run-id }}
      - name: Fail check - Git Tag Push
        if: steps.versions.outputs.is-release == 'true' && failure() && steps.check-git-push-tag.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-git-push-tag.outputs.check-run-id }}

      # === Docker Push ===
      - name: Start check - Docker Push
        if: steps.versions.outputs.is-release == 'true' && success()
        id: check-docker-push
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Docker Push'
      - name: Push image
        id: docker-push
        if: steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/docker-push
        with:
          docker-image-full-uri: ${{ steps.docker-build.outputs.docker-target-image-full-uri }}
          is-release: ${{ steps.versions.outputs.is-release }}
      - name: Pass check - Docker Push
        if: steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-docker-push.outputs.check-run-id }}
      - name: Fail check - Docker Push
        if: steps.versions.outputs.is-release == 'true' && failure() && steps.check-docker-push.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-docker-push.outputs.check-run-id }}

      # === Docker Multi-Push ===
      - name: Start check - Docker Multi-Push
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && success()
        id: check-docker-multi-push
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Docker Multi-Push'
      - name: Push images to additional registries
        id: docker-multi-push
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/docker-multi-push
        with:
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}
          docker-push-targets: ${{ inputs.docker-push-targets }}
          is-release: ${{ steps.versions.outputs.is-release }}
      - name: Pass check - Docker Multi-Push
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-docker-multi-push.outputs.check-run-id }}
      - name: Fail check - Docker Multi-Push
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && failure() && steps.check-docker-multi-push.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-docker-multi-push.outputs.check-run-id }}

      # === Manifest Repo Provider Publish ===
      - name: Start check - Publish Manifests via Repo Provider
        if: steps.versions.outputs.is-release == 'true' && success()
        id: check-manifest-repo-provider-publish
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Publish Manifests via Repo Provider'
      - name: Publish manifests via repo provider
        id: manifest-repo-provider-publish
        if: steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/kubernetes-manifests-repo-provider-publish
        with:
          manifests-repo-provider-type: ${{ inputs.manifests-repo-provider-type }}
          manifests-uri: ${{ steps.manifest-repo-provider-package.outputs.manifests-uri }}
          manifests-zip-sub-path: ${{ steps.manifest-repo-provider-package.outputs.manifests-zip-sub-path }}
          manifests-zip-file-name: ${{ steps.manifest-repo-provider-package.outputs.manifests-zip-file-name }}
          version: ${{ steps.manifest-repo-provider-package.outputs.version }}
          is-release: ${{ steps.versions.outputs.is-release }}
          repo-provider-url: ${{ steps.manifest-repo-provider-package.outputs.repo-provider-url }}
          repo-provider-namespace: ${{ steps.manifest-repo-provider-package.outputs.repo-provider-namespace }}
          repo-provider-name: ${{ steps.manifest-repo-provider-package.outputs.repo-provider-name }}
          repo-provider-version: ${{ steps.manifest-repo-provider-package.outputs.repo-provider-version }}
      - name: Pass check - Publish Manifests via Repo Provider
        if: steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-manifest-repo-provider-publish.outputs.check-run-id }}
      - name: Fail check - Publish Manifests via Repo Provider
        if: steps.versions.outputs.is-release == 'true' && failure() && steps.check-manifest-repo-provider-publish.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-manifest-repo-provider-publish.outputs.check-run-id }}

      # === Manifest Multi-Push ===
      - name: Start check - Manifest Multi-Push
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && inputs.manifests-repo-provider-type == 'docker' && success()
        id: check-manifest-multi-push
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → Manifest Multi-Push'
      - name: Push manifest images to additional registries
        id: manifest-multi-push
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && inputs.manifests-repo-provider-type == 'docker' && success()
        uses: ./.github/buildon-github-actions/src/actions/docker-multi-push
        with:
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}-manifests
          docker-push-targets: ${{ inputs.docker-push-targets }}
          is-release: ${{ steps.versions.outputs.is-release }}
      - name: Pass check - Manifest Multi-Push
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && inputs.manifests-repo-provider-type == 'docker' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-manifest-multi-push.outputs.check-run-id }}
      - name: Fail check - Manifest Multi-Push
        if: inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true' && inputs.manifests-repo-provider-type == 'docker' && failure() && steps.check-manifest-multi-push.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-manifest-multi-push.outputs.check-run-id }}

      # === GitHub Release ===
      - name: Start check - GitHub Release
        if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true' && success()
        id: check-github-release
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: start
          check-name: 'Build & Publish → GitHub Release'
      - name: Compute release notes
        id: release-notes
        if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true' && success()
        shell: bash
        env:
          USER_NOTES: ${{ inputs.github-release-notes }}
          VERSION: ${{ steps.versions.outputs.version }}
          PROJECT_NAME: ${{ steps.versions.outputs.project-name }}
          DOCKER_URI: ${{ steps.docker-build.outputs.docker-target-image-full-uri }}
          MANIFESTS_URI: ${{ steps.manifest-repo-provider-publish.outputs.manifests-uri }}
          MANIFESTS_ZIP_FILE_NAME: ${{ steps.manifest-package.outputs.manifests-zip-file-name }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          display_name=$(./.github/buildon-github-actions/src/scripts/util/format-project-title "${PROJECT_NAME}")
          echo "title=${VERSION} — ${display_name}" >> "${GITHUB_OUTPUT}"

          if [[ -n "${USER_NOTES}" ]]; then
            # User provided notes override entirely
            {
              echo "notes<<NOTES_EOF"
              echo "${USER_NOTES}"
              echo "NOTES_EOF"
            } >> "${GITHUB_OUTPUT}"
          else
            # Default format
            release_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/download/${VERSION}"
            {
              echo "notes<<NOTES_EOF"
              echo "Automatic Kube App release for version ${VERSION} of ${PROJECT_NAME} by Kaptain build script. This release page has the manifest zip attached as well as the main docker image, and the manifests docker image with the same zip inside for automatic consumption."
              echo ""
              echo "### Release Assets"
              echo "* Kube Manifests: [${MANIFESTS_ZIP_FILE_NAME}](${release_url}/${MANIFESTS_ZIP_FILE_NAME})"
              echo "* Docker Image: [${DOCKER_URI}](https://${DOCKER_URI})"
              echo "* Manifests Image: [${MANIFESTS_URI}](https://${MANIFESTS_URI})"
              echo "NOTES_EOF"
            } >> "${GITHUB_OUTPUT}"
          fi

      - name: GitHub Release
        if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-release
        with:
          github-release-enabled: ${{ inputs.github-release-enabled }}
          output-sub-path: ${{ inputs.output-sub-path }}
          github-release-tag: ${{ steps.versions.outputs.version }}
          github-release-notes: ${{ steps.release-notes.outputs.notes }}
          github-release-title: ${{ steps.release-notes.outputs.title }}
      - name: Pass check - GitHub Release
        if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true' && success()
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: pass
          check-run-id: ${{ steps.check-github-release.outputs.check-run-id }}
      - name: Fail check - GitHub Release
        if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true' && failure() && steps.check-github-release.outputs.check-run-id != ''
        uses: ./.github/buildon-github-actions/src/actions/github-check-run
        with:
          action: fail
          check-run-id: ${{ steps.check-github-release.outputs.check-run-id }}
