# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
name: GitHub Release
description: Create GitHub release with assets from prepared directory

inputs:
  # INJECT-INPUT: output-sub-path
  # INJECT-INPUT: github-release

  # Action-specific inputs
  github-release-tag:
    description: Release tag
    required: false
    default: ${{ github.ref_name }}
  github-release-title:
    description: Release title
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Create release
      if: inputs.github-release-enabled == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        OUTPUT_SUB_PATH: ${{ inputs.output-sub-path }}
        TAG: ${{ inputs.github-release-tag }}
        NOTES: ${{ inputs.github-release-notes }}
        NOTES_FILE: ${{ inputs.github-release-notes-file }}
        TITLE: ${{ inputs.github-release-title }}
      run: |
        RELEASE_DIR="${OUTPUT_SUB_PATH}/github-release"

        # Collect files from prepared directory
        FILES=""
        if [[ -d "${RELEASE_DIR}" ]]; then
          for f in "${RELEASE_DIR}"/*; do
            if [[ -f "$f" ]]; then
              FILES="${FILES} ${f}"
            fi
          done
        fi

        # Fail if both notes and notes-file are set - pick one
        if [[ -n "${NOTES_FILE}" ]] && [[ -n "${NOTES}" ]]; then
          echo "::error::Both github-release-notes and github-release-notes-file are set. Use one or the other, not both."
          exit 1
        fi

        if [[ -n "${NOTES_FILE}" ]]; then
          RESOLVED_NOTES_FILE="${OUTPUT_SUB_PATH}/${NOTES_FILE}"
          if [[ ! -f "${RESOLVED_NOTES_FILE}" ]]; then
            echo "::error::Release notes file not found: ${RESOLVED_NOTES_FILE}"
            exit 1
          fi
          # shellcheck disable=SC2086 # Intentional word splitting for FILES
          gh release create "${TAG}" ${FILES} --title "${TITLE}" --notes-file "${RESOLVED_NOTES_FILE}"
        elif [[ -n "${NOTES}" ]]; then
          # shellcheck disable=SC2086 # Intentional word splitting for FILES
          gh release create "${TAG}" ${FILES} --title "${TITLE}" --notes "${NOTES}"
        else
          # shellcheck disable=SC2086 # Intentional word splitting for FILES
          gh release create "${TAG}" ${FILES} --title "${TITLE}" --generate-notes
        fi
