# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)

name: 'Docker Build Dockerfile'
description: 'Builds a Docker image from a Dockerfile with token substitution (build only, push handled by docker-push-all)'

inputs:
  # INJECT-INPUT: output-sub-path
  # INJECT-INPUT: docker-push-image-list
  # INJECT-INPUT: docker-dockerfile
  # INJECT-INPUT: token-substitution

  # Action-specific inputs (passed from workflow/version generator)
  docker-target-registry:
    description: 'Target container registry (pre-resolved by workflow)'
    required: true
  docker-target-namespace:
    description: 'Namespace between registry and image name (pre-resolved by workflow)'
    required: true
  docker-image-name:
    description: 'Image name (from version generator docker-image-name)'
    required: true
  docker-tag:
    description: 'Tag for target image (from version generator docker-tag)'
    required: true
  version:
    description: 'Version number (from version generator, passed as build arg)'
    required: true
  project-name:
    description: 'Project name (from version generator, passed as build arg)'
    required: true
  is-release:
    description: 'Whether this is a release build (from version generator)'
    required: true
  # INJECT-INPUT: image-build-command

outputs:
  docker-target-image-full-uri:
    description: 'Full target image reference'
    value: ${{ steps.build.outputs.DOCKER_TARGET_IMAGE_FULL_URI }}
  docker-target-registry:
    description: 'Target registry (pass-through for downstream)'
    value: ${{ inputs.docker-target-registry }}
  docker-target-namespace:
    description: 'Target namespace (pass-through for downstream)'
    value: ${{ inputs.docker-target-namespace }}

runs:
  using: 'composite'
  steps:
    - name: Build image
      id: build
      shell: bash
      env:
        LOG_ERROR_PREFIX: '::error::'
        LOG_WARNING_PREFIX: '::warning::'
        DOCKER_TARGET_REGISTRY: ${{ inputs.docker-target-registry }}
        DOCKER_TARGET_NAMESPACE: ${{ inputs.docker-target-namespace }}
        DOCKER_IMAGE_NAME: ${{ inputs.docker-image-name }}
        DOCKER_TAG: ${{ inputs.docker-tag }}
        VERSION: ${{ inputs.version }}
        PROJECT_NAME: ${{ inputs.project-name }}
        IS_RELEASE: ${{ inputs.is-release }}
        DOCKERFILE_SUB_PATH: ${{ inputs.dockerfile-sub-path }}
        DOCKERFILE_SUBSTITUTION_FILES: ${{ inputs.dockerfile-substitution-files }}
        OUTPUT_SUB_PATH: ${{ inputs.output-sub-path }}
        DOCKER_PUSH_IMAGE_LIST_FILE: ${{ inputs.docker-push-image-list-file }}
        DOCKERFILE_SQUASH: ${{ inputs.dockerfile-squash }}
        IMAGE_BUILD_COMMAND: ${{ inputs.image-build-command }}
        BUILD_MODE: build_server
        DOCKERFILE_NO_CACHE: ${{ inputs.dockerfile-no-cache }}
        TOKEN_DELIMITER_STYLE: ${{ inputs.token-delimiter-style }}
        TOKEN_NAME_STYLE: ${{ inputs.token-name-style }}
        TOKEN_NAME_VALIDATION: ${{ inputs.token-name-validation }}
        CONFIG_SUB_PATH: ${{ inputs.config-sub-path }}
        ALLOW_BUILTIN_TOKEN_OVERRIDE: ${{ inputs.allow-builtin-token-override }}
        CONFIG_VALUE_TRAILING_NEWLINE: ${{ inputs.config-value-trailing-newline }}
      run: "${{ github.action_path }}/../../scripts/main/docker-build-dockerfile"
