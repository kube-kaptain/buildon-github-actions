# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)

name: Hook - Pre-Docker Prepare
description: Runs user's hook script before Docker build preparation to modify Dockerfile, copy files, or perform setup

inputs:
  # Hook script path
  script-sub-path:
    description: 'Path to script relative to .github/ (e.g., bin/pre-docker.bash)'
    required: true

  # === Workflow Inputs ===
  # INJECT-INPUT: output-sub-path
  # INJECT-INPUT: docker-build
  # INJECT-INPUT: docker-dockerfile
  # INJECT-INPUT: kubernetes-app-manifests
  # INJECT-INPUT: kubernetes-global
  # INJECT-INPUT: kubernetes-configmap
  # INJECT-INPUT: kubernetes-secret-template
  # INJECT-INPUT: kubernetes-serviceaccount
  # INJECT-INPUT: kubernetes-workload
  # INJECT-INPUT: kubernetes-workload-deployment
  # INJECT-INPUT: kubernetes-workload-statefulset
  # INJECT-INPUT: kubernetes-service
  # INJECT-INPUT: token-substitution
  # INJECT-INPUT: release-branches
  # INJECT-INPUT: tag-version
  # INJECT-INPUT: basic-quality-checks
  # INJECT-INPUT: hooks-pre-tagging
  # INJECT-INPUT: hooks-docker
  # INJECT-INPUT: hooks-package
  # INJECT-INPUT: github-release

  # === Step Outputs ===
  # Version outputs (from versions-and-naming)
  version:
    description: 'Version string'
    required: true
  version-major:
    description: 'Major version number'
    required: true
  version-minor:
    description: 'Minor version number'
    required: true
  version-patch:
    description: 'Patch version number'
    required: true
  version-2-part:
    description: 'Version padded/truncated to 2 parts'
    required: true
  version-3-part:
    description: 'Version padded/truncated to 3 parts'
    required: true
  version-4-part:
    description: 'Version padded/truncated to 4 parts'
    required: true
  docker-tag:
    description: 'Docker tag'
    required: true
  docker-image-name:
    description: 'Docker image name'
    required: true
  git-tag:
    description: 'Git tag'
    required: true
  project-name:
    description: 'Project name'
    required: true
  is-release:
    description: 'Whether this is a release build'
    required: true
  # Docker outputs (computed path for this position)
  docker-substituted-sub-path:
    description: 'Docker substituted files directory'
    required: true

runs:
  using: composite
  steps:
    - name: Run pre-docker prepare hook
      shell: bash
      env:
        HOOK_SCRIPT_SUB_PATH: .github/${{ inputs.script-sub-path }}
        # Workflow inputs - build output
        OUTPUT_SUB_PATH: ${{ inputs.output-sub-path }}

        # Workflow inputs - docker registry logins
        DOCKER_REGISTRY_LOGINS: ${{ inputs.docker-registry-logins }}
        # Workflow inputs - docker build options
        DOCKERFILE_SUB_PATH: ${{ inputs.dockerfile-sub-path }}
        DOCKERFILE_SQUASH: ${{ inputs.dockerfile-squash }}
        DOCKERFILE_NO_CACHE: ${{ inputs.dockerfile-no-cache }}
        # Workflow inputs - docker target config
        DOCKER_TARGET_REGISTRY: ${{ inputs.docker-target-registry }}
        DOCKER_TARGET_BASE_PATH: ${{ inputs.docker-target-base-path }}
        # Workflow inputs - docker push targets
        DOCKER_PUSH_TARGETS: ${{ inputs.docker-push-targets }}

        # Workflow inputs - manifests source
        MANIFESTS_SUB_PATH: ${{ inputs.manifests-sub-path }}
        # Workflow inputs - manifests packaging
        MANIFESTS_REPO_PROVIDER_TYPE: ${{ inputs.manifests-repo-provider-type }}
        MANIFESTS_PACKAGING_BASE_IMAGE: ${{ inputs.manifests-packaging-base-image }}

        # Workflow inputs - kubernetes generation
        KUBERNETES_GLOBAL_ADDITIONAL_LABELS: ${{ inputs.kubernetes-global-additional-labels }}
        KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS: ${{ inputs.kubernetes-global-additional-annotations }}
        # Workflow inputs - kubernetes configmap generation
        KUBERNETES_CONFIGMAP_SUB_PATH: ${{ inputs.kubernetes-configmap-sub-path }}
        KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION: ${{ inputs.kubernetes-configmap-name-checksum-injection }}
        KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS: ${{ inputs.kubernetes-configmap-additional-labels }}
        KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS: ${{ inputs.kubernetes-configmap-additional-annotations }}
        # Workflow inputs - kubernetes secret template generation
        KUBERNETES_SECRET_TEMPLATE_SUB_PATH: ${{ inputs.kubernetes-secret-template-sub-path }}
        KUBERNETES_SECRET_TEMPLATE_NAME_CHECKSUM_INJECTION: ${{ inputs.kubernetes-secret-template-name-checksum-injection }}
        KUBERNETES_SECRET_TEMPLATE_ADDITIONAL_LABELS: ${{ inputs.kubernetes-secret-template-additional-labels }}
        KUBERNETES_SECRET_TEMPLATE_ADDITIONAL_ANNOTATIONS: ${{ inputs.kubernetes-secret-template-additional-annotations }}
        # Workflow inputs - kubernetes serviceaccount generation
        KUBERNETES_SERVICEACCOUNT_GENERATION_ENABLED: ${{ inputs.kubernetes-serviceaccount-generation-enabled }}
        KUBERNETES_SERVICEACCOUNT_NAME_SUFFIX: ${{ inputs.kubernetes-serviceaccount-name-suffix }}
        KUBERNETES_SERVICEACCOUNT_COMBINED_SUB_PATH: ${{ inputs.kubernetes-serviceaccount-combined-sub-path }}
        KUBERNETES_SERVICEACCOUNT_ADDITIONAL_LABELS: ${{ inputs.kubernetes-serviceaccount-additional-labels }}
        KUBERNETES_SERVICEACCOUNT_ADDITIONAL_ANNOTATIONS: ${{ inputs.kubernetes-serviceaccount-additional-annotations }}
        # Workflow inputs - kubernetes workload generation
        KUBERNETES_WORKLOAD_TYPE: ${{ inputs.kubernetes-workload-type }}
        KUBERNETES_WORKLOAD_NAME_SUFFIX: ${{ inputs.kubernetes-workload-name-suffix }}
        KUBERNETES_WORKLOAD_COMBINED_SUB_PATH: ${{ inputs.kubernetes-workload-combined-sub-path }}
        KUBERNETES_WORKLOAD_ENV_SUB_PATH: ${{ inputs.kubernetes-workload-env-sub-path }}
        KUBERNETES_WORKLOAD_ADDITIONAL_LABELS: ${{ inputs.kubernetes-workload-additional-labels }}
        KUBERNETES_WORKLOAD_ADDITIONAL_ANNOTATIONS: ${{ inputs.kubernetes-workload-additional-annotations }}
        KUBERNETES_WORKLOAD_CONTAINER_PORT: ${{ inputs.kubernetes-workload-container-port }}
        KUBERNETES_WORKLOAD_IMAGE_REFERENCE_STYLE: ${{ inputs.kubernetes-workload-image-reference-style }}
        KUBERNETES_WORKLOAD_READONLY_ROOT_FILESYSTEM: ${{ inputs.kubernetes-workload-readonly-root-filesystem }}
        KUBERNETES_WORKLOAD_SECCOMP_PROFILE: ${{ inputs.kubernetes-workload-seccomp-profile }}
        KUBERNETES_WORKLOAD_AUTOMOUNT_SERVICE_ACCOUNT_TOKEN: ${{ inputs.kubernetes-workload-automount-service-account-token }}
        KUBERNETES_WORKLOAD_IMAGE_PULL_SECRETS: ${{ inputs.kubernetes-workload-image-pull-secrets }}
        KUBERNETES_WORKLOAD_RESOURCES_MEMORY: ${{ inputs.kubernetes-workload-resources-memory }}
        KUBERNETES_WORKLOAD_RESOURCES_CPU_REQUEST: ${{ inputs.kubernetes-workload-resources-cpu-request }}
        KUBERNETES_WORKLOAD_RESOURCES_CPU_LIMIT: ${{ inputs.kubernetes-workload-resources-cpu-limit }}
        KUBERNETES_WORKLOAD_CONFIGMAP_MOUNT_PATH: ${{ inputs.kubernetes-workload-configmap-mount-path }}
        KUBERNETES_WORKLOAD_SECRET_MOUNT_PATH: ${{ inputs.kubernetes-workload-secret-mount-path }}
        KUBERNETES_WORKLOAD_TERMINATION_GRACE_PERIOD_SECONDS: ${{ inputs.kubernetes-workload-termination-grace-period-seconds }}
        KUBERNETES_WORKLOAD_PRESTOP_COMMAND: ${{ inputs.kubernetes-workload-prestop-command }}
        KUBERNETES_WORKLOAD_AFFINITY_STRATEGY: ${{ inputs.kubernetes-workload-affinity-strategy }}
        KUBERNETES_WORKLOAD_PROBE_LIVENESS_CHECK_TYPE: ${{ inputs.kubernetes-workload-probe-liveness-check-type }}
        KUBERNETES_WORKLOAD_PROBE_READINESS_CHECK_TYPE: ${{ inputs.kubernetes-workload-probe-readiness-check-type }}
        KUBERNETES_WORKLOAD_PROBE_STARTUP_CHECK_TYPE: ${{ inputs.kubernetes-workload-probe-startup-check-type }}
        KUBERNETES_WORKLOAD_PROBE_LIVENESS_HTTP_PATH: ${{ inputs.kubernetes-workload-probe-liveness-http-path }}
        KUBERNETES_WORKLOAD_PROBE_READINESS_HTTP_PATH: ${{ inputs.kubernetes-workload-probe-readiness-http-path }}
        KUBERNETES_WORKLOAD_PROBE_STARTUP_HTTP_PATH: ${{ inputs.kubernetes-workload-probe-startup-http-path }}
        KUBERNETES_WORKLOAD_REPLICAS: ${{ inputs.kubernetes-workload-replicas }}
        KUBERNETES_WORKLOAD_REVISION_HISTORY_LIMIT: ${{ inputs.kubernetes-workload-revision-history-limit }}
        # Workflow inputs - statefulset unique
        KUBERNETES_STATEFULSET_SERVICE_NAME: ${{ inputs.kubernetes-statefulset-service-name }}
        KUBERNETES_STATEFULSET_POD_MANAGEMENT_POLICY: ${{ inputs.kubernetes-statefulset-pod-management-policy }}
        KUBERNETES_STATEFULSET_UPDATE_STRATEGY_TYPE: ${{ inputs.kubernetes-statefulset-update-strategy-type }}
        KUBERNETES_STATEFULSET_UPDATE_STRATEGY_PARTITION: ${{ inputs.kubernetes-statefulset-update-strategy-partition }}
        KUBERNETES_STATEFULSET_PVC_ENABLED: ${{ inputs.kubernetes-statefulset-pvc-enabled }}
        KUBERNETES_STATEFULSET_PVC_STORAGE_CLASS: ${{ inputs.kubernetes-statefulset-pvc-storage-class }}
        KUBERNETES_STATEFULSET_PVC_STORAGE_SIZE: ${{ inputs.kubernetes-statefulset-pvc-storage-size }}
        KUBERNETES_STATEFULSET_PVC_ACCESS_MODE: ${{ inputs.kubernetes-statefulset-pvc-access-mode }}
        KUBERNETES_STATEFULSET_PVC_VOLUME_NAME: ${{ inputs.kubernetes-statefulset-pvc-volume-name }}
        KUBERNETES_STATEFULSET_PVC_MOUNT_PATH: ${{ inputs.kubernetes-statefulset-pvc-mount-path }}
        # Workflow inputs - kubernetes service generation
        KUBERNETES_SERVICE_GENERATION_ENABLED: ${{ inputs.kubernetes-service-generation-enabled }}
        KUBERNETES_SERVICE_TYPE: ${{ inputs.kubernetes-service-type }}
        KUBERNETES_SERVICE_PORT: ${{ inputs.kubernetes-service-port }}
        KUBERNETES_SERVICE_TARGET_PORT: ${{ inputs.kubernetes-service-target-port }}
        KUBERNETES_SERVICE_PROTOCOL: ${{ inputs.kubernetes-service-protocol }}
        KUBERNETES_SERVICE_PORT_NAME: ${{ inputs.kubernetes-service-port-name }}
        KUBERNETES_SERVICE_NODE_PORT: ${{ inputs.kubernetes-service-node-port }}
        KUBERNETES_SERVICE_EXTERNAL_NAME: ${{ inputs.kubernetes-service-external-name }}
        KUBERNETES_SERVICE_EXTERNAL_TRAFFIC_POLICY: ${{ inputs.kubernetes-service-external-traffic-policy }}
        KUBERNETES_SERVICE_NAME_SUFFIX: ${{ inputs.kubernetes-service-name-suffix }}
        KUBERNETES_SERVICE_COMBINED_SUB_PATH: ${{ inputs.kubernetes-service-combined-sub-path }}
        KUBERNETES_SERVICE_ADDITIONAL_LABELS: ${{ inputs.kubernetes-service-additional-labels }}
        KUBERNETES_SERVICE_ADDITIONAL_ANNOTATIONS: ${{ inputs.kubernetes-service-additional-annotations }}

        # Workflow inputs - token substitution
        TOKEN_DELIMITER_STYLE: ${{ inputs.token-delimiter-style }}
        TOKEN_NAME_STYLE: ${{ inputs.token-name-style }}
        TOKEN_NAME_VALIDATION: ${{ inputs.token-name-validation }}
        ALLOW_BUILTIN_TOKEN_OVERRIDE: ${{ inputs.allow-builtin-token-override }}
        CONFIG_SUB_PATH: ${{ inputs.config-sub-path }}
        CONFIG_VALUE_TRAILING_NEWLINE: ${{ inputs.config-value-trailing-newline }}

        # Workflow inputs - naming, versions, and tags calculation
        RELEASE_BRANCH: ${{ inputs.release-branch }}
        ADDITIONAL_RELEASE_BRANCHES: ${{ inputs.additional-release-branches }}
        TAG_VERSION_MAX_PARTS: ${{ inputs.tag-version-max-parts }}
        TAG_VERSION_CALCULATION_STRATEGY: ${{ inputs.tag-version-calculation-strategy }}
        TAG_VERSION_PATTERN_TYPE: ${{ inputs.tag-version-pattern-type }}
        TAG_VERSION_PREFIX_PARTS: ${{ inputs.tag-version-prefix-parts }}
        TAG_VERSION_SOURCE_SUB_PATH: ${{ inputs.tag-version-source-sub-path }}
        TAG_VERSION_SOURCE_FILE_NAME: ${{ inputs.tag-version-source-file-name }}
        TAG_VERSION_SOURCE_CUSTOM_PATTERN: ${{ inputs.tag-version-source-custom-pattern }}

        # Workflow inputs - quality check options
        BLOCK_SLASHES: ${{ inputs.block-slashes }}
        QC_BLOCK_SLASH_CONTAINING_BRANCHES: ${{ inputs.qc-block-slash-containing-branches }}
        QC_BLOCK_DOUBLE_HYPHEN_CONTAINING_BRANCHES: ${{ inputs.qc-block-double-hyphen-containing-branches }}
        QC_REQUIRE_CONVENTIONAL_BRANCHES: ${{ inputs.qc-require-conventional-branches }}
        QC_REQUIRE_CONVENTIONAL_COMMITS: ${{ inputs.qc-require-conventional-commits }}
        QC_BLOCK_CONVENTIONAL_COMMITS: ${{ inputs.qc-block-conventional-commits }}

        # Workflow inputs - hook script paths
        HOOK_PRE_TAGGING_TESTS_SCRIPT_SUB_PATH: ${{ inputs.hook-pre-tagging-tests-script-sub-path }}
        HOOK_PRE_DOCKER_PREPARE_SCRIPT_SUB_PATH: ${{ inputs.hook-pre-docker-prepare-script-sub-path }}
        HOOK_POST_DOCKER_TESTS_SCRIPT_SUB_PATH: ${{ inputs.hook-post-docker-tests-script-sub-path }}
        HOOK_PRE_PACKAGE_PREPARE_SCRIPT_SUB_PATH: ${{ inputs.hook-pre-package-prepare-script-sub-path }}
        HOOK_POST_PACKAGE_TESTS_SCRIPT_SUB_PATH: ${{ inputs.hook-post-package-tests-script-sub-path }}

        # Workflow inputs - github release
        GITHUB_RELEASE_ENABLED: ${{ inputs.github-release-enabled }}
        GITHUB_RELEASE_SUBSTITUTED_FILES: ${{ inputs.github-release-substituted-files }}
        GITHUB_RELEASE_VERBATIM_FILES: ${{ inputs.github-release-verbatim-files }}
        GITHUB_RELEASE_NOTES: ${{ inputs.github-release-notes }}
        GITHUB_RELEASE_ADD_VERSION_TO_FILENAMES: ${{ inputs.github-release-add-version-to-filenames }}

        # Step outputs - version outputs
        VERSION: ${{ inputs.version }}
        VERSION_MAJOR: ${{ inputs.version-major }}
        VERSION_MINOR: ${{ inputs.version-minor }}
        VERSION_PATCH: ${{ inputs.version-patch }}
        VERSION_2_PART: ${{ inputs.version-2-part }}
        VERSION_3_PART: ${{ inputs.version-3-part }}
        VERSION_4_PART: ${{ inputs.version-4-part }}
        DOCKER_TAG: ${{ inputs.docker-tag }}
        DOCKER_IMAGE_NAME: ${{ inputs.docker-image-name }}
        GIT_TAG: ${{ inputs.git-tag }}
        PROJECT_NAME: ${{ inputs.project-name }}
        IS_RELEASE: ${{ inputs.is-release }}
        # Step outputs - docker outputs
        DOCKER_SUBSTITUTED_SUB_PATH: ${{ inputs.docker-substituted-sub-path }}
      run: .github/buildon-github-actions/src/scripts/main/hook-pre-docker-prepare
