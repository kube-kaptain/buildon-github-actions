# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)

name: 'Kubernetes Manifests Package Prepare'
description: 'Prepares manifests and tokens for packaging'

inputs:
  # Action-specific inputs
  manifests-sub-path:
    description: 'Directory containing Kubernetes manifests (relative)'
    required: false
    default: 'src/kubernetes'
  project-name:
    description: 'Project name for variable substitution'
    required: true
  version:
    description: 'Version for variable substitution and naming'
    required: true

  # INJECT-INPUT: output-sub-path

  # Action-specific inputs (passed from version generator/docker build)
  docker-tag:
    description: 'Docker tag for variable substitution'
    required: true
  docker-image-name:
    description: 'Docker image name for variable substitution'
    required: true
  docker-image-full-uri:
    description: 'Full Docker image URI for variable substitution (optional)'
    required: false
    default: ''
  docker-target-registry:
    description: 'Target registry for variable substitution (optional)'
    required: false
    default: ''
  docker-target-base-path:
    description: 'Target base path for variable substitution (optional)'
    required: false
    default: ''
  is-release:
    description: 'Release flag for variable substitution (optional)'
    required: false
    default: ''

  # INJECT-INPUT: token-substitution

outputs:
  manifests-zip-file-name:
    description: 'Filename of the zip (computed from project-name and version)'
    value: ${{ steps.prepare.outputs.MANIFESTS_ZIP_FILE_NAME }}

runs:
  using: 'composite'
  steps:
    - name: Prepare manifests
      id: prepare
      shell: bash
      env:
        LOG_ERROR_PREFIX: '::error::'
        MANIFESTS_SUB_PATH: ${{ inputs.manifests-sub-path }}
        PROJECT_NAME: ${{ inputs.project-name }}
        VERSION: ${{ inputs.version }}
        OUTPUT_SUB_PATH: ${{ inputs.output-sub-path }}
        DOCKER_TAG: ${{ inputs.docker-tag }}
        DOCKER_IMAGE_NAME: ${{ inputs.docker-image-name }}
        DOCKER_IMAGE_FULL_URI: ${{ inputs.docker-image-full-uri }}
        TARGET_REGISTRY: ${{ inputs.docker-target-registry }}
        TARGET_BASE_PATH: ${{ inputs.docker-target-base-path }}
        IS_RELEASE: ${{ inputs.is-release }}
        TOKEN_DELIMITER_STYLE: ${{ inputs.token-delimiter-style }}
        TOKEN_NAME_STYLE: ${{ inputs.token-name-style }}
        TOKEN_NAME_VALIDATION: ${{ inputs.token-name-validation }}
        ALLOW_BUILTIN_TOKEN_OVERRIDE: ${{ inputs.allow-builtin-token-override }}
        CONFIG_SUB_PATH: ${{ inputs.config-sub-path }}
        CONFIG_VALUE_TRAILING_NEWLINE: ${{ inputs.config-value-trailing-newline }}
      run: "${{ github.action_path }}/../../scripts/main/kubernetes-manifests-package-prepare"
