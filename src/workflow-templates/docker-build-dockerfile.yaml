# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)

name: Docker Build Dockerfile
on:
  workflow_call:
    inputs:
      # Dockerfile configuration
      dockerfile-path:
        description: 'Directory containing Dockerfile (also used as build context)'
        required: false
        type: string
        default: 'src/docker'
      squash:
        description: 'Enable --squash (requires experimental mode)'
        required: false
        type: boolean
        default: true
      no-cache:
        description: 'Disable layer caching for reproducible builds'
        required: false
        type: boolean
        default: true
      # Target configuration
      target-registry:
        description: 'Target container registry'
        required: false
        type: string
        default: 'ghcr.io'
      target-base-path:
        description: 'Path between registry and image name (auto-set for GHCR)'
        required: false
        type: string
        default: ''
      confirm-image-doesnt-exist:
        description: 'Fail if target image already exists in registry'
        required: false
        type: boolean
        default: true
      # Version generator inputs (pass-through)
      default-branch:
        description: 'The default/release branch name'
        required: false
        type: string
        default: 'main'
      additional-release-branches:
        description: 'Comma-separated list of additional release branches'
        required: false
        type: string
        default: ''
      block-slashes:
        description: 'Block branch names containing slashes'
        required: false
        type: boolean
        default: false
      block-double-hyphens:
        description: 'Block branch names containing double hyphens (typo detection)'
        required: false
        type: boolean
        default: true
      require-conventional-branches:
        description: 'Require branch names start with feature/, fix/, etc.'
        required: false
        type: boolean
        default: false
      require-conventional-commits:
        description: 'Require commits use conventional commit format (feat:, fix:, etc.)'
        required: false
        type: boolean
        default: false
      block-conventional-commits:
        description: 'Block commits that use conventional commit format'
        required: false
        type: boolean
        default: false
      max-version-parts:
        description: 'Maximum allowed version parts (fail if exceeded)'
        required: false
        type: number
        default: 3
      pre-tagging-tests-script-sub-path:
        description: 'Path to pre-tagging test script relative to .github/ (e.g., bin/pre-tagging.bash)'
        required: false
        type: string
        default: ''
      post-docker-tests-script-sub-path:
        description: 'Path to post-docker test script relative to .github/ (e.g., bin/post-docker.bash)'
        required: false
        type: string
        default: ''
      docker-registry-logins:
        description: 'YAML config for Docker registry logins (registry URL as key)'
        required: false
        type: string
        default: ''
    secrets:
      docker-registry-logins-secrets:
        description: 'JSON object of secrets for docker-registry-logins (e.g., {"DOCKER_USER": "x", "DOCKER_PASS": "y"})'
        required: false
    outputs:
      # Version outputs
      version:
        description: 'The generated version'
        value: ${{ jobs.build.outputs.version }}
      version-major:
        description: 'Major version number'
        value: ${{ jobs.build.outputs.version-major }}
      version-minor:
        description: 'Minor version number'
        value: ${{ jobs.build.outputs.version-minor }}
      version-patch:
        description: 'Patch version number'
        value: ${{ jobs.build.outputs.version-patch }}
      version-2-part:
        description: 'Version padded/truncated to 2 parts'
        value: ${{ jobs.build.outputs.version-2-part }}
      version-3-part:
        description: 'Version padded/truncated to 3 parts'
        value: ${{ jobs.build.outputs.version-3-part }}
      version-4-part:
        description: 'Version padded/truncated to 4 parts'
        value: ${{ jobs.build.outputs.version-4-part }}
      docker-tag:
        description: 'Tag for Docker images'
        value: ${{ jobs.build.outputs.docker-tag }}
      docker-image-name:
        description: 'Docker image name'
        value: ${{ jobs.build.outputs.docker-image-name }}
      project-name:
        description: 'The repository/project name'
        value: ${{ jobs.build.outputs.project-name }}
      is-release:
        description: 'Whether this is a release build'
        value: ${{ jobs.build.outputs.is-release }}
      # Build outputs
      target-image-full-uri:
        description: 'Full target image reference (action output name)'
        value: ${{ jobs.build.outputs.target-image-full-uri }}
      docker-image-full-uri:
        description: 'Full docker image reference (alias for target-image-full-uri)'
        value: ${{ jobs.build.outputs.target-image-full-uri }}
      docker-image-pushed:
        description: 'Whether docker image was pushed'
        value: ${{ jobs.build.outputs.docker-image-pushed }}
jobs:
  basic-quality-checks:
    name: Basic Quality Checks
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    permissions:
      checks: write
    steps:
      # INJECT: parse-workflow-ref-and-checkout
      # INJECT: github-check-start(name="Basic Quality Checks", id="check-quality")
      # INJECT: basic-quality-checks
      # INJECT: github-check-end(name="Basic Quality Checks", id="check-quality")
  build:
    name: Build & Push
    needs: basic-quality-checks
    if: always() && (needs.basic-quality-checks.result == 'success' || needs.basic-quality-checks.result == 'skipped')
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      packages: write
      checks: write
    outputs:
      version: ${{ steps.versions.outputs.version }}
      version-major: ${{ steps.versions.outputs.version-major }}
      version-minor: ${{ steps.versions.outputs.version-minor }}
      version-patch: ${{ steps.versions.outputs.version-patch }}
      version-2-part: ${{ steps.versions.outputs.version-2-part }}
      version-3-part: ${{ steps.versions.outputs.version-3-part }}
      version-4-part: ${{ steps.versions.outputs.version-4-part }}
      docker-tag: ${{ steps.versions.outputs.docker-tag }}
      docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
      project-name: ${{ steps.versions.outputs.project-name }}
      is-release: ${{ steps.versions.outputs.is-release }}
      target-image-full-uri: ${{ steps.docker-build.outputs.target-image-full-uri }}
      docker-image-pushed: ${{ steps.docker-push.outputs.image-pushed }}
    steps:
      # INJECT: parse-workflow-ref-and-checkout

      # === Docker Registry Logins ===
      - name: Docker registry logins
        uses: ./.github/buildon-github-actions/src/actions/docker-registry-logins
        with:
          config: ${{ inputs.docker-registry-logins }}
          secrets-json: ${{ secrets.docker-registry-logins-secrets || toJSON(secrets) }}
          target-registry: ${{ inputs.target-registry }}

      # === Pre-tagging Tests ===
      # INJECT: github-check-start(name="Pre-tagging Tests", id="check-pre-tagging", if="inputs.pre-tagging-tests-script-sub-path != ''")
      - name: Run pre-tagging tests
        if: inputs.pre-tagging-tests-script-sub-path != ''
        id: pre-tagging-tests
        uses: ./.github/buildon-github-actions/src/actions/run-test-script
        with:
          script-sub-path: ${{ inputs.pre-tagging-tests-script-sub-path }}
      # INJECT: github-check-end(name="Pre-tagging Tests", id="check-pre-tagging", if="inputs.pre-tagging-tests-script-sub-path != ''")

      # === Versions & Naming ===
      # INJECT: github-check-start(name="Versions & Naming", id="check-versions")
      # INJECT: versions-and-naming
      # INJECT: github-check-end(name="Versions & Naming", id="check-versions")

      # === Docker Build ===
      # INJECT: github-check-start(name="Docker Build", id="check-docker-build")
      - name: Build image
        id: docker-build
        uses: ./.github/buildon-github-actions/src/actions/docker-build-dockerfile
        with:
          target-registry: ${{ inputs.target-registry }}
          target-base-path: ${{ inputs.target-base-path }}
          target-image-name: ${{ steps.versions.outputs.docker-image-name }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}
          version: ${{ steps.versions.outputs.version }}
          project-name: ${{ steps.versions.outputs.project-name }}
          dockerfile-path: ${{ inputs.dockerfile-path }}
          squash: ${{ inputs.squash }}
          no-cache: ${{ inputs.no-cache }}
          confirm-image-doesnt-exist: ${{ inputs.confirm-image-doesnt-exist }}
      # INJECT: github-check-end(name="Docker Build", id="check-docker-build")

      # === Post-docker Tests ===
      # INJECT: github-check-start(name="Post-docker Tests", id="check-post-docker", if="inputs.post-docker-tests-script-sub-path != ''")
      - name: Run post-docker tests
        if: inputs.post-docker-tests-script-sub-path != ''
        id: post-docker-tests
        uses: ./.github/buildon-github-actions/src/actions/run-test-script
        with:
          script-sub-path: ${{ inputs.post-docker-tests-script-sub-path }}
          version: ${{ steps.versions.outputs.version }}
          docker-tag: ${{ steps.versions.outputs.docker-tag }}
          docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
          project-name: ${{ steps.versions.outputs.project-name }}
          is-release: ${{ steps.versions.outputs.is-release }}
          target-image-full-uri: ${{ steps.docker-build.outputs.target-image-full-uri }}
      # INJECT: github-check-end(name="Post-docker Tests", id="check-post-docker", if="inputs.post-docker-tests-script-sub-path != ''")

      # === Docker Push ===
      # INJECT: github-check-start(name="Docker Push", id="check-docker-push", if="steps.versions.outputs.is-release == 'true'")
      - name: Push image
        id: docker-push
        if: steps.versions.outputs.is-release == 'true'
        shell: bash
        run: |
          docker push "${{ steps.docker-build.outputs.target-image-full-uri }}"
          echo "image-pushed=true" >> "$GITHUB_OUTPUT"
      # INJECT: github-check-end(name="Docker Push", id="check-docker-push", if="steps.versions.outputs.is-release == 'true'")
