# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)

name: Docker Build Retag
kaptain-order: 50
kaptain-description: Everything from quality and version above, but also pulls, retags, and republishes a docker image
on:
  workflow_call:
    inputs:
      # INJECT-INPUT: output-sub-path

      # INJECT-INPUT: docker-build
      # INJECT-INPUT: docker-retag

      # INJECT-INPUT: token-substitution

      # INJECT-INPUT: release-branches
      # INJECT-INPUT: tag-version

      # INJECT-INPUT: basic-quality-checks

      # INJECT-INPUT: hooks-pre-tagging

      # INJECT-INPUT: github-release
    secrets:
      docker-registry-logins-secrets:
        description: 'JSON object of secrets for docker-registry-logins (e.g., {"DOCKER_USER": "x", "DOCKER_PASS": "y"})'
        required: false
    outputs:
      # Version outputs
      version:
        description: 'The generated version'
        value: ${{ jobs.build.outputs.version }}
      version-major:
        description: 'Major version number'
        value: ${{ jobs.build.outputs.version-major }}
      version-minor:
        description: 'Minor version number'
        value: ${{ jobs.build.outputs.version-minor }}
      version-patch:
        description: 'Patch version number'
        value: ${{ jobs.build.outputs.version-patch }}
      version-2-part:
        description: 'Version padded/truncated to 2 parts'
        value: ${{ jobs.build.outputs.version-2-part }}
      version-3-part:
        description: 'Version padded/truncated to 3 parts'
        value: ${{ jobs.build.outputs.version-3-part }}
      version-4-part:
        description: 'Version padded/truncated to 4 parts'
        value: ${{ jobs.build.outputs.version-4-part }}
      docker-tag:
        description: 'Tag for Docker images'
        value: ${{ jobs.build.outputs.docker-tag }}
      docker-image-name:
        description: 'Docker image name'
        value: ${{ jobs.build.outputs.docker-image-name }}
      git-tag:
        description: 'Tag for git'
        value: ${{ jobs.build.outputs.git-tag }}
      project-name:
        description: 'The repository/project name'
        value: ${{ jobs.build.outputs.project-name }}
      is-release:
        description: 'Whether this is a release build'
        value: ${{ jobs.build.outputs.is-release }}
      # Retag outputs
      docker-source-image-full-uri:
        description: 'Full source image reference'
        value: ${{ jobs.build.outputs.docker-source-image-full-uri }}
      docker-target-image-full-uri:
        description: 'Full target image reference'
        value: ${{ jobs.build.outputs.docker-target-image-full-uri }}
      docker-image-full-uri:
        description: 'Full docker image reference (alias for docker-target-image-full-uri)'
        value: ${{ jobs.build.outputs.docker-target-image-full-uri }}
      docker-image-pushed:
        description: 'Whether docker image was pushed'
        value: ${{ jobs.build.outputs.docker-image-pushed }}
jobs:
  basic-quality-checks:
    name: Basic Quality Checks
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      # INJECT: parse-workflow-ref-and-checkout
      # INJECT: basic-quality-checks
  build:
    name: Build & Push
    needs: basic-quality-checks
    if: always() && (needs.basic-quality-checks.result == 'success' || needs.basic-quality-checks.result == 'skipped')
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      packages: write
      checks: write
    outputs:
      version: ${{ steps.versions.outputs.version }}
      version-major: ${{ steps.versions.outputs.version-major }}
      version-minor: ${{ steps.versions.outputs.version-minor }}
      version-patch: ${{ steps.versions.outputs.version-patch }}
      version-2-part: ${{ steps.versions.outputs.version-2-part }}
      version-3-part: ${{ steps.versions.outputs.version-3-part }}
      version-4-part: ${{ steps.versions.outputs.version-4-part }}
      docker-tag: ${{ steps.versions.outputs.docker-tag }}
      docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
      git-tag: ${{ steps.versions.outputs.git-tag }}
      project-name: ${{ steps.versions.outputs.project-name }}
      is-release: ${{ steps.versions.outputs.is-release }}
      docker-source-image-full-uri: ${{ steps.docker-build.outputs.docker-source-image-full-uri }}
      docker-target-image-full-uri: ${{ steps.docker-build.outputs.docker-target-image-full-uri }}
      docker-image-pushed: ${{ steps.docker-push.outputs.image-pushed }}
    steps:
      # INJECT: parse-workflow-ref-and-checkout

      # === Resolve Registry ===
      # INJECT: resolve-registry-and-namespace

      # === Docker Registry Logins ===
      # INJECT: github-check-start(name="Docker Registry Logins", id="check-docker-registry-logins")
      # INJECT: docker-registry-logins
      # INJECT: github-check-end(name="Docker Registry Logins", id="check-docker-registry-logins")

      # === Pre-tagging Tests ===
      # INJECT: github-check-start(name="Pre-tagging Tests", id="check-pre-tagging", if="inputs.hook-pre-tagging-tests-script-sub-path != ''")
      # INJECT: hook-pre-tagging-tests
      # INJECT: github-check-end(name="Pre-tagging Tests", id="check-pre-tagging", if="inputs.hook-pre-tagging-tests-script-sub-path != ''")

      # === Versions & Naming ===
      # INJECT: github-check-start(name="Versions & Naming", id="check-versions")
      # INJECT: versions-and-naming
      # INJECT: github-check-end(name="Versions & Naming", id="check-versions")

      # === Docker Retag ===
      # INJECT: github-check-start(name="Docker Retag", id="check-docker-retag")
      # INJECT: docker-build-retag
      # INJECT: github-check-end(name="Docker Retag", id="check-docker-retag")

      # === Docker Multi-Tag ===
      # INJECT: github-check-start(name="Docker Multi-Tag", id="check-docker-multi-tag", if="inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true'")
      # INJECT: docker-multi-tag
      # INJECT: github-check-end(name="Docker Multi-Tag", id="check-docker-multi-tag", if="inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true'")

      # === GitHub Release Prepare ===
      # INJECT: github-check-start(name="GitHub Release Prepare", id="check-github-release-prepare", if="inputs.github-release-enabled == true")
      # INJECT: github-release-prepare-docker
      # INJECT: github-check-end(name="GitHub Release Prepare", id="check-github-release-prepare", if="inputs.github-release-enabled == true")

      # === Git Tag Push ===
      # INJECT: github-check-start(name="Git Tag Push", id="check-git-push-tag", if="steps.versions.outputs.is-release == 'true'")
      # INJECT: git-push-tag
      # INJECT: github-check-end(name="Git Tag Push", id="check-git-push-tag", if="steps.versions.outputs.is-release == 'true'")

      # === Docker Push ===
      # INJECT: github-check-start(name="Docker Push", id="check-docker-push", if="steps.versions.outputs.is-release == 'true'")
      # INJECT: docker-push
      # INJECT: github-check-end(name="Docker Push", id="check-docker-push", if="steps.versions.outputs.is-release == 'true'")

      # === Docker Multi-Push ===
      # INJECT: github-check-start(name="Docker Multi-Push", id="check-docker-multi-push", if="inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true'")
      # INJECT: docker-multi-push
      # INJECT: github-check-end(name="Docker Multi-Push", id="check-docker-multi-push", if="inputs.docker-push-targets != '' && steps.versions.outputs.is-release == 'true'")

      # === GitHub Release ===
      # INJECT: github-check-start(name="GitHub Release", id="check-github-release", if="inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true'")
      # INJECT: github-release-docker
      # INJECT: github-check-end(name="GitHub Release", id="check-github-release", if="inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true'")
