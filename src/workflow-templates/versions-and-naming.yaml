# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)

name: Versions & Naming
kaptain-order: 20
kaptain-description: Calculates and sets all critical artifact naming and version/tag information, and performs a GitHub release
on:
  workflow_call:
    inputs:
      # Build output
      output-sub-path:
        description: 'Build output directory (relative)'
        required: false
        type: string
        default: 'target'

      # INJECT-INPUT: token-substitution

      # Naming, Versions, and Tags calculation
      release-branch:
        description: 'The release branch name'
        required: false
        type: string
        default: 'main'
      additional-release-branches:
        description: 'Comma-separated list of additional release branches'
        required: false
        type: string
        default: ''
      tag-version-max-parts:
        description: 'Maximum allowed version parts (fail if exceeded)'
        required: false
        type: number
        default: 3
      tag-version-calculation-strategy:
        description: 'Strategy for calculating version (git-auto-closest-highest, file-pattern-match)'
        required: false
        type: string
        default: 'git-auto-closest-highest'
      tag-version-pattern-type:
        description: 'Pattern type for file-pattern-match strategy (dockerfile-env-kubectl, retag-workflow-source-tag, custom)'
        required: false
        type: string
        default: 'dockerfile-env-kubectl'
      tag-version-prefix-parts:
        description: 'Number of parts from source version to use as prefix (default 2, output = prefix + 1 parts)'
        required: false
        type: string
        default: ''
      tag-version-source-sub-path:
        description: 'Override path to source directory (takes precedence over dockerfile-sub-path)'
        required: false
        type: string
        default: ''
      tag-version-source-file-name:
        description: 'Override source file name (defaults based on pattern type)'
        required: false
        type: string
        default: ''
      tag-version-source-custom-pattern:
        description: 'Regex with capture group for version extraction (required for custom pattern type)'
        required: false
        type: string
        default: ''

      # Hook script paths
      hook-pre-tagging-tests-script-sub-path:
        description: 'Path to pre-tagging test script relative to .github/ (e.g., bin/pre-tagging.bash)'
        required: false
        type: string
        default: ''

      # GitHub release
      github-release-enabled:
        description: 'Create a GitHub release on version tags'
        required: false
        type: boolean
        default: true
      github-release-substituted-files:
        description: 'Files with token substitution and version suffix (space-separated)'
        required: false
        type: string
        default: ''
      github-release-verbatim-files:
        description: 'Files copied as-is with version suffix only (space-separated)'
        required: false
        type: string
        default: ''
      github-release-notes:
        description: 'Release notes (leave empty for auto-generated)'
        required: false
        type: string
        default: ''
      github-release-add-version-to-filenames:
        description: 'Add version suffix to release filenames (e.g., file.yaml -> file-1.2.3.yaml)'
        required: false
        type: boolean
        default: true
    outputs:
      version:
        description: 'The generated version'
        value: ${{ jobs.versions-and-naming.outputs.version }}
      version-major:
        description: 'Major version number'
        value: ${{ jobs.versions-and-naming.outputs.version-major }}
      version-minor:
        description: 'Minor version number'
        value: ${{ jobs.versions-and-naming.outputs.version-minor }}
      version-patch:
        description: 'Patch version number'
        value: ${{ jobs.versions-and-naming.outputs.version-patch }}
      version-2-part:
        description: 'Version padded/truncated to 2 parts'
        value: ${{ jobs.versions-and-naming.outputs.version-2-part }}
      version-3-part:
        description: 'Version padded/truncated to 3 parts'
        value: ${{ jobs.versions-and-naming.outputs.version-3-part }}
      version-4-part:
        description: 'Version padded/truncated to 4 parts'
        value: ${{ jobs.versions-and-naming.outputs.version-4-part }}
      docker-tag:
        description: 'Tag for Docker images'
        value: ${{ jobs.versions-and-naming.outputs.docker-tag }}
      docker-image-name:
        description: 'Docker image name (prefix/project-name)'
        value: ${{ jobs.versions-and-naming.outputs.docker-image-name }}
      git-tag:
        description: 'Tag for git'
        value: ${{ jobs.versions-and-naming.outputs.git-tag }}
      is-release:
        description: 'Whether this is a release build'
        value: ${{ jobs.versions-and-naming.outputs.is-release }}
      project-name:
        description: 'The repository/project name'
        value: ${{ jobs.versions-and-naming.outputs.project-name }}
jobs:
  versions-and-naming:
    name: Versions & Naming
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    outputs:
      version: ${{ steps.versions.outputs.version }}
      version-major: ${{ steps.versions.outputs.version-major }}
      version-minor: ${{ steps.versions.outputs.version-minor }}
      version-patch: ${{ steps.versions.outputs.version-patch }}
      version-2-part: ${{ steps.versions.outputs.version-2-part }}
      version-3-part: ${{ steps.versions.outputs.version-3-part }}
      version-4-part: ${{ steps.versions.outputs.version-4-part }}
      docker-tag: ${{ steps.versions.outputs.docker-tag }}
      docker-image-name: ${{ steps.versions.outputs.docker-image-name }}
      git-tag: ${{ steps.versions.outputs.git-tag }}
      is-release: ${{ steps.versions.outputs.is-release }}
      project-name: ${{ steps.versions.outputs.project-name }}
    steps:
      # INJECT: parse-workflow-ref-and-checkout

      # === Pre-tagging Tests ===
      # INJECT: github-check-start(name="Pre-tagging Tests", id="check-pre-tagging", if="inputs.hook-pre-tagging-tests-script-sub-path != ''")
      # INJECT: hook-pre-tagging-tests
      # INJECT: github-check-end(name="Pre-tagging Tests", id="check-pre-tagging", if="inputs.hook-pre-tagging-tests-script-sub-path != ''")

      # === Versions & Naming ===
      # INJECT: github-check-start(name="Versions & Naming", id="check-versions")
      # INJECT: versions-and-naming
      # INJECT: github-check-end(name="Versions & Naming", id="check-versions")

      # === GitHub Release Prepare ===
      # INJECT: github-check-start(name="GitHub Release Prepare", id="check-github-release-prepare", if="inputs.github-release-enabled == true")
      # INJECT: github-release-prepare-no-files
      # INJECT: github-check-end(name="GitHub Release Prepare", id="check-github-release-prepare", if="inputs.github-release-enabled == true")

      # === Git Tag Push ===
      # INJECT: github-check-start(name="Git Tag Push", id="check-git-push-tag", if="steps.versions.outputs.is-release == 'true'")
      # INJECT: git-push-tag
      # INJECT: github-check-end(name="Git Tag Push", id="check-git-push-tag", if="steps.versions.outputs.is-release == 'true'")

      # === GitHub Release ===
      # INJECT: github-check-start(name="GitHub Release", id="check-github-release", if="inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true'")
      # INJECT: github-release-no-files
      # INJECT: github-check-end(name="GitHub Release", id="check-github-release", if="inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true'")
