#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# generate-kubernetes-workload - Routes to appropriate workload generator
#
# Validates KUBERNETES_WORKLOAD_TYPE and dispatches to the matching generator.
# Set KUBERNETES_WORKLOAD_TYPE=none to skip workload generation entirely.
#
# Inputs (environment variables):
#   KUBERNETES_WORKLOAD_TYPE - Workload type to generate (default: deployment)
#                              Values: none, deployment, statefulset, etc.
#                              Additional types can be added by creating
#                              generate-kubernetes-workload-<type> scripts.
#
# All other KUBERNETES_WORKLOAD_* and KUBERNETES_<TYPE>_* variables are
# passed through to the selected generator.
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../defaults/platform.bash"
# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../lib/log.bash"

# shellcheck source=src/scripts/defaults/kubernetes-workload.bash
source "${SCRIPT_DIR}/../defaults/kubernetes-workload.bash"

# Handle disabled
if [[ "${WORKLOAD_TYPE}" == "none" ]]; then
  log "Workload generation disabled (KUBERNETES_WORKLOAD_TYPE=none)"
  exit 0
fi

# Validate and find generator
GENERATOR="${SCRIPT_DIR}/generate-kubernetes-workload-${WORKLOAD_TYPE}"

if [[ ! -x "${GENERATOR}" ]]; then
  log_error "Unknown workload type '${WORKLOAD_TYPE}'"
  log ""
  log "Available workload types:"
  for gen in "${SCRIPT_DIR}"/generate-kubernetes-workload-*; do
    if [[ -x "${gen}" ]]; then
      type_name="${gen##*generate-kubernetes-workload-}"
      log "  - ${type_name}"
    fi
  done
  exit 1
fi

# Dispatch to generator (inherits all env vars)
exec "${GENERATOR}"
