#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# generate-kubernetes-service - Generates a Kubernetes Service manifest
#
# Creates a Service resource for exposing pods within the cluster or externally.
#
# Inputs (environment variables):
#   KUBERNETES_SERVICE_GENERATION_ENABLED - Set to "true" to enable (default: false)
#   KUBERNETES_SERVICE_TYPE         - Service type: ClusterIP, NodePort, LoadBalancer (default: ClusterIP)
#   KUBERNETES_SERVICE_PORT         - Service port (default: 80)
#   KUBERNETES_SERVICE_TARGET_PORT  - Target port on pod (default: KUBERNETES_WORKLOAD_CONTAINER_PORT)
#   KUBERNETES_SERVICE_PROTOCOL     - Protocol: TCP, UDP, SCTP (default: TCP)
#   KUBERNETES_SERVICE_NAME_SUFFIX  - Optional suffix for name/filename (default: empty)
#   KUBERNETES_SERVICE_COMBINED_SUB_PATH - Sub-path within combined/ for output (default: empty)
#   KUBERNETES_WORKLOAD_CONTAINER_PORT - Container port for target-port default (default: 1024)
#   OUTPUT_SUB_PATH            - Build output directory (default: target)
#   PROJECT_NAME               - Used in metadata.name (required)
#   TOKEN_NAME_STYLE           - Style for token references (default: PascalCase)
#   TOKEN_DELIMITER_STYLE      - Delimiter style for tokens (default: shell)
#   KUBERNETES_GLOBAL_ADDITIONAL_LABELS      - Extra labels for all manifests (comma-separated key=value)
#   KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS - Extra annotations for all manifests
#   KUBERNETES_SERVICE_ADDITIONAL_LABELS     - Service-specific extra labels
#   KUBERNETES_SERVICE_ADDITIONAL_ANNOTATIONS - Service-specific extra annotations
#
# Output:
#   ${OUTPUT_SUB_PATH}/manifests/combined/[${combined-sub-path}/]service[-${suffix}].yaml
#
# metadata.name pattern:
#   ${ProjectName}[-${combined-sub-path}][-${suffix}]
#
set -euo pipefail

# Locate script directory for libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Source libraries
# shellcheck source=src/scripts/lib/token-format.bash
source "${LIB_DIR}/token-format.bash"
# shellcheck source=src/scripts/lib/kubernetes-metadata.bash
source "${LIB_DIR}/kubernetes-metadata.bash"

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# Default workload type
KUBERNETES_WORKLOAD_TYPE="${KUBERNETES_WORKLOAD_TYPE:-deployment}"

# Smart default: enabled for deployments, disabled for others, unless explicitly set
if [[ -z "${KUBERNETES_SERVICE_GENERATION_ENABLED:-}" ]]; then
  case "${KUBERNETES_WORKLOAD_TYPE}" in
    deployment)
      KUBERNETES_SERVICE_GENERATION_ENABLED="true"
      ;;
    *)
      KUBERNETES_SERVICE_GENERATION_ENABLED="false"
      ;;
  esac
fi

if [[ "${KUBERNETES_SERVICE_GENERATION_ENABLED}" != "true" ]]; then
  echo "Service generation not enabled (workload type: ${KUBERNETES_WORKLOAD_TYPE}), skipping" >&2
  exit 0
fi

# Inputs with defaults
KUBERNETES_SERVICE_TYPE="${KUBERNETES_SERVICE_TYPE:-ClusterIP}"
KUBERNETES_SERVICE_PORT="${KUBERNETES_SERVICE_PORT:-80}"
KUBERNETES_SERVICE_TARGET_PORT="${KUBERNETES_SERVICE_TARGET_PORT:-${KUBERNETES_WORKLOAD_CONTAINER_PORT:-1024}}"
KUBERNETES_SERVICE_PROTOCOL="${KUBERNETES_SERVICE_PROTOCOL:-TCP}"
KUBERNETES_SERVICE_NAME_SUFFIX="${KUBERNETES_SERVICE_NAME_SUFFIX:-}"
KUBERNETES_SERVICE_COMBINED_SUB_PATH="${KUBERNETES_SERVICE_COMBINED_SUB_PATH:-}"
OUTPUT_SUB_PATH="${OUTPUT_SUB_PATH:-target}"
# shellcheck source=src/scripts/defaults/tokens.bash
source "${SCRIPT_DIR}/../defaults/tokens.bash"

# Validate service type
case "${KUBERNETES_SERVICE_TYPE}" in
  ClusterIP|NodePort|LoadBalancer|ExternalName)
    ;;
  *)
    echo "${LOG_ERROR_PREFIX}Invalid KUBERNETES_SERVICE_TYPE: ${KUBERNETES_SERVICE_TYPE}. Must be one of: ClusterIP, NodePort, LoadBalancer, ExternalName${LOG_ERROR_SUFFIX}" >&2
    exit 4
    ;;
esac

# Validate protocol
case "${KUBERNETES_SERVICE_PROTOCOL}" in
  TCP|UDP|SCTP)
    ;;
  *)
    echo "${LOG_ERROR_PREFIX}Invalid KUBERNETES_SERVICE_PROTOCOL: ${KUBERNETES_SERVICE_PROTOCOL}. Must be one of: TCP, UDP, SCTP${LOG_ERROR_SUFFIX}" >&2
    exit 7
    ;;
esac

# Validate styles upfront
validate_token_styles

# Validate combined sub-path format
validate_combined_sub_path "${KUBERNETES_SERVICE_COMBINED_SUB_PATH}"

# Generate token references
project_name_token=$(format_canonical_token "${TOKEN_DELIMITER_STYLE}" "${TOKEN_NAME_STYLE}" "PROJECT_NAME")
environment_token=$(format_canonical_token "${TOKEN_DELIMITER_STYLE}" "${TOKEN_NAME_STYLE}" "ENVIRONMENT")
version_token=$(format_canonical_token "${TOKEN_DELIMITER_STYLE}" "${TOKEN_NAME_STYLE}" "VERSION")

# Build metadata.name: ${ProjectName}[-${combined}][-${suffix}]
name_middle=$(build_name_middle_fragment "${KUBERNETES_SERVICE_COMBINED_SUB_PATH}" "${KUBERNETES_SERVICE_NAME_SUFFIX}")
service_name="${project_name_token}${name_middle}"

# Create output directory
output_dir=$(ensure_manifest_output_dir "${OUTPUT_SUB_PATH}" "${KUBERNETES_SERVICE_COMBINED_SUB_PATH}")

# Generate Service YAML (include suffix in filename if provided)
if [[ -n "${KUBERNETES_SERVICE_NAME_SUFFIX}" ]]; then
  output_file="${output_dir}/service-${KUBERNETES_SERVICE_NAME_SUFFIX}.yaml"
else
  output_file="${output_dir}/service.yaml"
fi

# Get current timestamp and script name for annotations
build_timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
script_name=$(basename "${BASH_SOURCE[0]}")

# Additional labels/annotations from inputs
global_labels="${KUBERNETES_GLOBAL_ADDITIONAL_LABELS:-}"
specific_labels="${KUBERNETES_SERVICE_ADDITIONAL_LABELS:-}"
global_annotations="${KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS:-}"
specific_annotations="${KUBERNETES_SERVICE_ADDITIONAL_ANNOTATIONS:-}"

{
  generate_manifest_header "v1" "Service" "${service_name}" "${environment_token}"
  generate_metadata 2 labels
  generate_metadata 2 annotations
  echo "spec:"
  echo "  type: ${KUBERNETES_SERVICE_TYPE}"
  echo "  selector:"
  echo "    app: ${project_name_token}"
  echo "  ports:"
  echo "    - port: ${KUBERNETES_SERVICE_PORT}"
  echo "      targetPort: ${KUBERNETES_SERVICE_TARGET_PORT}"
  echo "      protocol: ${KUBERNETES_SERVICE_PROTOCOL}"
} > "${output_file}"

echo "Generated Service manifest: ${output_file}" >&2
