#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
#
# docker-build-retag - Pulls and retags Docker images (no push)
#
# Inputs (environment variables):
#   SOURCE_REGISTRY     - Source registry (e.g., docker.io)
#   SOURCE_IMAGE_NAME   - Source image name (e.g., library/nginx)
#   SOURCE_TAG          - Source image tag (e.g., 1.25)
#   TARGET_REGISTRY     - Target registry (e.g., ghcr.io)
#   TARGET_BASE_PATH    - Path between registry and image name (optional)
#   TARGET_IMAGE_NAME   - Target image name (from version generator)
#   DOCKER_TAG          - Target tag (from version generator)
#
# Outputs:
#   SOURCE_IMAGE_FULL_URI - Full source image reference
#   TARGET_IMAGE_FULL_URI - Full target image reference
#
set -euo pipefail

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# Required inputs
SOURCE_REGISTRY="${SOURCE_REGISTRY:?SOURCE_REGISTRY is required}"
SOURCE_IMAGE_NAME="${SOURCE_IMAGE_NAME:?SOURCE_IMAGE_NAME is required}"
SOURCE_TAG="${SOURCE_TAG:?SOURCE_TAG is required}"
TARGET_REGISTRY="${TARGET_REGISTRY:?TARGET_REGISTRY is required}"
TARGET_IMAGE_NAME="${TARGET_IMAGE_NAME:?TARGET_IMAGE_NAME is required}"
DOCKER_TAG="${DOCKER_TAG:?DOCKER_TAG is required}"

# Optional inputs with defaults
TARGET_BASE_PATH="${TARGET_BASE_PATH:-}"

# Assemble full image URIs
SOURCE_IMAGE_FULL_URI="${SOURCE_REGISTRY}/${SOURCE_IMAGE_NAME}:${SOURCE_TAG}"
if [[ -n "${TARGET_BASE_PATH}" ]]; then
  TARGET_IMAGE_FULL_URI="${TARGET_REGISTRY}/${TARGET_BASE_PATH}/${TARGET_IMAGE_NAME}:${DOCKER_TAG}"
else
  TARGET_IMAGE_FULL_URI="${TARGET_REGISTRY}/${TARGET_IMAGE_NAME}:${DOCKER_TAG}"
fi

confirm_image_doesnt_exist() {
  local image="${1}"

  # Check registry for existing image via manifest inspect (no layer download)
  if docker manifest inspect "${image}" &>/dev/null; then
    echo "${LOG_ERROR_PREFIX}Target image already exists in registry: ${image}${LOG_ERROR_SUFFIX}" >&2
    return 1
  fi

  echo "Confirmed image does not exist in registry (safe to push)" >&2
  return 0
}

# Output variable for GitHub Actions
output_var() {
  local name="${1}"
  local value="${2}"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "${GITHUB_OUTPUT}"
  fi
}

main() {
  echo "=== Docker Retag ===" >&2
  echo "Source: ${SOURCE_IMAGE_FULL_URI}" >&2
  echo "Target: ${TARGET_IMAGE_FULL_URI}" >&2
  echo "====================" >&2

  echo "Pulling source image: ${SOURCE_IMAGE_FULL_URI}" >&2
  docker pull "${SOURCE_IMAGE_FULL_URI}"

  # Confirm target doesn't exist (fail fast)
  confirm_image_doesnt_exist "${TARGET_IMAGE_FULL_URI}" || exit 1

  echo "Tagging: ${SOURCE_IMAGE_FULL_URI} -> ${TARGET_IMAGE_FULL_URI}" >&2
  docker tag "${SOURCE_IMAGE_FULL_URI}" "${TARGET_IMAGE_FULL_URI}"

  output_var "SOURCE_IMAGE_FULL_URI" "${SOURCE_IMAGE_FULL_URI}"
  output_var "TARGET_IMAGE_FULL_URI" "${TARGET_IMAGE_FULL_URI}"

  echo "Docker Retag complete" >&2
}

main "$@"
