#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# hook-pre-package-prepare - Entry point for pre-package-prepare hook
#
# Runs user's hook script before manifest packaging.
# Use this hook to generate additional ConfigMaps, modify manifests,
# or add files to the package before it's zipped.
#
# Inputs (environment variables):
#   HOOK_SCRIPT_SUB_PATH - Path to user's hook script (set by CI wrapper)
#
# Available context (set by CI wrapper):
#   VERSION - Full version string
#   VERSION_MAJOR - Major version number
#   VERSION_MINOR - Minor version number
#   VERSION_PATCH - Patch version number
#   VERSION_2_PART - Version as 2 parts (e.g., 1.2)
#   VERSION_3_PART - Version as 3 parts (e.g., 1.2.3)
#   VERSION_4_PART - Version as 4 parts (e.g., 1.2.3.0)
#   DOCKER_TAG - Docker tag (version with optional -PRERELEASE suffix)
#   DOCKER_IMAGE_NAME - Docker image name
#   GIT_TAG - Git tag
#   PROJECT_NAME - Project name
#   IS_RELEASE - Whether this is a release build (true/false)
#   TARGET_IMAGE_FULL_URI - Full image URI (empty in manifests-only workflows)
#   DOCKER_IMAGE_FULL_URI - Alias for TARGET_IMAGE_FULL_URI
#   MANIFESTS_SUBSTITUTED_SUB_PATH - Where substituted manifests go
#   ... and all workflow inputs
#
# For ConfigMap generation (call generate-kubernetes-configmap):
#   TOKEN_NAME_STYLE - Token name style (default: PascalCase)
#   TOKEN_DELIMITER_STYLE - Token delimiter syntax (default: shell)
#   KUBERNETES_GLOBAL_ADDITIONAL_LABELS - Extra labels for all manifests
#   KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS - Extra annotations for all manifests
#   KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS - ConfigMap-specific labels
#   KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS - ConfigMap-specific annotations
#   KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION - Enable checksum suffix (default: true)
#
set -euo pipefail

# === User Project Inputs ===
# Defaults and input conditioning sourced from defaults scripts - single source of truth

# shellcheck source=src/scripts/defaults/branch-inputs.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/branch-inputs.bash"
# shellcheck source=src/scripts/defaults/output-sub-path.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/output-sub-path.bash"
# shellcheck source=src/scripts/defaults/manifests-sub-path.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/manifests-sub-path.bash"
# shellcheck source=src/scripts/defaults/docker-build.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/docker-build.bash"
# shellcheck source=src/scripts/defaults/docker-dockerfile.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/docker-dockerfile.bash"
# shellcheck source=src/scripts/defaults/docker-retag.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/docker-retag.bash"
# shellcheck source=src/scripts/defaults/tokens.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/tokens.bash"
# shellcheck source=src/scripts/defaults/tag-versioning.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/tag-versioning.bash"
# shellcheck source=src/scripts/defaults/quality-checks.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/quality-checks.bash"
# shellcheck source=src/scripts/defaults/docker-common.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/docker-common.bash"

# === Vendor Specific ===
# shellcheck source=src/scripts/defaults/vendor-github-release.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/vendor-github-release.bash"

# shellcheck source=src/scripts/defaults/kubernetes-manifest.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-manifest.bash"
# shellcheck source=src/scripts/defaults/kubernetes-configmap.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-configmap.bash"
# shellcheck source=src/scripts/defaults/kubernetes-secret-template.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-secret-template.bash"
# shellcheck source=src/scripts/defaults/kubernetes-serviceaccount.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-serviceaccount.bash"
# shellcheck source=src/scripts/defaults/kubernetes-workload.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-workload.bash"
# shellcheck source=src/scripts/defaults/kubernetes-workload-deployment.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-workload-deployment.bash"
# shellcheck source=src/scripts/defaults/kubernetes-workload-statefulset.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-workload-statefulset.bash"
# shellcheck source=src/scripts/defaults/kubernetes-workload-daemonset.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-workload-daemonset.bash"
# shellcheck source=src/scripts/defaults/kubernetes-cronjob.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-cronjob.bash"
# shellcheck source=src/scripts/defaults/kubernetes-job.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-job.bash"
# shellcheck source=src/scripts/defaults/kubernetes-poddisruptionbudget.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-poddisruptionbudget.bash"
# shellcheck source=src/scripts/defaults/kubernetes-service.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/kubernetes-service.bash"

# shellcheck source=src/scripts/defaults/manifests-repo-provider.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/manifests-repo-provider.bash"

# Export all workflow inputs
export OUTPUT_SUB_PATH
export DOCKER_PUSH_IMAGE_LIST_FILE
export DOCKER_REGISTRY_LOGINS DOCKER_TARGET_REGISTRY DOCKER_TARGET_NAMESPACE DOCKER_PUSH_TARGETS
export DOCKERFILE_SUB_PATH DOCKERFILE_SQUASH DOCKERFILE_NO_CACHE IMAGE_BUILD_COMMAND
export DOCKER_CONTEXT_SUB_PATH DOCKER_PLATFORM
export DOCKERFILE_SUB_PATH_LINUX_AMD64 DOCKERFILE_SUB_PATH_LINUX_ARM64
export DOCKER_CONTEXT_SUB_PATH_LINUX_AMD64 DOCKER_CONTEXT_SUB_PATH_LINUX_ARM64
export DOCKER_SOURCE_REGISTRY DOCKER_SOURCE_NAMESPACE DOCKER_SOURCE_IMAGE_NAME DOCKER_SOURCE_TAG
export MANIFESTS_SUB_PATH
export MANIFESTS_REPO_PROVIDER_TYPE MANIFESTS_PACKAGING_BASE_IMAGE
export KUBERNETES_GLOBAL_ADDITIONAL_LABELS KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS
export KUBERNETES_CONFIGMAP_SUB_PATH KUBERNETES_CONFIGMAP_NAME_SUFFIX KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH
export KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION
export KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS
export KUBERNETES_SECRET_TEMPLATE_SUB_PATH KUBERNETES_SECRET_TEMPLATE_NAME_SUFFIX KUBERNETES_SECRET_TEMPLATE_COMBINED_SUB_PATH
export KUBERNETES_SECRET_TEMPLATE_NAME_CHECKSUM_INJECTION
export KUBERNETES_SECRET_TEMPLATE_ADDITIONAL_LABELS KUBERNETES_SECRET_TEMPLATE_ADDITIONAL_ANNOTATIONS
export KUBERNETES_SERVICEACCOUNT_NAME_SUFFIX KUBERNETES_SERVICEACCOUNT_COMBINED_SUB_PATH
export KUBERNETES_SERVICEACCOUNT_ADDITIONAL_LABELS KUBERNETES_SERVICEACCOUNT_ADDITIONAL_ANNOTATIONS
export KUBERNETES_WORKLOAD_TYPE KUBERNETES_WORKLOAD_NAME_SUFFIX KUBERNETES_WORKLOAD_COMBINED_SUB_PATH
export KUBERNETES_WORKLOAD_REPLICAS KUBERNETES_WORKLOAD_REVISION_HISTORY_LIMIT
export KUBERNETES_WORKLOAD_MIN_READY_SECONDS KUBERNETES_WORKLOAD_PRIORITY_CLASS_NAME
export KUBERNETES_WORKLOAD_CONTAINER_COMMAND KUBERNETES_WORKLOAD_CONTAINER_ARGS
export KUBERNETES_WORKLOAD_NODE_SELECTOR KUBERNETES_WORKLOAD_DNS_POLICY KUBERNETES_WORKLOAD_TOLERATIONS
export KUBERNETES_DEPLOYMENT_ENV_SUB_PATH
export KUBERNETES_DEPLOYMENT_ADDITIONAL_LABELS KUBERNETES_DEPLOYMENT_ADDITIONAL_ANNOTATIONS
export KUBERNETES_DEPLOYMENT_MAX_SURGE KUBERNETES_DEPLOYMENT_MAX_UNAVAILABLE
export KUBERNETES_STATEFULSET_ENV_SUB_PATH KUBERNETES_STATEFULSET_SERVICE_NAME
export KUBERNETES_STATEFULSET_POD_MANAGEMENT_POLICY KUBERNETES_STATEFULSET_ALLOW_UNRELIABLE_POD_MANAGEMENT_POLICY
export KUBERNETES_STATEFULSET_UPDATE_STRATEGY_TYPE KUBERNETES_STATEFULSET_UPDATE_STRATEGY_PARTITION
export KUBERNETES_STATEFULSET_PVC_ENABLED KUBERNETES_STATEFULSET_PVC_STORAGE_CLASS
export KUBERNETES_STATEFULSET_PVC_STORAGE_SIZE KUBERNETES_STATEFULSET_PVC_ACCESS_MODE
export KUBERNETES_STATEFULSET_PVC_VOLUME_NAME KUBERNETES_STATEFULSET_PVC_MOUNT_PATH
export KUBERNETES_STATEFULSET_ADDITIONAL_LABELS KUBERNETES_STATEFULSET_ADDITIONAL_ANNOTATIONS
export KUBERNETES_DAEMONSET_ENV_SUB_PATH KUBERNETES_DAEMONSET_UPDATE_STRATEGY_TYPE
export KUBERNETES_DAEMONSET_MAX_UNAVAILABLE KUBERNETES_DAEMONSET_HOST_NETWORK
export KUBERNETES_DAEMONSET_HOST_PID KUBERNETES_DAEMONSET_HOST_IPC
export KUBERNETES_DAEMONSET_RUN_AS_NON_ROOT KUBERNETES_DAEMONSET_PRIVILEGED
export KUBERNETES_DAEMONSET_DNS_POLICY KUBERNETES_DAEMONSET_TOLERATIONS KUBERNETES_DAEMONSET_NODE_SELECTOR
export KUBERNETES_DAEMONSET_ADDITIONAL_LABELS KUBERNETES_DAEMONSET_ADDITIONAL_ANNOTATIONS
export KUBERNETES_CRONJOB_NAME_SUFFIX KUBERNETES_CRONJOB_COMBINED_SUB_PATH
export KUBERNETES_CRONJOB_CONCURRENCY_POLICY KUBERNETES_CRONJOB_STARTING_DEADLINE_SECONDS
export KUBERNETES_CRONJOB_SUCCESSFUL_JOBS_HISTORY_LIMIT KUBERNETES_CRONJOB_FAILED_JOBS_HISTORY_LIMIT
export KUBERNETES_CRONJOB_BACKOFF_LIMIT KUBERNETES_CRONJOB_COMPLETIONS KUBERNETES_CRONJOB_PARALLELISM
export KUBERNETES_CRONJOB_ACTIVE_DEADLINE_SECONDS KUBERNETES_CRONJOB_TTL_SECONDS_AFTER_FINISHED
export KUBERNETES_CRONJOB_RESTART_POLICY KUBERNETES_CRONJOB_ENV_SUB_PATH
export KUBERNETES_CRONJOB_PORTS_ENABLED KUBERNETES_CRONJOB_LIVENESS_PROBE_ENABLED
export KUBERNETES_CRONJOB_READINESS_PROBE_ENABLED KUBERNETES_CRONJOB_STARTUP_PROBE_ENABLED
export KUBERNETES_CRONJOB_ADDITIONAL_LABELS KUBERNETES_CRONJOB_ADDITIONAL_ANNOTATIONS
export KUBERNETES_JOB_NAME_SUFFIX KUBERNETES_JOB_COMBINED_SUB_PATH
export KUBERNETES_JOB_BACKOFF_LIMIT KUBERNETES_JOB_COMPLETIONS KUBERNETES_JOB_PARALLELISM
export KUBERNETES_JOB_ACTIVE_DEADLINE_SECONDS KUBERNETES_JOB_TTL_SECONDS_AFTER_FINISHED
export KUBERNETES_JOB_RESTART_POLICY KUBERNETES_JOB_ENV_SUB_PATH
export KUBERNETES_JOB_PORTS_ENABLED KUBERNETES_JOB_LIVENESS_PROBE_ENABLED
export KUBERNETES_JOB_READINESS_PROBE_ENABLED KUBERNETES_JOB_STARTUP_PROBE_ENABLED
export KUBERNETES_JOB_ADDITIONAL_LABELS KUBERNETES_JOB_ADDITIONAL_ANNOTATIONS
export KUBERNETES_SERVICE_TYPE KUBERNETES_SERVICE_PORT KUBERNETES_SERVICE_TARGET_PORT
export KUBERNETES_SERVICE_PROTOCOL KUBERNETES_SERVICE_PORT_NAME KUBERNETES_SERVICE_NODE_PORT
export KUBERNETES_SERVICE_EXTERNAL_NAME KUBERNETES_SERVICE_EXTERNAL_TRAFFIC_POLICY
export KUBERNETES_SERVICE_NAME_SUFFIX KUBERNETES_SERVICE_COMBINED_SUB_PATH
export KUBERNETES_SERVICE_GENERATION_ENABLED
export KUBERNETES_SERVICE_ADDITIONAL_LABELS KUBERNETES_SERVICE_ADDITIONAL_ANNOTATIONS
export KUBERNETES_PODDISRUPTIONBUDGET_GENERATION_ENABLED
export KUBERNETES_PODDISRUPTIONBUDGET_NAME_SUFFIX KUBERNETES_PODDISRUPTIONBUDGET_COMBINED_SUB_PATH
export KUBERNETES_PODDISRUPTIONBUDGET_STRATEGY KUBERNETES_PODDISRUPTIONBUDGET_VALUE
export KUBERNETES_PODDISRUPTIONBUDGET_ADDITIONAL_LABELS KUBERNETES_PODDISRUPTIONBUDGET_ADDITIONAL_ANNOTATIONS
export TOKEN_DELIMITER_STYLE TOKEN_NAME_STYLE TOKEN_NAME_VALIDATION
export ALLOW_BUILTIN_TOKEN_OVERRIDE CONFIG_SUB_PATH CONFIG_VALUE_TRAILING_NEWLINE
export DEFAULT_BRANCH CURRENT_BRANCH RELEASE_BRANCH ADDITIONAL_RELEASE_BRANCHES TAG_VERSION_MAX_PARTS
export TAG_VERSION_CALCULATION_STRATEGY TAG_VERSION_PATTERN_TYPE TAG_VERSION_PREFIX_PARTS
export TAG_VERSION_SOURCE_SUB_PATH TAG_VERSION_SOURCE_FILE_NAME TAG_VERSION_SOURCE_CUSTOM_PATTERN TAG_VERSION_USE_SOURCE_VERSION_EXACT
export BLOCK_SLASHES QC_BLOCK_SLASH_CONTAINING_BRANCHES QC_BLOCK_DOUBLE_HYPHEN_CONTAINING_BRANCHES
export QC_REQUIRE_CONVENTIONAL_BRANCHES QC_REQUIRE_CONVENTIONAL_COMMITS QC_BLOCK_CONVENTIONAL_COMMITS QC_BLOCK_DUPLICATE_COMMIT_MESSAGES
export GITHUB_RELEASE_ENABLED GITHUB_RELEASE_SUBSTITUTED_FILES GITHUB_RELEASE_VERBATIM_FILES
export GITHUB_RELEASE_NOTES GITHUB_RELEASE_NOTES_FILE GITHUB_RELEASE_ADD_VERSION_TO_FILENAMES

# === Step Outputs ===
# Version outputs from versions-and-naming step
: "${VERSION:?VERSION is required}"
: "${VERSION_MAJOR:?VERSION_MAJOR is required}"
: "${VERSION_MINOR:?VERSION_MINOR is required}"
: "${VERSION_PATCH:?VERSION_PATCH is required}"
: "${VERSION_2_PART:?VERSION_2_PART is required}"
: "${VERSION_3_PART:?VERSION_3_PART is required}"
: "${VERSION_4_PART:?VERSION_4_PART is required}"
: "${DOCKER_TAG:?DOCKER_TAG is required}"
: "${DOCKER_IMAGE_NAME:?DOCKER_IMAGE_NAME is required}"
: "${GIT_TAG:?GIT_TAG is required}"
: "${PROJECT_NAME:?PROJECT_NAME is required}"
: "${IS_RELEASE:?IS_RELEASE is required}"
# Docker outputs (optional - empty in manifests-only workflows)
TARGET_IMAGE_FULL_URI="${TARGET_IMAGE_FULL_URI:-}"
DOCKER_SUBSTITUTED_SUB_PATH="${DOCKER_SUBSTITUTED_SUB_PATH:-}"
# Manifest outputs from substitution step
: "${MANIFESTS_SUBSTITUTED_SUB_PATH:?MANIFESTS_SUBSTITUTED_SUB_PATH is required}"

# Export step outputs for hook script
export VERSION VERSION_MAJOR VERSION_MINOR VERSION_PATCH
export VERSION_2_PART VERSION_3_PART VERSION_4_PART
export DOCKER_TAG DOCKER_IMAGE_NAME GIT_TAG PROJECT_NAME IS_RELEASE
export TARGET_IMAGE_FULL_URI DOCKER_SUBSTITUTED_SUB_PATH
export MANIFESTS_SUBSTITUTED_SUB_PATH
# User-friendly alias for TARGET_IMAGE_FULL_URI
DOCKER_IMAGE_FULL_URI="${TARGET_IMAGE_FULL_URI}"
export DOCKER_IMAGE_FULL_URI

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=src/scripts/lib/hook-runner.bash
source "${SCRIPT_DIR}/../lib/hook-runner.bash"
