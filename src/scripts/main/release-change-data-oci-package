#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# release-change-data-oci-package - Packages release change data as OCI image
#
# Builds a FROM scratch OCI image containing the versioned release-change-data YAML.
# Registers the image URI for consolidated push via docker-push-all.
#
# Inputs (environment variables):
#   VERSION                    - Release version (from versions-and-naming)
#   DOCKER_TAG                 - Docker tag (from versions-and-naming)
#   DOCKER_IMAGE_NAME          - Docker image name (from versions-and-naming)
#   DOCKER_TARGET_REGISTRY     - Target registry (from resolve-registry)
#   DOCKER_TARGET_NAMESPACE     - Target namespace (from resolve-registry, optional)
#   OUTPUT_SUB_PATH            - Build output directory (default: target)
#   DOCKER_PUSH_IMAGE_LIST_FILE - Path to push list file (from docker-registry-logins)
#   IMAGE_BUILD_COMMAND        - Container runtime (podman or docker)
#
set -euo pipefail

SCRIPT_DIR="$(dirname "${0}")"

# shellcheck source=src/scripts/defaults/output-sub-path.bash
source "${SCRIPT_DIR}/../defaults/output-sub-path.bash"
# shellcheck source=src/scripts/defaults/docker-push-image-list.bash
source "${SCRIPT_DIR}/../defaults/docker-push-image-list.bash"
# shellcheck source=src/scripts/defaults/image-build-command.bash
source "${SCRIPT_DIR}/../defaults/image-build-command.bash"
# shellcheck source=src/scripts/lib/output-var.bash
source "${SCRIPT_DIR}/../lib/output-var.bash"

# Logging
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-ERROR: }"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# Required inputs
VERSION="${VERSION:?VERSION is required}"
DOCKER_TAG="${DOCKER_TAG:?DOCKER_TAG is required}"
DOCKER_IMAGE_NAME="${DOCKER_IMAGE_NAME:?DOCKER_IMAGE_NAME is required}"
DOCKER_TARGET_REGISTRY="${DOCKER_TARGET_REGISTRY:?DOCKER_TARGET_REGISTRY is required}"
DOCKER_TARGET_NAMESPACE="${DOCKER_TARGET_NAMESPACE:-}"

# Paths
DOCKER_CONTEXT_DIR="${OUTPUT_SUB_PATH}/release-change-data/docker-context"
VERSIONED_YAML="release-change-data-${VERSION}.yaml"

# Assemble image URI with -release-change-data tag suffix
IMAGE_TAG="${DOCKER_TAG}-release-change-data"
if [[ -n "${DOCKER_TARGET_NAMESPACE}" ]]; then
  IMAGE_URI="${DOCKER_TARGET_REGISTRY}/${DOCKER_TARGET_NAMESPACE}/${DOCKER_IMAGE_NAME}:${IMAGE_TAG}"
else
  IMAGE_URI="${DOCKER_TARGET_REGISTRY}/${DOCKER_IMAGE_NAME}:${IMAGE_TAG}"
fi

main() {
  echo "=== Release Change Data OCI Package ===" >&2
  echo "Version: ${VERSION}" >&2
  echo "Target: ${IMAGE_URI}" >&2
  echo "Context: ${DOCKER_CONTEXT_DIR}" >&2
  echo "=========================================" >&2

  # Validate versioned YAML exists
  if [[ ! -f "${DOCKER_CONTEXT_DIR}/${VERSIONED_YAML}" ]]; then
    echo "${LOG_ERROR_PREFIX}Versioned YAML not found: ${DOCKER_CONTEXT_DIR}/${VERSIONED_YAML}${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Generate Dockerfile in context directory
  cat > "${DOCKER_CONTEXT_DIR}/Dockerfile" <<EOF
FROM scratch
LABEL version="${VERSION}"
LABEL project.name="${DOCKER_IMAGE_NAME}"
LABEL image.name="${IMAGE_URI}"
COPY ${VERSIONED_YAML} /${VERSIONED_YAML}
EOF

  # Build the image
  echo "Building release change data image..." >&2
  ${IMAGE_BUILD_COMMAND} build -t "${IMAGE_URI}" "${DOCKER_CONTEXT_DIR}"

  # Register image for consolidated push
  echo "${IMAGE_URI}" >> "${DOCKER_PUSH_IMAGE_LIST_FILE}"

  output_var "RELEASE_CHANGE_DATA_IMAGE_URI" "${IMAGE_URI}"

  echo "Release change data OCI package complete: ${IMAGE_URI}" >&2
}

main "$@"
