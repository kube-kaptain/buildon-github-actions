#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# release-change-data-oci-package - Packages release change data as OCI image
#
# Prepares the content directory with the versioned release-change-data YAML,
# then delegates to docker-package-multi-arch for multi-architecture builds.
#
# Inputs (environment variables):
#   VERSION                    - Release version (from versions-and-naming)
#   DOCKER_TAG                 - Docker tag (from versions-and-naming)
#   DOCKER_IMAGE_NAME          - Docker image name (from versions-and-naming)
#   DOCKER_TARGET_REGISTRY     - Target registry (from resolve-registry)
#   DOCKER_TARGET_NAMESPACE     - Target namespace (from resolve-registry, optional)
#   OUTPUT_SUB_PATH            - Build output directory (default: target)
#   DOCKER_PUSH_IMAGE_LIST_FILE - Path to push list file (from docker-registry-logins)
#   IMAGE_BUILD_COMMAND        - Container runtime (podman or docker)
#
set -euo pipefail

SCRIPT_DIR="$(dirname "${0}")"

# shellcheck source=src/scripts/defaults/output-sub-path.bash
source "${SCRIPT_DIR}/../defaults/output-sub-path.bash"
# shellcheck source=src/scripts/defaults/docker-common.bash
source "${SCRIPT_DIR}/../defaults/docker-common.bash"
# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../defaults/platform.bash"

# shellcheck source=src/scripts/lib/output-var.bash
source "${SCRIPT_DIR}/../lib/output-var.bash"
# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../lib/log.bash"

# Required inputs
VERSION="${VERSION:?VERSION is required}"
DOCKER_TAG="${DOCKER_TAG:?DOCKER_TAG is required}"
DOCKER_IMAGE_NAME="${DOCKER_IMAGE_NAME:?DOCKER_IMAGE_NAME is required}"
DOCKER_TARGET_REGISTRY="${DOCKER_TARGET_REGISTRY:?DOCKER_TARGET_REGISTRY is required}"
DOCKER_TARGET_NAMESPACE="${DOCKER_TARGET_NAMESPACE:-}"

# Paths
CONTENT_DIR="${OUTPUT_SUB_PATH}/release-change-data/docker-context"
VERSIONED_YAML="release-change-data-${VERSION}.yaml"

# Assemble image URI with -release-change-data tag suffix
IMAGE_TAG="${DOCKER_TAG}-release-change-data"
if [[ -n "${DOCKER_TARGET_NAMESPACE}" ]]; then
  IMAGE_URI="${DOCKER_TARGET_REGISTRY}/${DOCKER_TARGET_NAMESPACE}/${DOCKER_IMAGE_NAME}:${IMAGE_TAG}"
else
  IMAGE_URI="${DOCKER_TARGET_REGISTRY}/${DOCKER_IMAGE_NAME}:${IMAGE_TAG}"
fi

main() {
  log "=== Release Change Data OCI Package ==="
  log "Version: ${VERSION}"
  log "Target: ${IMAGE_URI}"
  log "Content: ${CONTENT_DIR}"
  log "========================================="

  # Validate versioned YAML exists
  if [[ ! -f "${CONTENT_DIR}/${VERSIONED_YAML}" ]]; then
    log_error "Versioned YAML not found: ${CONTENT_DIR}/${VERSIONED_YAML}"
    exit 1
  fi

  # Delegate to multi-arch packager
  "${SCRIPT_DIR}/../util/docker-package-multi-arch" "${CONTENT_DIR}" "${IMAGE_URI}"

  output_var "RELEASE_CHANGE_DATA_IMAGE_URI" "${IMAGE_URI}"

  log "Release change data OCI package complete: ${IMAGE_URI}"
}

main "$@"
