#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# docker-platform-setup - Validates docker platform and installs QEMU on Linux CI
#
# Validates DOCKER_PLATFORM against allowed values and installs QEMU binfmt
# support on Linux build servers for cross-architecture builds.
#
# Inputs (environment variables):
#   DOCKER_PLATFORM    - Target platform (from docker-common.bash default or input)
#   IMAGE_BUILD_COMMAND - Container runtime (from validate-tooling)
#   BUILD_MODE         - "local" or "build_server" (from build-mode.bash default)
#
set -euo pipefail

SCRIPT_DIR="$(dirname "${0}")"

# shellcheck source=src/scripts/defaults/docker-common.bash
source "${SCRIPT_DIR}/../defaults/docker-common.bash"
# shellcheck source=src/scripts/defaults/build-mode.bash
source "${SCRIPT_DIR}/../defaults/build-mode.bash"
# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../defaults/platform.bash"

# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../lib/log.bash"

log "=== Docker Platform Setup ==="
log "Platform: ${DOCKER_PLATFORM}"
log "Build mode: ${BUILD_MODE}"
log "============================="

# Validate platform value
case "${DOCKER_PLATFORM}" in
  linux/amd64) ;;
  linux/arm64) ;;
  linux/amd64,linux/arm64) ;;
  linux/arm64,linux/amd64) ;;
  *)
    log_error "Invalid DOCKER_PLATFORM value '${DOCKER_PLATFORM}' - must be: linux/amd64, linux/arm64, or both comma-separated"
    exit 1
    ;;
esac

log "Platform validated: ${DOCKER_PLATFORM}"

# Install QEMU on Linux build servers (always, not conditional on platform value)
if [[ "$(uname -s)" == "Linux" ]] && [[ "${BUILD_MODE}" == "build_server" ]]; then
  # Check if binfmt is already registered (e.g. pre-baked CI image)
  if ls /proc/sys/fs/binfmt_misc/qemu-* &>/dev/null; then
    log "QEMU binfmt already registered — skipping install"
  else
    log "Linux build server detected — installing QEMU binfmt support..."
    if command -v apt-get &>/dev/null; then
      sudo apt-get update
      sudo apt-get install -y qemu-user-static binfmt-support
    elif command -v yum &>/dev/null; then
      sudo yum install -y qemu-user-static
    else
      log_error "No supported package manager found (need apt-get or yum)"
      exit 1
    fi
    log "QEMU binfmt support installed"
  fi
else
  log "Not a Linux build server — skipping QEMU install"
fi

log "Docker platform setup complete"
