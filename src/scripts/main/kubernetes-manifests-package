#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-package - Packages Kubernetes manifests into a zip with variable substitution
#
# Performs substitution and creates the final zip file.
# Requires kubernetes-manifests-package-prepare to have run first.
#
# Inputs (environment variables):
#   PROJECT_NAME    - For output naming (required)
#   VERSION         - For output naming (required)
#   OUTPUT_SUB_PATH - Build output directory, relative (default: target)
#   TOKEN_DELIMITER_STYLE - Token delimiter syntax (default: shell)
#   CONFIG_VALUE_TRAILING_NEWLINE - Trailing newline handling (default: strip-for-single-line)
#
# Outputs:
#   MANIFESTS_ZIP_SUB_PATH - Relative path to directory containing the zip file
#   MANIFESTS_ZIP_FILE_NAME - Filename of zip
#
set -euo pipefail

# Locate script directory for calling sibling scripts
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Required inputs
PROJECT_NAME="${PROJECT_NAME:?PROJECT_NAME is required}"
VERSION="${VERSION:?VERSION is required}"

# shellcheck source=src/scripts/defaults/output-sub-path.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/output-sub-path.bash"
# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../defaults/platform.bash"

# Token substitution defaults
# shellcheck source=src/scripts/defaults/tokens.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/tokens.bash"

# shellcheck source=src/scripts/lib/output-var.bash
source "${SCRIPT_DIR}/../lib/output-var.bash"
# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../lib/log.bash"

# Build output structure (sub-paths, relative to working directory)
MANIFESTS_COMBINED_SUB_PATH="${OUTPUT_SUB_PATH}/manifests/combined"
MANIFESTS_CONFIG_SUB_PATH="${OUTPUT_SUB_PATH}/manifests/config"
MANIFESTS_SUBSTITUTED_SUB_PATH="${OUTPUT_SUB_PATH}/manifests/substituted"
MANIFESTS_ZIP_SUB_PATH="${OUTPUT_SUB_PATH}/manifests/zip"

main() {
  log "=== Kubernetes Manifest Package ==="
  log "Project: ${PROJECT_NAME}"
  log "Version: ${VERSION}"
  log "Output: ${OUTPUT_SUB_PATH}"
  log "===================================="

  # Validate prepare has run
  if [[ ! -d "${MANIFESTS_COMBINED_SUB_PATH}" ]]; then
    log_error "Combined manifests directory not found: ${MANIFESTS_COMBINED_SUB_PATH}"
    log_error "Did kubernetes-manifests-package-prepare run first?"
    exit 1
  fi

  if [[ ! -d "${MANIFESTS_CONFIG_SUB_PATH}" ]]; then
    log_error "Config/tokens directory not found: ${MANIFESTS_CONFIG_SUB_PATH}"
    log_error "Did kubernetes-manifests-package-prepare run first?"
    exit 1
  fi

  # Compute the zip filename
  local zip_name="${PROJECT_NAME}-${VERSION}-manifests.zip"

  # Copy manifests to substituted/<project-name>/
  log ""
  log "Preparing manifests for substitution..."
  mkdir -p "${MANIFESTS_SUBSTITUTED_SUB_PATH}/${PROJECT_NAME}"
  cp -R "${MANIFESTS_COMBINED_SUB_PATH}"/* "${MANIFESTS_SUBSTITUTED_SUB_PATH}/${PROJECT_NAME}/"

  # Perform variable substitution
  log "Performing variable substitution..."
  CONFIG_VALUE_TRAILING_NEWLINE="${CONFIG_VALUE_TRAILING_NEWLINE}" \
  "${SCRIPT_DIR}/../util/substitute-tokens-from-dir" \
    "${TOKEN_DELIMITER_STYLE}" \
    "${MANIFESTS_CONFIG_SUB_PATH}" \
    "${MANIFESTS_SUBSTITUTED_SUB_PATH}/${PROJECT_NAME}"

  # Create zip directly from substituted (project-name wrapper already in place)
  log ""
  log "Creating zip: ${MANIFESTS_ZIP_SUB_PATH}/${zip_name}"

  local repo_root
  repo_root="$(pwd)"
  (cd "${MANIFESTS_SUBSTITUTED_SUB_PATH}" && zip -rq "${repo_root}/${MANIFESTS_ZIP_SUB_PATH}/${zip_name}" "${PROJECT_NAME}")

  # Verify zip was created
  if [[ ! -f "${MANIFESTS_ZIP_SUB_PATH}/${zip_name}" ]]; then
    log_error "Failed to create zip file"
    exit 1
  fi

  local zip_size
  zip_size=$(wc -c < "${MANIFESTS_ZIP_SUB_PATH}/${zip_name}" | tr -d ' ')
  log "Created: ${zip_name} (${zip_size} bytes)"

  output_var "MANIFESTS_ZIP_SUB_PATH" "${MANIFESTS_ZIP_SUB_PATH}"
  output_var "MANIFESTS_ZIP_FILE_NAME" "${zip_name}"

  log ""
  log "=== Package Complete ==="
}

main "$@"
