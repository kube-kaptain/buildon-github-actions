#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-package - Packages Kubernetes manifests into a zip with variable substitution
#
# Performs substitution and creates the final zip file.
# Requires kubernetes-manifests-package-prepare to have run first.
#
# Inputs (environment variables):
#   PROJECT_NAME    - For output naming (required)
#   VERSION         - For output naming (required)
#   OUTPUT_SUB_PATH - Build output directory, relative (default: target)
#   TOKEN_DELIMITER_STYLE - Token delimiter syntax (default: shell)
#   CONFIG_VALUE_TRAILING_NEWLINE - Trailing newline handling (default: strip-for-single-line)
#
# Outputs:
#   MANIFESTS_ZIP_SUB_PATH - Relative path to directory containing the zip file
#   MANIFESTS_ZIP_FILE_NAME - Filename of zip
#
set -euo pipefail

# Locate script directory for calling sibling scripts
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# Required inputs
PROJECT_NAME="${PROJECT_NAME:?PROJECT_NAME is required}"
VERSION="${VERSION:?VERSION is required}"

# shellcheck source=src/scripts/defaults/output-sub-path.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/output-sub-path.bash"

# Token substitution defaults
# shellcheck source=src/scripts/defaults/tokens.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/tokens.bash"

# Build output structure (sub-paths, relative to working directory)
MANIFESTS_COMBINED_SUB_PATH="${OUTPUT_SUB_PATH}/manifests/combined"
MANIFESTS_CONFIG_SUB_PATH="${OUTPUT_SUB_PATH}/manifests/config"
MANIFESTS_SUBSTITUTED_SUB_PATH="${OUTPUT_SUB_PATH}/manifests/substituted"
MANIFESTS_ZIP_SUB_PATH="${OUTPUT_SUB_PATH}/manifests/zip"

# Output variable for GitHub Actions
output_var() {
  local name="$1"
  local value="$2"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "${GITHUB_OUTPUT}"
  fi
}

main() {
  echo "=== Kubernetes Manifest Package ===" >&2
  echo "Project: ${PROJECT_NAME}" >&2
  echo "Version: ${VERSION}" >&2
  echo "Output: ${OUTPUT_SUB_PATH}" >&2
  echo "====================================" >&2

  # Validate prepare has run
  if [[ ! -d "${MANIFESTS_COMBINED_SUB_PATH}" ]]; then
    echo "${LOG_ERROR_PREFIX}Combined manifests directory not found: ${MANIFESTS_COMBINED_SUB_PATH}${LOG_ERROR_SUFFIX}" >&2
    echo "${LOG_ERROR_PREFIX}Did kubernetes-manifests-package-prepare run first?${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  if [[ ! -d "${MANIFESTS_CONFIG_SUB_PATH}" ]]; then
    echo "${LOG_ERROR_PREFIX}Config/tokens directory not found: ${MANIFESTS_CONFIG_SUB_PATH}${LOG_ERROR_SUFFIX}" >&2
    echo "${LOG_ERROR_PREFIX}Did kubernetes-manifests-package-prepare run first?${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Compute the zip filename
  local zip_name="${PROJECT_NAME}-${VERSION}-manifests.zip"

  # Copy manifests to substituted/<project-name>/
  echo "" >&2
  echo "Preparing manifests for substitution..." >&2
  mkdir -p "${MANIFESTS_SUBSTITUTED_SUB_PATH}/${PROJECT_NAME}"
  cp -R "${MANIFESTS_COMBINED_SUB_PATH}"/* "${MANIFESTS_SUBSTITUTED_SUB_PATH}/${PROJECT_NAME}/"

  # Perform variable substitution
  echo "Performing variable substitution..." >&2
  CONFIG_VALUE_TRAILING_NEWLINE="${CONFIG_VALUE_TRAILING_NEWLINE}" \
  "${SCRIPT_DIR}/../util/substitute-tokens-from-dir" \
    "${TOKEN_DELIMITER_STYLE}" \
    "${MANIFESTS_CONFIG_SUB_PATH}" \
    "${MANIFESTS_SUBSTITUTED_SUB_PATH}/${PROJECT_NAME}"

  # Create zip directly from substituted (project-name wrapper already in place)
  echo "" >&2
  echo "Creating zip: ${MANIFESTS_ZIP_SUB_PATH}/${zip_name}" >&2

  local repo_root
  repo_root="$(pwd)"
  (cd "${MANIFESTS_SUBSTITUTED_SUB_PATH}" && zip -rq "${repo_root}/${MANIFESTS_ZIP_SUB_PATH}/${zip_name}" "${PROJECT_NAME}")

  # Verify zip was created
  if [[ ! -f "${MANIFESTS_ZIP_SUB_PATH}/${zip_name}" ]]; then
    echo "${LOG_ERROR_PREFIX}Failed to create zip file${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  local zip_size
  zip_size=$(wc -c < "${MANIFESTS_ZIP_SUB_PATH}/${zip_name}" | tr -d ' ')
  echo "Created: ${zip_name} (${zip_size} bytes)" >&2

  output_var "MANIFESTS_ZIP_SUB_PATH" "${MANIFESTS_ZIP_SUB_PATH}"
  output_var "MANIFESTS_ZIP_FILE_NAME" "${zip_name}"

  echo "" >&2
  echo "=== Package Complete ===" >&2
}

main "$@"
