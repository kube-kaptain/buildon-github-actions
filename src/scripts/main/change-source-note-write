#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# change-source-note-write - Writes a git note with merge candidate metadata
#
# Records the source branch and creator as a git note on HEAD.
# Pushes to refs/notes/kaptain-change-source for later retrieval by
# release-change-data-generate during release builds.
#
# Non-fatal: if the push fails (permissions, forks, etc.), warns and continues.
#
# Inputs (environment variables):
#   CURRENT_BRANCH           - The branch being built
#   MERGE_CANDIDATE_CREATOR  - Who created the merge candidate (optional)
#
set -euo pipefail

SCRIPT_DIR="$(dirname "${0}")"

# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../defaults/platform.bash"

# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../lib/log.bash"

CURRENT_BRANCH="${CURRENT_BRANCH:?CURRENT_BRANCH is required}"
MERGE_CANDIDATE_CREATOR="${MERGE_CANDIDATE_CREATOR:-}"

NOTES_REF="kaptain-change-source"

main() {
  log "=== Change Source Note Write ==="
  log "Branch: ${CURRENT_BRANCH}"
  log "Creator: ${MERGE_CANDIDATE_CREATOR:-<not set>}"
  log "================================"

  local note_content="merge-candidate-branch: ${CURRENT_BRANCH}"
  if [[ -n "${MERGE_CANDIDATE_CREATOR}" ]]; then
    note_content="${note_content}
merge-candidate-creator: ${MERGE_CANDIDATE_CREATOR}"
  fi

  local head_sha
  head_sha=$(git rev-parse HEAD)

  # Fetch existing notes so push is fast-forward
  git fetch origin "refs/notes/${NOTES_REF}:refs/notes/${NOTES_REF}" 2>/dev/null || true

  # Write the note
  if ! git notes --ref="${NOTES_REF}" add -f -m "${note_content}" HEAD; then
    log_warning "Failed to write change source note to ${head_sha}"
    return 0
  fi
  log "Note written to ${head_sha}"

  # Push the note (non-fatal)
  if git push origin "refs/notes/${NOTES_REF}" 2>&1; then
    log "Note pushed to origin"
  else
    log_warning "Failed to push change source note - this is non-fatal (permissions may not allow it)"
  fi
}

main "$@"
