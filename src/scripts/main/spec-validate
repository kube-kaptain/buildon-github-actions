#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Spec Validate
#
# Validates substituted spec file against its schema. Run after docker build
# has performed token substitution.
#
# Inputs via env vars (required):
#   SPEC_TYPE         - Type of spec: "schema" or "api"
#   SPEC_SUB_PATH     - Directory containing spec files (relative)
#   SPEC_JSON         - File name of spec JSON file
#
# Inputs via env vars (optional):
#   SPEC_VALIDATION_TYPE - Validator: basic, python3-jsonschema (default: basic)

set -euo pipefail

SCRIPT_DIR="$(dirname "${0}")"

# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../defaults/platform.bash"

# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../lib/log.bash"

log "=== Spec Validate ==="

# Validate inputs
SPEC_TYPE="${SPEC_TYPE:?SPEC_TYPE is required}"
SPEC_SUB_PATH="${SPEC_SUB_PATH:?SPEC_SUB_PATH is required}"
SPEC_JSON="${SPEC_JSON:?SPEC_JSON is required}"
SPEC_VALIDATION_TYPE="${SPEC_VALIDATION_TYPE:-basic}"

# Validate SPEC_TYPE value
if [[ "${SPEC_TYPE}" != "schema" && "${SPEC_TYPE}" != "api" ]]; then
  log_error "SPEC_TYPE must be 'schema' or 'api'"
  exit 1
fi

# Validate spec file exists
spec_file="${SPEC_SUB_PATH}/${SPEC_JSON}"
if [[ ! -f "${spec_file}" ]]; then
  log_error "Spec file not found: ${spec_file}"
  exit 1
fi

validate_with_python() {
  log "Installing python3-jsonschema..."
  log "$(sudo apt-get update && sudo apt-get install -y python3-jsonschema 2>&1)"
  log "Validating with python3-jsonschema..."
  python3 -c "import json, jsonschema, urllib.request; jsonschema.validate(json.load(open('$1')), json.loads(urllib.request.urlopen('$2').read()))"
}

log "Type: ${SPEC_TYPE} | Validation: ${SPEC_VALIDATION_TYPE}"

# Determine schema URL
if [[ "${SPEC_TYPE}" == "api" ]]; then
  schema_url=$(jq -r '."$schema" // empty' "${spec_file}")
  if [[ -z "${schema_url}" ]]; then
    log_error "API spec must declare \$schema"
    exit 1
  fi
else
  schema_url="https://json-schema.org/draft-07/schema"
fi
log "Schema: ${schema_url}"

# Validate
case "${SPEC_VALIDATION_TYPE}" in
  basic) log "Basic validation: schema validation skipped" ;;
  python3-jsonschema) validate_with_python "${spec_file}" "${schema_url}" ;;
  *) log_error "Unknown SPEC_VALIDATION_TYPE: ${SPEC_VALIDATION_TYPE}"; exit 1 ;;
esac

log "Schema validation passed"
