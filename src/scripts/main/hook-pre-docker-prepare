#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# hook-pre-docker-prepare - Entry point for pre-docker-prepare hook
#
# Runs user's hook script before Docker build preparation.
# Use this hook to modify Dockerfile, copy files into docker context,
# or perform other preparation before the Docker image is built.
#
# Inputs (environment variables):
#   HOOK_SCRIPT_SUB_PATH - Path to user's hook script (set by CI wrapper)
#
# Available context (set by CI wrapper):
#   VERSION - Full version string
#   VERSION_MAJOR - Major version number
#   VERSION_MINOR - Minor version number
#   VERSION_PATCH - Patch version number
#   VERSION_2_PART - Version as 2 parts (e.g., 1.2)
#   VERSION_3_PART - Version as 3 parts (e.g., 1.2.3)
#   VERSION_4_PART - Version as 4 parts (e.g., 1.2.3.0)
#   DOCKER_TAG - Docker tag (version with optional -PRERELEASE suffix)
#   DOCKER_IMAGE_NAME - Docker image name
#   GIT_TAG - Git tag
#   PROJECT_NAME - Project name
#   IS_RELEASE - Whether this is a release build (true/false)
#   DOCKER_CONTEXT_SUB_PATH - Docker build context directory
#   ... and all workflow inputs
#
set -euo pipefail

# === Workflow Inputs ===
# Defaults for workflow inputs (match workflow input defaults)

# Build output
OUTPUT_SUB_PATH="${OUTPUT_SUB_PATH:-target}"
# Docker registry logins
DOCKER_REGISTRY_LOGINS="${DOCKER_REGISTRY_LOGINS:-}"
# Docker build options
DOCKERFILE_SUB_PATH="${DOCKERFILE_SUB_PATH:-src/docker}"
SQUASH="${SQUASH:-true}"
NO_CACHE="${NO_CACHE:-true}"
# Docker target config
DOCKER_TARGET_REGISTRY="${DOCKER_TARGET_REGISTRY:-ghcr.io}"
DOCKER_TARGET_BASE_PATH="${DOCKER_TARGET_BASE_PATH:-}"
# Docker push targets
DOCKER_PUSH_TARGETS="${DOCKER_PUSH_TARGETS:-}"
# Manifests source
MANIFESTS_SUB_PATH="${MANIFESTS_SUB_PATH:-src/kubernetes}"
# Manifests packaging
MANIFESTS_REPO_PROVIDER_TYPE="${MANIFESTS_REPO_PROVIDER_TYPE:-docker}"
MANIFESTS_PACKAGING_BASE_IMAGE="${MANIFESTS_PACKAGING_BASE_IMAGE:-}"
# Kubernetes Generation
KUBERNETES_GLOBAL_ADDITIONAL_LABELS="${KUBERNETES_GLOBAL_ADDITIONAL_LABELS:-}"
KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS="${KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS:-}"
# Kubernetes ConfigMap Generation
KUBERNETES_CONFIGMAP_SUB_PATH="${KUBERNETES_CONFIGMAP_SUB_PATH:-src/configmap}"
KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION="${KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION:-true}"
KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS="${KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS:-}"
KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS="${KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS:-}"
# Token substitution
SUBSTITUTION_TOKEN_STYLE="${SUBSTITUTION_TOKEN_STYLE:-shell}"
TOKEN_NAME_STYLE="${TOKEN_NAME_STYLE:-PascalCase}"
TOKEN_NAME_VALIDATION="${TOKEN_NAME_VALIDATION:-MATCH}"
ALLOW_BUILTIN_TOKEN_OVERRIDE="${ALLOW_BUILTIN_TOKEN_OVERRIDE:-false}"
CONFIG_SUB_PATH="${CONFIG_SUB_PATH:-src/config}"
CONFIG_VALUE_TRAILING_NEWLINE="${CONFIG_VALUE_TRAILING_NEWLINE:-strip-for-single-line}"
# Naming, Versions, and Tags calculation
RELEASE_BRANCH="${RELEASE_BRANCH:-main}"
ADDITIONAL_RELEASE_BRANCHES="${ADDITIONAL_RELEASE_BRANCHES:-}"
MAX_VERSION_PARTS="${MAX_VERSION_PARTS:-3}"
TAG_VERSION_CALCULATION_STRATEGY="${TAG_VERSION_CALCULATION_STRATEGY:-git-auto-closest-highest}"
TAG_VERSION_PATTERN_TYPE="${TAG_VERSION_PATTERN_TYPE:-dockerfile-env-kubectl}"
TAG_VERSION_PREFIX_PARTS="${TAG_VERSION_PREFIX_PARTS:-}"
TAG_VERSION_SOURCE_SUB_PATH="${TAG_VERSION_SOURCE_SUB_PATH:-}"
TAG_VERSION_SOURCE_FILE_NAME="${TAG_VERSION_SOURCE_FILE_NAME:-}"
TAG_VERSION_SOURCE_CUSTOM_PATTERN="${TAG_VERSION_SOURCE_CUSTOM_PATTERN:-}"
# Quality check options
BLOCK_SLASHES="${BLOCK_SLASHES:-false}"
BLOCK_SLASH_CONTAINING_BRANCHES="${BLOCK_SLASH_CONTAINING_BRANCHES:-false}"
BLOCK_DOUBLE_HYPHEN_CONTAINING_BRANCHES="${BLOCK_DOUBLE_HYPHEN_CONTAINING_BRANCHES:-true}"
REQUIRE_CONVENTIONAL_BRANCHES="${REQUIRE_CONVENTIONAL_BRANCHES:-false}"
REQUIRE_CONVENTIONAL_COMMITS="${REQUIRE_CONVENTIONAL_COMMITS:-false}"
BLOCK_CONVENTIONAL_COMMITS="${BLOCK_CONVENTIONAL_COMMITS:-false}"
# Hook script paths
PRE_TAGGING_TESTS_SCRIPT_SUB_PATH="${PRE_TAGGING_TESTS_SCRIPT_SUB_PATH:-}"
PRE_DOCKER_PREPARE_SCRIPT_SUB_PATH="${PRE_DOCKER_PREPARE_SCRIPT_SUB_PATH:-}"
POST_DOCKER_TESTS_SCRIPT_SUB_PATH="${POST_DOCKER_TESTS_SCRIPT_SUB_PATH:-}"
PRE_PACKAGE_PREPARE_SCRIPT_SUB_PATH="${PRE_PACKAGE_PREPARE_SCRIPT_SUB_PATH:-}"
POST_PACKAGE_TESTS_SCRIPT_SUB_PATH="${POST_PACKAGE_TESTS_SCRIPT_SUB_PATH:-}"
# GitHub release
GITHUB_RELEASE_ENABLED="${GITHUB_RELEASE_ENABLED:-true}"
GITHUB_RELEASE_SUBSTITUTED_FILES="${GITHUB_RELEASE_SUBSTITUTED_FILES:-}"
GITHUB_RELEASE_VERBATIM_FILES="${GITHUB_RELEASE_VERBATIM_FILES:-}"
GITHUB_RELEASE_NOTES="${GITHUB_RELEASE_NOTES:-}"
GITHUB_RELEASE_ADD_VERSION_TO_FILENAMES="${GITHUB_RELEASE_ADD_VERSION_TO_FILENAMES:-true}"

# Export all workflow inputs
export OUTPUT_SUB_PATH
export DOCKER_REGISTRY_LOGINS
export DOCKERFILE_SUB_PATH SQUASH NO_CACHE
export DOCKER_TARGET_REGISTRY DOCKER_TARGET_BASE_PATH
export DOCKER_PUSH_TARGETS
export MANIFESTS_SUB_PATH
export MANIFESTS_REPO_PROVIDER_TYPE MANIFESTS_PACKAGING_BASE_IMAGE
export KUBERNETES_GLOBAL_ADDITIONAL_LABELS KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS
export KUBERNETES_CONFIGMAP_SUB_PATH KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION
export KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS
export SUBSTITUTION_TOKEN_STYLE TOKEN_NAME_STYLE TOKEN_NAME_VALIDATION
export ALLOW_BUILTIN_TOKEN_OVERRIDE CONFIG_SUB_PATH CONFIG_VALUE_TRAILING_NEWLINE
export RELEASE_BRANCH ADDITIONAL_RELEASE_BRANCHES MAX_VERSION_PARTS
export TAG_VERSION_CALCULATION_STRATEGY TAG_VERSION_PATTERN_TYPE TAG_VERSION_PREFIX_PARTS
export TAG_VERSION_SOURCE_SUB_PATH TAG_VERSION_SOURCE_FILE_NAME TAG_VERSION_SOURCE_CUSTOM_PATTERN
export BLOCK_SLASHES BLOCK_SLASH_CONTAINING_BRANCHES BLOCK_DOUBLE_HYPHEN_CONTAINING_BRANCHES
export REQUIRE_CONVENTIONAL_BRANCHES REQUIRE_CONVENTIONAL_COMMITS BLOCK_CONVENTIONAL_COMMITS
export PRE_TAGGING_TESTS_SCRIPT_SUB_PATH PRE_DOCKER_PREPARE_SCRIPT_SUB_PATH POST_DOCKER_TESTS_SCRIPT_SUB_PATH
export PRE_PACKAGE_PREPARE_SCRIPT_SUB_PATH POST_PACKAGE_TESTS_SCRIPT_SUB_PATH
export GITHUB_RELEASE_ENABLED GITHUB_RELEASE_SUBSTITUTED_FILES GITHUB_RELEASE_VERBATIM_FILES
export GITHUB_RELEASE_NOTES GITHUB_RELEASE_ADD_VERSION_TO_FILENAMES

# === Step Outputs ===
# Required vars - version outputs from versions-and-naming step
: "${VERSION:?VERSION is required}"
: "${DOCKER_TAG:?DOCKER_TAG is required}"
: "${DOCKER_IMAGE_NAME:?DOCKER_IMAGE_NAME is required}"
: "${GIT_TAG:?GIT_TAG is required}"
: "${PROJECT_NAME:?PROJECT_NAME is required}"
: "${IS_RELEASE:?IS_RELEASE is required}"
# Docker outputs (computed path for this position)
: "${DOCKER_CONTEXT_SUB_PATH:?DOCKER_CONTEXT_SUB_PATH is required}"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=src/scripts/lib/hook-runner.bash
source "${SCRIPT_DIR}/../lib/hook-runner.bash"
