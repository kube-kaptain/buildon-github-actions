#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# docker-push-all - Pushes all Docker images from a registry file
#
# Reads image URIs from a file built up by earlier build/tag steps,
# then pushes each one. Continues pushing remaining images even if
# one fails, then reports failures and exits non-zero.
#
# Inputs (environment variables):
#   OUTPUT_SUB_PATH - Build output directory, relative (default: target)
#   IS_RELEASE      - "true" to push, "false" to skip (default: false)
#
# Outputs:
#   IMAGES_PUSHED - Number of images successfully pushed
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# shellcheck source=src/scripts/defaults/output-sub-path.bash
source "${SCRIPT_DIR}/../defaults/output-sub-path.bash"
# shellcheck source=src/scripts/defaults/image-build-command.bash
source "${SCRIPT_DIR}/../defaults/image-build-command.bash"

# Optional inputs with defaults
IS_RELEASE="${IS_RELEASE:-false}"

# Hardcoded relative to OUTPUT_SUB_PATH
IMAGES_TO_PUSH_FILE="${OUTPUT_SUB_PATH}/docker-push-all/image-uris"

output_var() {
  local name="${1}"
  local value="${2}"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "${GITHUB_OUTPUT}"
  fi
}

main() {
  echo "=== Docker Push All ===" >&2
  echo "Is Release: ${IS_RELEASE}" >&2
  echo "Image URIs file: ${IMAGES_TO_PUSH_FILE}" >&2
  echo "=======================" >&2

  if [[ "${IS_RELEASE}" != "true" ]]; then
    echo "Skipping push (IS_RELEASE=${IS_RELEASE})" >&2
    output_var "IMAGES_PUSHED" "0"
    return 0
  fi

  if [[ ! -f "${IMAGES_TO_PUSH_FILE}" ]]; then
    echo "${LOG_ERROR_PREFIX}Image URIs file not found: ${IMAGES_TO_PUSH_FILE}${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  if [[ ! -s "${IMAGES_TO_PUSH_FILE}" ]]; then
    echo "${LOG_ERROR_PREFIX}Image URIs file is empty: ${IMAGES_TO_PUSH_FILE}${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  echo "Images to push:" >&2
  cat "${IMAGES_TO_PUSH_FILE}" >&2
  echo "" >&2

  local pushed=0
  local failed=0
  local failed_uris=""

  while IFS= read -r image_uri; do
    # Skip blank lines
    [[ -z "${image_uri}" ]] && continue

    # Verify image exists locally before pushing
    if ! ${IMAGE_BUILD_COMMAND} image inspect "${image_uri}" &>/dev/null; then
      echo "${LOG_ERROR_PREFIX}Image not found locally: ${image_uri}${LOG_ERROR_SUFFIX}" >&2
      failed=$((failed + 1))
      failed_uris="${failed_uris}  ${image_uri} (not found locally)"$'\n'
      continue
    fi

    echo "Pushing: ${image_uri}" >&2
    if ${IMAGE_BUILD_COMMAND} push "${image_uri}"; then
      pushed=$((pushed + 1))
    else
      echo "${LOG_ERROR_PREFIX}Failed to push: ${image_uri}${LOG_ERROR_SUFFIX}" >&2
      failed=$((failed + 1))
      failed_uris="${failed_uris}  ${image_uri} (push failed)"$'\n'
    fi
  done < "${IMAGES_TO_PUSH_FILE}"

  output_var "IMAGES_PUSHED" "${pushed}"

  echo "" >&2
  echo "Docker Push All complete: ${pushed} pushed, ${failed} failed" >&2

  if [[ ${failed} -gt 0 ]]; then
    echo "" >&2
    echo "${LOG_ERROR_PREFIX}Failed images:${LOG_ERROR_SUFFIX}" >&2
    echo "${failed_uris}" >&2
    exit 1
  fi
}

main "$@"
