#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# docker-push-all - Pushes all Docker images from a registry file
#
# Reads image URIs from a file built up by earlier build/tag steps,
# then pushes each one. Continues pushing remaining images even if
# one fails, then reports failures and exits non-zero.
#
# Inputs (environment variables):
#   DOCKER_PUSH_IMAGE_LIST_FILE - Path to image URIs file (required, from docker-registry-logins)
#   IS_RELEASE      - "true" to push, "false" to skip (default: false)
#
# Outputs:
#   IMAGES_PUSHED - Number of images successfully pushed
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# shellcheck source=src/scripts/defaults/docker-push-image-list.bash
source "${SCRIPT_DIR}/../defaults/docker-push-image-list.bash"
# shellcheck source=src/scripts/defaults/docker-common.bash
source "${SCRIPT_DIR}/../defaults/docker-common.bash"
# shellcheck source=src/scripts/defaults/output-sub-path.bash
source "${SCRIPT_DIR}/../defaults/output-sub-path.bash"
# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../defaults/platform.bash"

# shellcheck source=src/scripts/lib/output-var.bash
source "${SCRIPT_DIR}/../lib/output-var.bash"
# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../lib/log.bash"

# Optional inputs with defaults
IS_RELEASE="${IS_RELEASE:-false}"

IMAGES_TO_PUSH_FILE="${DOCKER_PUSH_IMAGE_LIST_FILE}"

main() {
  log "=== Docker Push All ==="
  log "Is Release: ${IS_RELEASE}"
  log "Image URIs file: ${IMAGES_TO_PUSH_FILE}"
  log "======================="

  if [[ "${IS_RELEASE}" != "true" ]]; then
    log "Skipping push (IS_RELEASE=${IS_RELEASE})"
    output_var "IMAGES_PUSHED" "0"
    return 0
  fi

  if [[ ! -f "${IMAGES_TO_PUSH_FILE}" ]]; then
    log_error "Image URIs file not found: ${IMAGES_TO_PUSH_FILE}"
    exit 1
  fi

  if [[ ! -s "${IMAGES_TO_PUSH_FILE}" ]]; then
    log_error "Image URIs file is empty: ${IMAGES_TO_PUSH_FILE}"
    exit 1
  fi

  log "Images to push:"
  log "$(cat "${IMAGES_TO_PUSH_FILE}")"
  log ""

  local pushed=0
  local failed=0
  local failed_uris=""

  while IFS= read -r image_uri; do
    # Skip blank lines
    [[ -z "${image_uri}" ]] && continue

    # Verify image exists locally before pushing
    if ! ${IMAGE_BUILD_COMMAND} image inspect "${image_uri}" &>/dev/null; then
      log_error "Image not found locally: ${image_uri}"
      failed=$((failed + 1))
      failed_uris="${failed_uris}  ${image_uri} (not found locally)"$'\n'
      continue
    fi

    log "Pushing: ${image_uri}"
    if ${IMAGE_BUILD_COMMAND} push "${image_uri}"; then
      pushed=$((pushed + 1))
    else
      log_error "Failed to push: ${image_uri}"
      failed=$((failed + 1))
      failed_uris="${failed_uris}  ${image_uri} (push failed)"$'\n'
    fi
  done < "${IMAGES_TO_PUSH_FILE}"

  # === Manifest list handling ===
  # After all arch-specific images are pushed, create and push manifest lists
  local manifest_uris_file="${OUTPUT_SUB_PATH}/docker-push-all/manifest-uris"
  if [[ -f "${manifest_uris_file}" ]] && [[ -s "${manifest_uris_file}" ]]; then
    log ""
    log "=== Creating manifest lists ==="
    while IFS= read -r manifest_uri; do
      [[ -z "${manifest_uri}" ]] && continue

      local amd64_uri="${manifest_uri}-linux-amd64"
      local arm64_uri="${manifest_uri}-linux-arm64"

      log "Creating manifest: ${manifest_uri}"
      log "  amd64: ${amd64_uri}"
      log "  arm64: ${arm64_uri}"

      if ! ${IMAGE_BUILD_COMMAND} manifest create "${manifest_uri}" "${amd64_uri}" "${arm64_uri}"; then
        log_error "Failed to create manifest: ${manifest_uri}"
        failed=$((failed + 1))
        failed_uris="${failed_uris}  ${manifest_uri} (manifest create failed)"$'\n'
        continue
      fi

      log "Pushing manifest: ${manifest_uri}"
      if [[ "${IMAGE_BUILD_COMMAND}" == "podman" ]]; then
        if ${IMAGE_BUILD_COMMAND} manifest push --all "${manifest_uri}"; then
          pushed=$((pushed + 1))
        else
          log_error "Failed to push manifest: ${manifest_uri}"
          failed=$((failed + 1))
          failed_uris="${failed_uris}  ${manifest_uri} (manifest push failed)"$'\n'
        fi
      else
        if ${IMAGE_BUILD_COMMAND} manifest push "${manifest_uri}"; then
          pushed=$((pushed + 1))
        else
          log_error "Failed to push manifest: ${manifest_uri}"
          failed=$((failed + 1))
          failed_uris="${failed_uris}  ${manifest_uri} (manifest push failed)"$'\n'
        fi
      fi
    done < "${manifest_uris_file}"
  fi

  output_var "IMAGES_PUSHED" "${pushed}"

  log ""
  log "Docker Push All complete: ${pushed} pushed, ${failed} failed"

  if [[ ${failed} -gt 0 ]]; then
    log ""
    log_error "Failed images:"
    log "${failed_uris}"
    exit 1
  fi
}

main "$@"
