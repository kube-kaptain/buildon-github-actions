#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifest-transport - Selector script for manifest repo provider plugins
#
# Dispatches to the appropriate repo provider script based on TRANSPORT_TYPE.
# Available repo providers are discovered from plugins/kube-manifest-repo-providers/
#
# Inputs (environment variables):
#   TRANSPORT_TYPE - Type of transport to use (required, no default)
#                    Available: docker, github-release
#   All other env vars are passed through to the transport script
#
# Outputs:
#   All outputs from the selected transport script
#
set -euo pipefail

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# Locate script directory (where this selector lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGINS_DIR="$SCRIPT_DIR/../plugins"
REPO_PROVIDERS_DIR="$PLUGINS_DIR/kube-manifest-repo-providers"
SCRIPT_PREFIX="kubernetes-manifest-repo-provider-"

# List available repo providers (extract type from script name)
list_providers() {
  local providers=()
  if [[ -d "$REPO_PROVIDERS_DIR" ]]; then
    while IFS= read -r provider; do
      if [[ -x "$provider" ]]; then
        local name
        name=$(basename "$provider")
        # Strip prefix to get the transport type
        providers+=("${name#$SCRIPT_PREFIX}")
      fi
    done < <(find "$REPO_PROVIDERS_DIR" -maxdepth 1 -type f -name "${SCRIPT_PREFIX}*")
  fi
  echo "${providers[*]}"
}

main() {
  # Require TRANSPORT_TYPE
  if [[ -z "${TRANSPORT_TYPE:-}" ]]; then
    local available
    available=$(list_providers)
    echo "${LOG_ERROR_PREFIX}TRANSPORT_TYPE is required. Available: $available${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Check repo provider script exists
  local provider_script="$REPO_PROVIDERS_DIR/${SCRIPT_PREFIX}${TRANSPORT_TYPE}"
  if [[ ! -f "$provider_script" ]]; then
    local available
    available=$(list_providers)
    echo "${LOG_ERROR_PREFIX}Unknown transport type: $TRANSPORT_TYPE. Available: $available${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  if [[ ! -x "$provider_script" ]]; then
    echo "${LOG_ERROR_PREFIX}Repo provider script not executable: $provider_script${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  echo "=== Kubernetes Manifest Repo Provider ===" >&2
  echo "Selected repo provider: $TRANSPORT_TYPE" >&2
  echo "==========================================" >&2

  # Execute repo provider script
  exec "$provider_script" "$@"
}

main "$@"
