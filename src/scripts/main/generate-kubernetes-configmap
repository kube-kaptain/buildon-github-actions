#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Dedicated to Michael McCallum (@stickycode) - inspired by his project kuuty-maven-plugin
#
# generate-kubernetes-configmap - Generates a Kubernetes ConfigMap from files
#
# Reads files from a directory and produces a ConfigMap YAML manifest with
# each file becoming a data entry (filename → key, content → value).
#
# Inputs (environment variables):
#   KUBERNETES_CONFIGMAP_NAME_SUFFIX - Optional suffix for name/filename (default: empty)
#   KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH - Sub-path within combined/ for output (default: empty)
#   KUBERNETES_CONFIGMAP_SUB_PATH - Source directory (default: src/configmap or src/configmap-${suffix})
#   OUTPUT_SUB_PATH            - Build output directory (default: target)
#   PROJECT_NAME               - Used in metadata.name (required)
#   TOKEN_NAME_STYLE           - Style for token references (default: PascalCase)
#   TOKEN_DELIMITER_STYLE   - Delimiter style for tokens (default: shell)
#   KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION - Enable checksum injection suffix in name (default: true)
#   KUBERNETES_GLOBAL_ADDITIONAL_LABELS      - Extra labels for all manifests (comma-separated key=value)
#   KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS - Extra annotations for all manifests
#   KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS   - ConfigMap-specific extra labels
#   KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS - ConfigMap-specific extra annotations
#
# Output:
#   ${OUTPUT_SUB_PATH}/manifests/combined/[${combined-sub-path}/]configmap[-${suffix}].yaml
#
# metadata.name pattern:
#   ${ProjectName}[-${combined-sub-path}][-${suffix}][-configmap-checksum]
#
set -euo pipefail

# Locate script directory for libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Source libraries
# shellcheck source=src/scripts/lib/token-format.bash
source "${LIB_DIR}/token-format.bash"
# shellcheck source=src/scripts/lib/kubernetes-metadata.bash
source "${LIB_DIR}/kubernetes-metadata.bash"

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# Inputs with defaults
KUBERNETES_CONFIGMAP_NAME_SUFFIX="${KUBERNETES_CONFIGMAP_NAME_SUFFIX:-}"
KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH="${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH:-}"
default_configmap_sub_path="src/configmap${KUBERNETES_CONFIGMAP_NAME_SUFFIX:+-${KUBERNETES_CONFIGMAP_NAME_SUFFIX}}"
KUBERNETES_CONFIGMAP_SUB_PATH="${KUBERNETES_CONFIGMAP_SUB_PATH:-${default_configmap_sub_path}}"
OUTPUT_SUB_PATH="${OUTPUT_SUB_PATH:-target}"
TOKEN_NAME_STYLE="${TOKEN_NAME_STYLE:-PascalCase}"
TOKEN_DELIMITER_STYLE="${TOKEN_DELIMITER_STYLE:-shell}"
KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION="${KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION:-true}"

# Validate styles upfront
if ! is_valid_token_name_style "${TOKEN_NAME_STYLE}"; then
  echo "${LOG_ERROR_PREFIX}Unknown token name style: ${TOKEN_NAME_STYLE}${LOG_ERROR_SUFFIX}" >&2
  exit 2
fi

if ! is_valid_substitution_token_style "${TOKEN_DELIMITER_STYLE}"; then
  echo "${LOG_ERROR_PREFIX}Unknown substitution token style: ${TOKEN_DELIMITER_STYLE}${LOG_ERROR_SUFFIX}" >&2
  exit 3
fi

if [[ "${KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION}" != "true" && "${KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION}" != "false" ]]; then
  echo "${LOG_ERROR_PREFIX}KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION must be 'true' or 'false', got: ${KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION}${LOG_ERROR_SUFFIX}" >&2
  exit 4
fi

# Validate combined sub-path (only lowercase letters, digits, hyphens, slashes allowed; no leading/trailing slashes)
if [[ -n "${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH}" ]]; then
  if [[ ! "${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH}" =~ ^[a-z0-9/-]+$ ]]; then
    echo "${LOG_ERROR_PREFIX}KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH must contain only lowercase letters, digits, hyphens, and slashes, got: ${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH}${LOG_ERROR_SUFFIX}" >&2
    exit 5
  fi
  if [[ "${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH}" == /* || "${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH}" == */ ]]; then
    echo "${LOG_ERROR_PREFIX}KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH must not start or end with a slash, got: ${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH}${LOG_ERROR_SUFFIX}" >&2
    exit 6
  fi
fi

# Check if source directory exists
if [[ ! -d "${KUBERNETES_CONFIGMAP_SUB_PATH}" ]]; then
  echo "ConfigMap source directory '${KUBERNETES_CONFIGMAP_SUB_PATH}' not found, skipping ConfigMap generation" >&2
  exit 0
fi

# Check if directory has files (excluding dotfiles)
file_count=$(find "${KUBERNETES_CONFIGMAP_SUB_PATH}" -type f -not -name '.*' 2>/dev/null | wc -l | tr -d ' ')
if [[ "${file_count}" -eq 0 ]]; then
  echo "${LOG_ERROR_PREFIX}No files found (excluding dotfiles) in ConfigMap source directory '${KUBERNETES_CONFIGMAP_SUB_PATH}'${LOG_ERROR_SUFFIX}" >&2
  exit 7
fi

# Generate token references
project_name_token=$(format_canonical_token "${TOKEN_DELIMITER_STYLE}" "${TOKEN_NAME_STYLE}" "PROJECT_NAME")
environment_token=$(format_canonical_token "${TOKEN_DELIMITER_STYLE}" "${TOKEN_NAME_STYLE}" "ENVIRONMENT")
version_token=$(format_canonical_token "${TOKEN_DELIMITER_STYLE}" "${TOKEN_NAME_STYLE}" "VERSION")

# Build metadata.name: ${ProjectName}[-${combined}][-${suffix}][-configmap-checksum]
# For nested paths like omg/wtf, replace / with - to get omg-wtf
name_middle=""
if [[ -n "${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH}" ]]; then
  combined_name_fragment="${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH//\//-}"
  name_middle="-${combined_name_fragment}"
fi
if [[ -n "${KUBERNETES_CONFIGMAP_NAME_SUFFIX}" ]]; then
  name_middle="${name_middle}-${KUBERNETES_CONFIGMAP_NAME_SUFFIX}"
fi

if [[ "${KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION}" == "true" ]]; then
  configmap_name="${project_name_token}${name_middle}-configmap-checksum"
else
  configmap_name="${project_name_token}${name_middle}"
fi

# Create output directory (include combined sub-path if provided)
if [[ -n "${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH}" ]]; then
  output_dir="${OUTPUT_SUB_PATH}/manifests/combined/${KUBERNETES_CONFIGMAP_COMBINED_SUB_PATH}"
else
  output_dir="${OUTPUT_SUB_PATH}/manifests/combined"
fi
mkdir -p "${output_dir}"

# Generate ConfigMap YAML (include suffix in filename if provided)
if [[ -n "${KUBERNETES_CONFIGMAP_NAME_SUFFIX}" ]]; then
  output_file="${output_dir}/configmap-${KUBERNETES_CONFIGMAP_NAME_SUFFIX}.yaml"
else
  output_file="${output_dir}/configmap.yaml"
fi

# Get current timestamp and script name for annotations
build_timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
script_name=$(basename "${BASH_SOURCE[0]}")

# Build labels: builtin < global < resource-specific
builtin_labels="app=${project_name_token},app.kubernetes.io/name=${project_name_token},app.kubernetes.io/version=${version_token},app.kubernetes.io/managed-by=kaptain"
merged_labels=$(merge_key_value_pairs "${builtin_labels}" "${KUBERNETES_GLOBAL_ADDITIONAL_LABELS:-}")
merged_labels=$(merge_key_value_pairs "${merged_labels}" "${KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS:-}")

# Build annotations: builtin < global < resource-specific
builtin_annotations="kaptain/project-name=${project_name_token},kaptain/version=${version_token},kaptain/build-timestamp=\"${build_timestamp}\",kaptain/generated-by=\"Generated by Kaptain ${script_name} feature\""
merged_annotations=$(merge_key_value_pairs "${builtin_annotations}" "${KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS:-}")
merged_annotations=$(merge_key_value_pairs "${merged_annotations}" "${KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS:-}")

{
  generate_manifest_header "v1" "ConfigMap" "${configmap_name}" "${environment_token}"
  generate_metadata_map "labels" "${merged_labels}"
  generate_metadata_map "annotations" "${merged_annotations}"
  echo "data:"

  # Add each file as a data entry (excluding dotfiles)
  while IFS= read -r -d '' filepath; do
    filename=$(basename "${filepath}")
    # Use block scalar for content to preserve formatting
    echo "  ${filename}: |"
    # Indent each line of content by 4 spaces
    while IFS= read -r line || [[ -n "${line}" ]]; do
      echo "    ${line}"
    done < "${filepath}"
  done < <(find "${KUBERNETES_CONFIGMAP_SUB_PATH}" -type f -not -name '.*' -print0 | sort -z)

} > "${output_file}"

echo "Generated ConfigMap manifest: ${output_file}" >&2
echo "  Files included: ${file_count}" >&2
