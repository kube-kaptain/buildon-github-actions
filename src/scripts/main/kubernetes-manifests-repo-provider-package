#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-repo-provider-package - Selector script for manifests repo provider package plugins
#
# Dispatches to the appropriate repo provider package script based on MANIFESTS_REPO_PROVIDER_TYPE.
# This packages manifests for the repo provider (e.g., builds docker image) but does NOT publish.
# Available repo providers are discovered from plugins/kubernetes-manifests-repo-providers/
#
# Inputs (environment variables):
#   MANIFESTS_REPO_PROVIDER_TYPE - Type of repo provider to use (default: docker)
#   All other env vars are passed through to the package script
#
# Outputs:
#   All outputs from the selected package script
#
set -euo pipefail

# Locate script directory (where this selector lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# shellcheck source=src/scripts/defaults/manifests-repo-provider.bash
source "${SCRIPT_DIR}/../defaults/manifests-repo-provider.bash"
# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../defaults/platform.bash"

# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../lib/log.bash"

PLUGINS_DIR="${SCRIPT_DIR}/../plugins"
REPO_PROVIDERS_DIR="${PLUGINS_DIR}/kubernetes-manifests-repo-providers"
SCRIPT_PREFIX="kubernetes-manifests-repo-provider-"
SCRIPT_SUFFIX="-package"

# List available repo providers (extract type from script name)
list_providers() {
  local providers=()
  if [[ -d "${REPO_PROVIDERS_DIR}" ]]; then
    while IFS= read -r provider; do
      if [[ -x "${provider}" ]]; then
        local name
        name=$(basename "${provider}")
        # Strip prefix and suffix to get the provider type
        name="${name#"${SCRIPT_PREFIX}"}"
        name="${name%"${SCRIPT_SUFFIX}"}"
        providers+=("${name}")
      fi
    done < <(find "${REPO_PROVIDERS_DIR}" -maxdepth 1 -type f -name "${SCRIPT_PREFIX}*${SCRIPT_SUFFIX}")
  fi
  echo "${providers[*]}"
}

main() {
  # Check repo provider script exists
  local provider_script="${REPO_PROVIDERS_DIR}/${SCRIPT_PREFIX}${MANIFESTS_REPO_PROVIDER_TYPE}${SCRIPT_SUFFIX}"
  if [[ ! -f "${provider_script}" ]]; then
    local available
    available=$(list_providers)
    log_error "Unknown repo provider type: ${MANIFESTS_REPO_PROVIDER_TYPE}. Available: ${available}"
    exit 2
  fi

  if [[ ! -x "${provider_script}" ]]; then
    log_error "Repo provider script not executable: ${provider_script}"
    exit 3
  fi

  log "=== Kubernetes Manifests Repo Provider Package ==="
  log "Selected repo provider: ${MANIFESTS_REPO_PROVIDER_TYPE}"
  log "==================================================="

  # Execute repo provider script
  exec "${provider_script}" "$@"
}

main "$@"
