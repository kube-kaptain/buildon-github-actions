#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# validate-tooling - Validates required tools are available before build
#
# Checks for required command-line tools:
# - Core tools: Always required, fails if missing (git, awk, etc.)
# - Container runtime: podman required on build_server (symlink created), docker or podman locally
# - Build server tools: Warns if missing (some have fallbacks)
# - Cloud CLIs: Warns if missing (only needed for specific registry logins)
#
set -euo pipefail

SCRIPT_DIR="$(dirname "${0}")"

# shellcheck source=src/scripts/defaults/build-mode.bash
source "${SCRIPT_DIR}/../defaults/build-mode.bash"
# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../defaults/platform.bash"

# shellcheck source=src/scripts/lib/output-var.bash
source "${SCRIPT_DIR}/../lib/output-var.bash"
# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../lib/log.bash"

# Tool categories
CORE_TOOLS="git awk grep find tr wc cmp cp mkdir basename zip date uname"
BUILD_SERVER_TOOLS="sudo systemctl jq yq"
CLOUD_TOOLS="aws az gcloud"

# Track missing tools
MISSING_CORE=""
MISSING_BUILD_SERVER=""
MISSING_CLOUD=""

check_tool() {
  local tool="${1}"
  command -v "${tool}" &>/dev/null
}

log "Validating tooling for BUILD_MODE=${BUILD_MODE}"
log ""

# Check core tools (always required)
log "Checking core tools..."
for tool in ${CORE_TOOLS}; do
  if check_tool "${tool}"; then
    log "  ✓ ${tool}"
  else
    log "  ✗ ${tool}"
    MISSING_CORE="${MISSING_CORE} ${tool}"
  fi
done
log ""

# Check container runtime
log "Checking container runtime..."
IMAGE_BUILD_COMMAND=""
HAS_PODMAN=false
HAS_DOCKER=false
if check_tool "podman"; then
  HAS_PODMAN=true
  log "  ✓ podman"
else
  log "  - podman (not found)"
fi
if check_tool "docker"; then
  HAS_DOCKER=true
  log "  ✓ docker"
else
  log "  - docker (not found)"
fi

if [[ "${BUILD_MODE}" == "build_server" ]]; then
  if [[ "${HAS_PODMAN}" != "true" ]]; then
    log_error "podman is required on build server but not found"
    MISSING_CORE="${MISSING_CORE} podman"
  else
    IMAGE_BUILD_COMMAND="podman"
    log "  Creating docker -> podman symlink for hook script compatibility"
    sudo ln -sf "$(command -v podman)" /usr/local/bin/docker
    if ! check_tool "docker"; then
      log_error "docker symlink creation failed"
      MISSING_CORE="${MISSING_CORE} docker-symlink"
    else
      log "  ✓ docker symlink verified"
    fi
  fi
else
  # Local mode - accept either, no symlink
  if [[ "${HAS_PODMAN}" == "true" ]]; then
    IMAGE_BUILD_COMMAND="podman"
    log_warning "Using podman locally - hook scripts targeting 'docker' command will not work, use 'podman' in hook scripts"
  elif [[ "${HAS_DOCKER}" == "true" ]]; then
    IMAGE_BUILD_COMMAND="docker"
    log_warning "Using docker locally - squash will be disabled (podman required for squash support)"
  else
    log_error "No container runtime found - install podman or docker"
    MISSING_CORE="${MISSING_CORE} podman/docker"
  fi
fi

if [[ -n "${IMAGE_BUILD_COMMAND}" ]]; then
  log "  → IMAGE_BUILD_COMMAND=${IMAGE_BUILD_COMMAND}"
fi
log ""

# Check build server tools (warn only - some have fallbacks)
log "Checking build server tools..."
for tool in ${BUILD_SERVER_TOOLS}; do
  if check_tool "${tool}"; then
    log "  ✓ ${tool}"
  else
    log "  - ${tool} (not found)"
    MISSING_BUILD_SERVER="${MISSING_BUILD_SERVER} ${tool}"
  fi
done
log ""

# Check cloud CLIs (warn only)
log "Checking cloud CLIs (optional)..."
for tool in ${CLOUD_TOOLS}; do
  if check_tool "${tool}"; then
    log "  ✓ ${tool}"
  else
    log "  - ${tool} (not found)"
    MISSING_CLOUD="${MISSING_CLOUD} ${tool}"
  fi
done
log ""

# Report results
EXIT_CODE=0

if [[ -n "${MISSING_CORE}" ]]; then
  log_error "Missing required core tools:${MISSING_CORE}"
  EXIT_CODE=1
fi

if [[ -n "${MISSING_BUILD_SERVER}" ]]; then
  log_warning "Missing build server tools (some have fallbacks):${MISSING_BUILD_SERVER}"
  # Not a failure - these tools have fallbacks or are only needed for specific features
fi

if [[ -n "${MISSING_CLOUD}" ]]; then
  log_warning "Missing cloud CLIs (needed for specific registry logins):${MISSING_CLOUD}"
  # Not a failure - cloud tools are optional
fi

if [[ ${EXIT_CODE} -eq 0 ]]; then
  log "All required tools available!"
fi

if [[ -n "${IMAGE_BUILD_COMMAND}" ]]; then
  output_var "IMAGE_BUILD_COMMAND" "${IMAGE_BUILD_COMMAND}"
fi

exit ${EXIT_CODE}
