#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# docker-multi-tag - Tags a Docker image for multiple registries
#
# Inputs (environment variables):
#   DOCKER_IMAGE_FULL_URI - Full URI of image to tag from (required)
#   DOCKER_IMAGE_NAME     - Image name portion (required)
#   DOCKER_TAG            - Tag for images (required)
#   DOCKER_PUSH_TARGETS   - JSON array of targets [{registry, base-path?}] (required)
#
# Each target in the JSON array:
#   registry  - Target registry (required)
#   base-path - Optional base path within registry
#
# Outputs:
#   IMAGES_TAGGED - Number of images tagged
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# shellcheck source=src/scripts/defaults/output-sub-path.bash
source "${SCRIPT_DIR}/../defaults/output-sub-path.bash"
# shellcheck source=src/scripts/defaults/docker-build.bash
source "${SCRIPT_DIR}/../defaults/docker-build.bash"

# Validate required inputs
if [[ -z "${DOCKER_IMAGE_FULL_URI:-}" ]]; then
  echo "DOCKER_IMAGE_FULL_URI is required" >&2
  exit 1
fi
if [[ -z "${DOCKER_IMAGE_NAME:-}" ]]; then
  echo "DOCKER_IMAGE_NAME is required" >&2
  exit 1
fi
if [[ -z "${DOCKER_TAG:-}" ]]; then
  echo "DOCKER_TAG is required" >&2
  exit 1
fi
if [[ -z "${DOCKER_PUSH_TARGETS}" ]]; then
  echo "DOCKER_PUSH_TARGETS is required" >&2
  exit 1
fi

# Output variable for GitHub Actions
output_var() {
  local name="${1}"
  local value="${2}"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "${GITHUB_OUTPUT}"
  fi
}

# Build full image URI from components
build_image_uri() {
  local registry="${1}"
  local base_path="${2}"
  local image_name="${3}"
  local tag="${4}"

  if [[ -n "${base_path}" ]]; then
    echo "${registry}/${base_path}/${image_name}:${tag}"
  else
    echo "${registry}/${image_name}:${tag}"
  fi
}

main() {
  echo "=== Docker Multi-Tag ===" >&2
  echo "Source image: ${DOCKER_IMAGE_FULL_URI}" >&2
  echo "Image name: ${DOCKER_IMAGE_NAME}" >&2
  echo "Tag: ${DOCKER_TAG}" >&2
  echo "========================" >&2

  # Validate JSON before processing
  if ! echo "${DOCKER_PUSH_TARGETS}" | jq -e 'type == "array"' > /dev/null 2>&1; then
    echo "${LOG_ERROR_PREFIX:-}DOCKER_PUSH_TARGETS must be a valid JSON array${LOG_ERROR_SUFFIX:-}" >&2
    exit 1
  fi

  local count=0

  # Parse JSON and iterate over targets
  while IFS= read -r target; do
    local registry base_path target_uri

    registry=$(echo "${target}" | jq -r '.registry')
    base_path=$(echo "${target}" | jq -r '.["base-path"] // ""')

    # Validate registry is present
    if [[ -z "${registry}" ]] || [[ "${registry}" == "null" ]]; then
      echo "${LOG_ERROR_PREFIX:-}Push target missing required 'registry' field${LOG_ERROR_SUFFIX:-}" >&2
      exit 1
    fi

    target_uri=$(build_image_uri "${registry}" "${base_path}" "${DOCKER_IMAGE_NAME}" "${DOCKER_TAG}")

    echo "Tagging: ${DOCKER_IMAGE_FULL_URI} -> ${target_uri}" >&2
    docker tag "${DOCKER_IMAGE_FULL_URI}" "${target_uri}"

    # Register image for consolidated push
    mkdir -p "${OUTPUT_SUB_PATH}/docker-push-all"
    echo "${target_uri}" >> "${OUTPUT_SUB_PATH}/docker-push-all/image-uris"

    count=$((count + 1))
  done < <(echo "${DOCKER_PUSH_TARGETS}" | jq -c '.[]')

  output_var "IMAGES_TAGGED" "${count}"

  echo "" >&2
  echo "Docker Multi-Tag complete: ${count} image(s) tagged" >&2
}

main "$@"
