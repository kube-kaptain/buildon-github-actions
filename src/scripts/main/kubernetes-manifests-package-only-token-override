#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-package-only-token-override - Manages docker image tokens for manifests-only workflow
#
# If override values provided: overwrites token files with those values.
# If override values empty: removes token files so variables remain in output for later substitution.
#
# Used in manifests-only workflow between prepare and package steps.
#
# Inputs (environment variables):
#   DOCKER_IMAGE_NAME_OVERRIDE - Override value for docker image name (optional)
#   DOCKER_TAG_OVERRIDE        - Override value for docker tag (optional)
#   OUTPUT_SUB_PATH            - Build output directory, relative (default: target)
#   TOKEN_NAME_STYLE           - Case style for token names (default: PascalCase)
#
set -euo pipefail

# Locate script directory for libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Source the token formatting library
# shellcheck source=src/scripts/lib/token-format.bash
source "${LIB_DIR}/token-format.bash"

# Optional inputs
DOCKER_IMAGE_NAME_OVERRIDE="${DOCKER_IMAGE_NAME_OVERRIDE:-}"
DOCKER_TAG_OVERRIDE="${DOCKER_TAG_OVERRIDE:-}"

# shellcheck source=src/scripts/defaults/output-sub-path.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/output-sub-path.bash"
# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../defaults/platform.bash"
# shellcheck source=src/scripts/defaults/tokens.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/tokens.bash"

# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../lib/log.bash"

# Config directory (where tokens are stored)
MANIFESTS_CONFIG_SUB_PATH="${OUTPUT_SUB_PATH}/manifests/config"

main() {
  log "=== Manifests-Only Token Override ==="
  log "Config: ${MANIFESTS_CONFIG_SUB_PATH}"
  log "Token style: ${TOKEN_NAME_STYLE}"
  log "======================================"

  # Validate config directory exists
  if [[ ! -d "${MANIFESTS_CONFIG_SUB_PATH}" ]]; then
    log_error "Config directory not found: ${MANIFESTS_CONFIG_SUB_PATH}"
    log_error "Did kubernetes-manifests-package-prepare run first?"
    exit 1
  fi

  # Convert token names to target style
  local image_name_token tag_token
  image_name_token=$(convert_token_name "${TOKEN_NAME_STYLE}" "DOCKER_IMAGE_NAME")
  tag_token=$(convert_token_name "${TOKEN_NAME_STYLE}" "DOCKER_TAG")

  # Handle image name token
  if [[ -n "${DOCKER_IMAGE_NAME_OVERRIDE}" ]]; then
    log "Overwriting ${image_name_token}: ${DOCKER_IMAGE_NAME_OVERRIDE}"
    printf '%s' "${DOCKER_IMAGE_NAME_OVERRIDE}" > "${MANIFESTS_CONFIG_SUB_PATH}/${image_name_token}"
  else
    log "Removing ${image_name_token} (variable will remain in output)"
    rm -f "${MANIFESTS_CONFIG_SUB_PATH}/${image_name_token}"
  fi

  # Handle tag token
  if [[ -n "${DOCKER_TAG_OVERRIDE}" ]]; then
    log "Overwriting ${tag_token}: ${DOCKER_TAG_OVERRIDE}"
    printf '%s' "${DOCKER_TAG_OVERRIDE}" > "${MANIFESTS_CONFIG_SUB_PATH}/${tag_token}"
  else
    log "Removing ${tag_token} (variable will remain in output)"
    rm -f "${MANIFESTS_CONFIG_SUB_PATH}/${tag_token}"
  fi

  log "=== Override Complete ==="
}

main "$@"
