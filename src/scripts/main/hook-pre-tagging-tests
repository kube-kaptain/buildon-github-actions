#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# hook-pre-tagging-tests - Entry point for pre-tagging-tests hook
#
# Runs user's hook script before tagging/versioning occurs.
# Use this hook for custom validation or preparation before version is determined.
#
# IMPORTANT: This hook runs BEFORE versions-and-naming, so version information
# is NOT available. Only workflow inputs (paths, config) are available here.
#
# Inputs (environment variables):
#   HOOK_SCRIPT_SUB_PATH - Path to user's hook script (set by CI wrapper)
#
# Available context (set by CI wrapper - all workflow inputs):
#   OUTPUT_SUB_PATH - Build output directory (default: target)
#   DOCKERFILE_SUB_PATH - Docker source directory (default: src/docker)
#   MANIFESTS_SUB_PATH - Manifests source directory (default: src/kubernetes)
#   CONFIG_SUB_PATH - Config files directory (default: src/config)
#   TOKEN_NAME_STYLE - Token name style (default: PascalCase)
#   TOKEN_DELIMITER_STYLE - Token delimiter syntax (default: shell)
#   ... and all other workflow inputs
#
# NOT available at this lifecycle point:
#   VERSION, VERSION_MAJOR, VERSION_MINOR, VERSION_PATCH
#   VERSION_2_PART, VERSION_3_PART, VERSION_4_PART
#   DOCKER_TAG, DOCKER_IMAGE_NAME, GIT_TAG, PROJECT_NAME, IS_RELEASE
#
set -euo pipefail

# === Workflow Inputs ===
# Defaults for workflow inputs (match workflow input defaults)

# Build output
OUTPUT_SUB_PATH="${OUTPUT_SUB_PATH:-target}"
# Docker registry logins
DOCKER_REGISTRY_LOGINS="${DOCKER_REGISTRY_LOGINS:-}"
# shellcheck source=src/scripts/defaults/dockerfile.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/dockerfile.bash"
# Docker push targets
DOCKER_PUSH_TARGETS="${DOCKER_PUSH_TARGETS:-}"
# Manifests source
MANIFESTS_SUB_PATH="${MANIFESTS_SUB_PATH:-src/kubernetes}"
# Manifests packaging
MANIFESTS_REPO_PROVIDER_TYPE="${MANIFESTS_REPO_PROVIDER_TYPE:-docker}"
MANIFESTS_PACKAGING_BASE_IMAGE="${MANIFESTS_PACKAGING_BASE_IMAGE:-}"
# Kubernetes Generation
KUBERNETES_GLOBAL_ADDITIONAL_LABELS="${KUBERNETES_GLOBAL_ADDITIONAL_LABELS:-}"
KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS="${KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS:-}"
# Kubernetes ConfigMap Generation
KUBERNETES_CONFIGMAP_SUB_PATH="${KUBERNETES_CONFIGMAP_SUB_PATH:-src/configmap}"
KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION="${KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION:-true}"
KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS="${KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS:-}"
KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS="${KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS:-}"
# Kubernetes secret template generation
KUBERNETES_SECRET_TEMPLATE_SUB_PATH="${KUBERNETES_SECRET_TEMPLATE_SUB_PATH:-src/secret.template}"
KUBERNETES_SECRET_TEMPLATE_NAME_CHECKSUM_INJECTION="${KUBERNETES_SECRET_TEMPLATE_NAME_CHECKSUM_INJECTION:-true}"
KUBERNETES_SECRET_TEMPLATE_ADDITIONAL_LABELS="${KUBERNETES_SECRET_TEMPLATE_ADDITIONAL_LABELS:-}"
KUBERNETES_SECRET_TEMPLATE_ADDITIONAL_ANNOTATIONS="${KUBERNETES_SECRET_TEMPLATE_ADDITIONAL_ANNOTATIONS:-}"
# Token substitution
# shellcheck source=src/scripts/defaults/tokens.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/tokens.bash"
# Naming, Versions, and Tags calculation
RELEASE_BRANCH="${RELEASE_BRANCH:-main}"
ADDITIONAL_RELEASE_BRANCHES="${ADDITIONAL_RELEASE_BRANCHES:-}"
# shellcheck source=src/scripts/defaults/tag-versioning.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/tag-versioning.bash"
# shellcheck source=src/scripts/defaults/quality-checks.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/quality-checks.bash"
# shellcheck source=src/scripts/defaults/hooks-leftovers.bash
source "$(dirname "${BASH_SOURCE[0]}")/../defaults/hooks-leftovers.bash"
# Hook script paths
HOOK_PRE_TAGGING_TESTS_SCRIPT_SUB_PATH="${HOOK_PRE_TAGGING_TESTS_SCRIPT_SUB_PATH:-}"
HOOK_PRE_DOCKER_PREPARE_SCRIPT_SUB_PATH="${HOOK_PRE_DOCKER_PREPARE_SCRIPT_SUB_PATH:-}"
HOOK_POST_DOCKER_TESTS_SCRIPT_SUB_PATH="${HOOK_POST_DOCKER_TESTS_SCRIPT_SUB_PATH:-}"
HOOK_PRE_PACKAGE_PREPARE_SCRIPT_SUB_PATH="${HOOK_PRE_PACKAGE_PREPARE_SCRIPT_SUB_PATH:-}"
HOOK_POST_PACKAGE_TESTS_SCRIPT_SUB_PATH="${HOOK_POST_PACKAGE_TESTS_SCRIPT_SUB_PATH:-}"
# GitHub release
GITHUB_RELEASE_ENABLED="${GITHUB_RELEASE_ENABLED:-true}"
GITHUB_RELEASE_SUBSTITUTED_FILES="${GITHUB_RELEASE_SUBSTITUTED_FILES:-}"
GITHUB_RELEASE_VERBATIM_FILES="${GITHUB_RELEASE_VERBATIM_FILES:-}"
GITHUB_RELEASE_NOTES="${GITHUB_RELEASE_NOTES:-}"
GITHUB_RELEASE_ADD_VERSION_TO_FILENAMES="${GITHUB_RELEASE_ADD_VERSION_TO_FILENAMES:-true}"

# Export all workflow inputs
export OUTPUT_SUB_PATH
export DOCKER_REGISTRY_LOGINS
export DOCKERFILE_SUB_PATH DOCKERFILE_SQUASH DOCKERFILE_NO_CACHE
export DOCKER_TARGET_REGISTRY DOCKER_TARGET_BASE_PATH
export DOCKER_PUSH_TARGETS
export MANIFESTS_SUB_PATH
export MANIFESTS_REPO_PROVIDER_TYPE MANIFESTS_PACKAGING_BASE_IMAGE
export KUBERNETES_GLOBAL_ADDITIONAL_LABELS KUBERNETES_GLOBAL_ADDITIONAL_ANNOTATIONS
export KUBERNETES_CONFIGMAP_SUB_PATH KUBERNETES_CONFIGMAP_NAME_CHECKSUM_INJECTION
export KUBERNETES_CONFIGMAP_ADDITIONAL_LABELS KUBERNETES_CONFIGMAP_ADDITIONAL_ANNOTATIONS
export KUBERNETES_SECRET_TEMPLATE_SUB_PATH KUBERNETES_SECRET_TEMPLATE_NAME_CHECKSUM_INJECTION
export KUBERNETES_SECRET_TEMPLATE_ADDITIONAL_LABELS KUBERNETES_SECRET_TEMPLATE_ADDITIONAL_ANNOTATIONS
export TOKEN_DELIMITER_STYLE TOKEN_NAME_STYLE TOKEN_NAME_VALIDATION
export ALLOW_BUILTIN_TOKEN_OVERRIDE CONFIG_SUB_PATH CONFIG_VALUE_TRAILING_NEWLINE
export RELEASE_BRANCH ADDITIONAL_RELEASE_BRANCHES TAG_VERSION_MAX_PARTS
export TAG_VERSION_CALCULATION_STRATEGY TAG_VERSION_PATTERN_TYPE TAG_VERSION_PREFIX_PARTS
export TAG_VERSION_SOURCE_SUB_PATH TAG_VERSION_SOURCE_FILE_NAME TAG_VERSION_SOURCE_CUSTOM_PATTERN
export BLOCK_SLASHES QC_BLOCK_SLASH_CONTAINING_BRANCHES QC_BLOCK_DOUBLE_HYPHEN_CONTAINING_BRANCHES
export QC_REQUIRE_CONVENTIONAL_BRANCHES QC_REQUIRE_CONVENTIONAL_COMMITS QC_BLOCK_CONVENTIONAL_COMMITS
export HOOK_PRE_TAGGING_TESTS_SCRIPT_SUB_PATH HOOK_PRE_DOCKER_PREPARE_SCRIPT_SUB_PATH HOOK_POST_DOCKER_TESTS_SCRIPT_SUB_PATH
export HOOK_PRE_PACKAGE_PREPARE_SCRIPT_SUB_PATH HOOK_POST_PACKAGE_TESTS_SCRIPT_SUB_PATH
export GITHUB_RELEASE_ENABLED GITHUB_RELEASE_SUBSTITUTED_FILES GITHUB_RELEASE_VERBATIM_FILES
export GITHUB_RELEASE_NOTES GITHUB_RELEASE_ADD_VERSION_TO_FILENAMES

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=src/scripts/lib/hook-runner.bash
source "${SCRIPT_DIR}/../lib/hook-runner.bash"
