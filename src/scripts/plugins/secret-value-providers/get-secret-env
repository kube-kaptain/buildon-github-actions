#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# get-secret-env - Retrieve secrets from environment variables
#
# Most CI systems (GitLab CI, Azure DevOps, Jenkins, CircleCI, etc.) expose
# secrets as environment variables. This script looks up a secret by the
# variable name provided.
#
# Usage: get-secret-env <variable-name>
#
# Outputs:
#   Writes secret value to stdout
#   Returns 1 if variable is unset or empty
#
set -euo pipefail

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

if [[ $# -ne 1 ]]; then
  echo "${LOG_ERROR_PREFIX}Usage: get-secret-env <variable-name>${LOG_ERROR_SUFFIX}" >&2
  exit 1
fi

name="${1}"

# Use indirect expansion to get the value of the variable named by $name
value="${!name:-}"

if [[ -z "${value}" ]]; then
  echo "${LOG_ERROR_PREFIX}Secret not found in environment: ${name}${LOG_ERROR_SUFFIX}" >&2
  exit 1
fi

echo "${value}"
