#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# get-secret-github - Retrieve secrets from GitHub Actions SECRETS_JSON
#
# GitHub Actions passes secrets via toJSON(secrets) which we receive as
# SECRETS_JSON. This script looks up a secret by name from that JSON.
#
# Usage: get-secret-github <secret-name>
#
# Inputs (environment variables):
#   SECRETS_JSON - JSON object containing secret values keyed by name
#
# Outputs:
#   Writes secret value to stdout
#   Returns 1 if secret not found
#
set -euo pipefail

# shellcheck source=src/scripts/defaults/platform.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../defaults/platform.bash"
# shellcheck source=src/scripts/lib/log.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../lib/log.bash"

SECRETS_JSON="${SECRETS_JSON:-{\}}"

if [[ $# -ne 1 ]]; then
  log_error "Usage: get-secret-github <secret-name>"
  exit 1
fi

name="${1}"
value=$(echo "${SECRETS_JSON}" | yq -r ".[\"${name}\"] // \"\"")

if [[ -z "${value}" ]]; then
  log_error "Secret not found: ${name}"
  exit 1
fi

echo "${value}"
