#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# substitute-mustache-style-token - Substitutes {{ TOKEN }} tokens in a file
#
# Called from tokens directory as working directory.
# Substitutes {{ TOKEN_NAME }} with TOKEN_VALUE in-place in target file.
#
# Usage:
#   substitute-mustache-style-token <token-file> <target-file>
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../../defaults/platform.bash"
# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../../lib/log.bash"

if [[ ${#} -ne 2 ]]; then
  log_error "Usage: substitute-mustache-style-token <token-file> <target-file>"
  exit 1
fi

TOKEN_FILE="${1}"
TARGET="${2}"

if [[ ! -f "${TOKEN_FILE}" ]]; then
  log_error "Token file not found: ${TOKEN_FILE}"
  exit 1
fi

if [[ ! -f "${TARGET}" ]]; then
  log_error "Target file not found: ${TARGET}"
  exit 1
fi

# shellcheck source=src/scripts/lib/prepare-token-name-and-value.bash
# shellcheck disable=SC1091 # shellcheck can't resolve dynamic path
source "${SCRIPT_DIR}/../../lib/prepare-token-name-and-value.bash"

substitute_in_file() {
  local file="${1}"
  local token_name="${2}"
  local value="${3}"
  local count=0

  local content
  content=$(cat "${file}" && echo x)
  content="${content%x}"

  # Pattern: {{ TOKEN_NAME }} (with spaces)
  local pattern="{{ ${token_name} }}"

  if [[ "${content}" != *"${pattern}"* ]]; then
    echo "${count}"
    return 0
  fi

  local result=""
  local remainder="${content}"

  while [[ "${remainder}" == *"${pattern}"* ]]; do
    # shellcheck disable=SC2295 # token_name is validated (no glob chars)
    local prefix="${remainder%%\{\{ ${token_name} \}\}*}"
    # shellcheck disable=SC2295 # token_name is validated (no glob chars)
    local suffix="${remainder#*\{\{ ${token_name} \}\}}"
    result="${result}${prefix}${value}"
    remainder="${suffix}"
    count=$((count + 1))
  done
  result="${result}${remainder}"

  printf '%s' "${result}" > "${file}"
  echo "${count}"
}

# shellcheck disable=SC2153,SC2154 # TOKEN_NAME/TOKEN_VALUE set by sourced prepare-token-name-and-value.bash
substitute_in_file "${TARGET}" "${TOKEN_NAME}" "${TOKEN_VALUE}"
