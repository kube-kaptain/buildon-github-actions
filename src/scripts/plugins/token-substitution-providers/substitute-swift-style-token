#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# substitute-swift-style-token - Substitutes \(TOKEN) tokens in files
#
# Called from tokens directory as working directory.
# Substitutes \(TOKEN_NAME) with TOKEN_VALUE in-place across all files in target-dir.
#
# Note: The backslash is part of the literal pattern, not an escape sequence.
# The pattern in files looks like: \(MyVar)
#
# Usage:
#   substitute-swift-style-token <token-file> <target-file-or-dir>
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

if [[ ${#} -ne 2 ]]; then
  echo "${LOG_ERROR_PREFIX}Usage: substitute-swift-style-token <token-file> <target-file-or-dir>${LOG_ERROR_SUFFIX}" >&2
  exit 1
fi

TOKEN_FILE="${1}"
TARGET="${2}"

if [[ ! -f "${TOKEN_FILE}" ]]; then
  echo "${LOG_ERROR_PREFIX}Token file not found: ${TOKEN_FILE}${LOG_ERROR_SUFFIX}" >&2
  exit 1
fi

if [[ -d "${TARGET}" ]]; then
  TARGET_MODE="dir"
elif [[ -f "${TARGET}" ]]; then
  TARGET_MODE="file"
else
  echo "${LOG_ERROR_PREFIX}Target not found: ${TARGET}${LOG_ERROR_SUFFIX}" >&2
  exit 1
fi

# shellcheck source=src/scripts/lib/prepare-token-name-and-value.bash
# shellcheck disable=SC1091 # shellcheck can't resolve dynamic path
source "${SCRIPT_DIR}/../../lib/prepare-token-name-and-value.bash"

substitute_in_file() {
  local file="${1}"
  local token_name="${2}"
  local value="${3}"

  local content
  content=$(cat "${file}" && echo x)
  content="${content%x}"

  # Pattern: \(TOKEN_NAME)
  # The backslash is a literal backslash in the file content
  local pattern="\\(${token_name})"

  if [[ "${content}" != *"${pattern}"* ]]; then
    return 0
  fi

  local result=""
  local remainder="${content}"

  while [[ "${remainder}" == *"${pattern}"* ]]; do
    # In glob patterns, backslash escapes the next character
    # We need to match a literal backslash followed by (token_name)
    # shellcheck disable=SC2295 # token_name is validated (no glob chars)
    local prefix="${remainder%%\\(${token_name})*}"
    # shellcheck disable=SC2295 # token_name is validated (no glob chars)
    local suffix="${remainder#*\\(${token_name})}"
    result="${result}${prefix}${value}"
    remainder="${suffix}"
  done
  result="${result}${remainder}"

  printf '%s' "${result}" > "${file}"
}

# shellcheck disable=SC2153,SC2154 # TOKEN_NAME/TOKEN_VALUE set by sourced prepare-token-name-and-value.bash
if [[ "${TARGET_MODE}" == "file" ]]; then
  substitute_in_file "${TARGET}" "${TOKEN_NAME}" "${TOKEN_VALUE}"
else
  while IFS= read -r -d '' file; do
  substitute_in_file "${file}" "${TOKEN_NAME}" "${TOKEN_VALUE}"
  done < <(find "${TARGET}" -type f -print0)
fi
