#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Pod placement strategy: colocate-app
#
# Prefer placement near pods of a related application.
# Useful for latency-sensitive service pairs or cache locality.
#
# The target app is specified via a compound token: ${ProjectNameAffinityColocateApp}
# This allows the value to be defined in src/config at build time or in the
# environment at deployment time.
#
# Inputs (environment variables):
#   TOKEN_NAME_STYLE      - Name style (PascalCase, camelCase, etc.) [required]
#   TOKEN_DELIMITER_STYLE - Delimiter style (shell, mustache, etc.) [required]
#   PROJECT_NAME          - Project name in lower-kebab format [required]
#   POD_PLACEMENT_INDENT  - Base indentation spaces (default: 0)
#
# Output:
#   YAML affinity block with podAffinity preferring colocation with target app
#
set -euo pipefail

# Locate script directory for libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../../lib"

# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../../defaults/platform.bash"
# shellcheck source=src/scripts/lib/log.bash
source "${LIB_DIR}/log.bash"

# Source libraries
# shellcheck source=src/scripts/lib/token-format.bash
source "${LIB_DIR}/token-format.bash"

# Validate required inputs
if [[ -z "${TOKEN_NAME_STYLE:-}" ]]; then
  log_error "TOKEN_NAME_STYLE is required"
  exit 1
fi

if [[ -z "${TOKEN_DELIMITER_STYLE:-}" ]]; then
  log_error "TOKEN_DELIMITER_STYLE is required"
  exit 1
fi

if [[ -z "${PROJECT_NAME:-}" ]]; then
  log_error "PROJECT_NAME is required (in lower-kebab format)"
  exit 1
fi

# Defaults
POD_PLACEMENT_INDENT="${POD_PLACEMENT_INDENT:-0}"

# Generate compound token for colocate app target
# This creates a token like ${MyProjectAffinityColocateApp} that can be
# defined at build or deployment time
colocate_app_token=$(format_project_suffixed_token "${TOKEN_DELIMITER_STYLE}" "${TOKEN_NAME_STYLE}" "${PROJECT_NAME}" "AFFINITY_COLOCATE_APP")

# Build indentation
indent=""
for ((i = 0; i < POD_PLACEMENT_INDENT; i++)); do
  indent+=" "
done

# Output affinity block
cat <<EOF
${indent}affinity:
${indent}  podAffinity:
${indent}    preferredDuringSchedulingIgnoredDuringExecution:
${indent}      - weight: 100
${indent}        podAffinityTerm:
${indent}          labelSelector:
${indent}            matchLabels:
${indent}              app: ${colocate_app_token}
${indent}          topologyKey: kubernetes.io/hostname
EOF
