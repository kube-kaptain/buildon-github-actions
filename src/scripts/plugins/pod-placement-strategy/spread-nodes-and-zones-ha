#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Pod placement strategy: spread-nodes-and-zones-ha
#
# Combined strategy with node spread as primary concern (weight 100) and
# zone spread as secondary (weight 50). Recommended for production workloads.
#
# Node anti-affinity gets higher weight, so the scheduler prioritizes
# host-level distribution first, then uses zone diversity as a tiebreaker.
#
# Inputs (environment variables):
#   APP_LABEL_VALUE      - Value for the app label in selector [required]
#   POD_PLACEMENT_INDENT - Base indentation spaces (default: 0)
#
# Output:
#   YAML affinity block with podAntiAffinity preferring different nodes and zones
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# shellcheck source=src/scripts/defaults/platform.bash
source "${SCRIPT_DIR}/../../defaults/platform.bash"
# shellcheck source=src/scripts/lib/log.bash
source "${SCRIPT_DIR}/../../lib/log.bash"

# Validate required inputs
if [[ -z "${APP_LABEL_VALUE:-}" ]]; then
  log_error "APP_LABEL_VALUE is required"
  exit 1
fi

# Defaults
POD_PLACEMENT_INDENT="${POD_PLACEMENT_INDENT:-0}"

# Build indentation
indent=""
for ((i = 0; i < POD_PLACEMENT_INDENT; i++)); do
  indent+=" "
done

# Output affinity block
cat <<EOF
${indent}affinity:
${indent}  podAntiAffinity:
${indent}    preferredDuringSchedulingIgnoredDuringExecution:
${indent}      - weight: 100
${indent}        podAffinityTerm:
${indent}          labelSelector:
${indent}            matchLabels:
${indent}              app: ${APP_LABEL_VALUE}
${indent}          topologyKey: kubernetes.io/hostname
${indent}      - weight: 50
${indent}        podAffinityTerm:
${indent}          labelSelector:
${indent}            matchLabels:
${indent}              app: ${APP_LABEL_VALUE}
${indent}          topologyKey: topology.kubernetes.io/zone
EOF
