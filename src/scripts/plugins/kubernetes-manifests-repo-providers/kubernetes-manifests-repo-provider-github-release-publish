#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-repo-provider-github-release-publish - Publishes manifests zip as GitHub release asset
#
# Uploads a zip file to a GitHub release. The zip must already exist.
# Pair with kubernetes-manifests-repo-provider-github-release-package.
#
# Inputs (environment variables - REPO_PROVIDER_* API):
#   REPO_PROVIDER_URL        - Releases URL (informational)
#   REPO_PROVIDER_NAMESPACE  - Repository (owner/repo)
#   REPO_PROVIDER_VERSION    - Release tag (required)
#   REPO_PROVIDER_AUTH_TOKEN - For gh CLI authentication (optional, CI may pre-configure)
#   MANIFESTS_ZIP_SUB_PATH       - Path to the zip file location (required)
#   MANIFESTS_ZIP_FILE_NAME       - Filename of the zip (required)
#   IS_RELEASE               - "true" to actually upload (default: false)
#
# Outputs:
#   MANIFESTS_URI       - URL to the release
#   MANIFESTS_PUBLISHED - "true" if uploaded, "false" if skipped
#
set -euo pipefail

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# =============================================================================
# Map REPO_PROVIDER_* â†’ GitHub Release terminology
# =============================================================================
release_tag="${REPO_PROVIDER_VERSION:?REPO_PROVIDER_VERSION (release tag) is required}"
auth_token="${REPO_PROVIDER_AUTH_TOKEN:-}"
# Note: REPO_PROVIDER_URL, REPO_PROVIDER_NAMESPACE are available but gh CLI
# uses GITHUB_* context, so we don't need them here

# =============================================================================
# Other inputs
# =============================================================================
MANIFESTS_ZIP_SUB_PATH="${MANIFESTS_ZIP_SUB_PATH:?MANIFESTS_ZIP_SUB_PATH is required}"
MANIFESTS_ZIP_FILE_NAME="${MANIFESTS_ZIP_FILE_NAME:?MANIFESTS_ZIP_FILE_NAME is required}"
IS_RELEASE="${IS_RELEASE:-false}"

output_var() {
  local name="${1}"
  local value="${2}"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "${GITHUB_OUTPUT}"
  fi
}

main() {
  echo "=== Kubernetes Manifests Repo Provider Publish: GitHub Release ===" >&2
  echo "Manifests zip path: ${MANIFESTS_ZIP_SUB_PATH}" >&2
  echo "Manifests zip name: ${MANIFESTS_ZIP_FILE_NAME}" >&2
  echo "Release tag: ${release_tag}" >&2
  echo "===================================================================" >&2

  # Validate zip exists
  if [[ ! -f "${MANIFESTS_ZIP_SUB_PATH}/${MANIFESTS_ZIP_FILE_NAME}" ]]; then
    echo "${LOG_ERROR_PREFIX}Manifests zip not found: ${MANIFESTS_ZIP_SUB_PATH}/${MANIFESTS_ZIP_FILE_NAME}${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Check auth token is available (either REPO_PROVIDER_AUTH_TOKEN or pre-configured GITHUB_TOKEN)
  if [[ -z "${auth_token}" && -z "${GITHUB_TOKEN:-}" ]]; then
    echo "${LOG_ERROR_PREFIX}REPO_PROVIDER_AUTH_TOKEN is required for release upload (unless CI pre-configures GITHUB_TOKEN)${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Set GITHUB_TOKEN from auth_token if provided (gh CLI uses GITHUB_TOKEN)
  if [[ -n "${auth_token}" ]]; then
    export GITHUB_TOKEN="${auth_token}"
  fi

  # Upload if release
  if [[ "${IS_RELEASE}" == "true" ]]; then
    # Check if release exists
    echo "Checking for existing release: ${release_tag}" >&2
    local release_url
    if gh release view "${release_tag}" --json url -q '.url' &>/dev/null; then
      release_url=$(gh release view "${release_tag}" --json url -q '.url')
      echo "Found existing release: ${release_url}" >&2
    else
      echo "Creating release: ${release_tag}" >&2
      gh release create "${release_tag}" --title "${release_tag}" --notes "Release ${release_tag}"
      release_url=$(gh release view "${release_tag}" --json url -q '.url')
      echo "Created release: ${release_url}" >&2
    fi

    # Upload asset
    echo "Uploading: ${MANIFESTS_ZIP_FILE_NAME}" >&2
    gh release upload "${release_tag}" "${MANIFESTS_ZIP_SUB_PATH}/${MANIFESTS_ZIP_FILE_NAME}" --clobber

    output_var "MANIFESTS_URI" "${release_url}"
    output_var "MANIFESTS_PUBLISHED" "true"
  else
    echo "Skipping upload (IS_RELEASE=${IS_RELEASE})" >&2
    output_var "MANIFESTS_URI" ""
    output_var "MANIFESTS_PUBLISHED" "false"
  fi

  echo "Kubernetes Manifests Repo Provider Publish: GitHub Release complete" >&2
}

main "$@"
