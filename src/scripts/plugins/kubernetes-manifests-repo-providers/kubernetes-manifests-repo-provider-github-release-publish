#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-repo-provider-github-release-publish - Publishes manifests zip as GitHub release asset
#
# Uploads a zip file to a GitHub release. The zip must already exist.
# Pair with kubernetes-manifests-repo-provider-github-release-package.
#
# Inputs (environment variables):
#   MANIFESTS_ZIP_PATH - Path to zip file (required)
#   MANIFESTS_ZIP_NAME - Filename for upload (required)
#   VERSION           - Release tag (required)
#   GITHUB_TOKEN      - For gh CLI authentication (required)
#   IS_RELEASE        - "true" to actually upload (default: false)
#
# Outputs:
#   MANIFESTS_URI       - URL to the release
#   MANIFESTS_PUBLISHED - "true" if uploaded, "false" if skipped
#
set -euo pipefail

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# Required inputs
MANIFESTS_ZIP_PATH="${MANIFESTS_ZIP_PATH:?MANIFESTS_ZIP_PATH is required}"
MANIFESTS_ZIP_NAME="${MANIFESTS_ZIP_NAME:?MANIFESTS_ZIP_NAME is required}"
VERSION="${VERSION:?VERSION is required}"

# Optional inputs with defaults
IS_RELEASE="${IS_RELEASE:-false}"

output_var() {
  local name="$1"
  local value="$2"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "$GITHUB_OUTPUT"
  fi
}

main() {
  echo "=== Kubernetes Manifests Repo Provider Publish: GitHub Release ===" >&2
  echo "Manifests zip: $MANIFESTS_ZIP_PATH" >&2
  echo "Manifests zip name: $MANIFESTS_ZIP_NAME" >&2
  echo "Version: $VERSION" >&2
  echo "===================================================================" >&2

  # Validate zip exists
  if [[ ! -f "$MANIFESTS_ZIP_PATH" ]]; then
    echo "${LOG_ERROR_PREFIX}Manifests zip not found: $MANIFESTS_ZIP_PATH${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Check GITHUB_TOKEN is set
  if [[ -z "${GITHUB_TOKEN:-}" ]]; then
    echo "${LOG_ERROR_PREFIX}GITHUB_TOKEN is required for release upload${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Upload if release
  if [[ "$IS_RELEASE" == "true" ]]; then
    # Check if release exists
    echo "Checking for existing release: $VERSION" >&2
    local release_url
    if gh release view "$VERSION" --json url -q '.url' &>/dev/null; then
      release_url=$(gh release view "$VERSION" --json url -q '.url')
      echo "Found existing release: $release_url" >&2
    else
      echo "Creating release: $VERSION" >&2
      gh release create "$VERSION" --title "$VERSION" --notes "Release $VERSION"
      release_url=$(gh release view "$VERSION" --json url -q '.url')
      echo "Created release: $release_url" >&2
    fi

    # Upload asset
    echo "Uploading: $MANIFESTS_ZIP_NAME" >&2
    gh release upload "$VERSION" "$MANIFESTS_ZIP_PATH" --clobber

    output_var "MANIFESTS_URI" "$release_url"
    output_var "MANIFESTS_PUBLISHED" "true"
  else
    echo "Skipping upload (IS_RELEASE=$IS_RELEASE)" >&2
    output_var "MANIFESTS_URI" ""
    output_var "MANIFESTS_PUBLISHED" "false"
  fi

  echo "Kubernetes Manifests Repo Provider Publish: GitHub Release complete" >&2
}

main "$@"
