#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-repo-provider-npm-package - Packages manifests zip as an npm package
#
# Creates an npm package containing the manifests zip for publishing to an npm registry.
# Generates package.json and runs npm pack to create a tarball.
# Pair with kubernetes-manifests-repo-provider-npm-publish.
#
# Inputs (environment variables):
#   MANIFESTS_ZIP_PATH  - Path to zip file (required)
#   MANIFESTS_ZIP_NAME  - Filename of the zip (required)
#   PROJECT_NAME        - Project name for package (required)
#   VERSION             - Package version (required)
#   REGISTRY_OWNER      - Package scope/owner (required)
#   REGISTRY_URL        - npm registry URL (required)
#   OUTPUT_PATH         - Build output directory (default: target)
#
# Outputs:
#   MANIFESTS_ARTIFACT_PATH   - Path to the npm tarball
#   MANIFESTS_URI             - npm package reference (npm:@owner/name@version)
#
set -euo pipefail

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# Required inputs
MANIFESTS_ZIP_PATH="${MANIFESTS_ZIP_PATH:?MANIFESTS_ZIP_PATH is required}"
MANIFESTS_ZIP_NAME="${MANIFESTS_ZIP_NAME:?MANIFESTS_ZIP_NAME is required}"
PROJECT_NAME="${PROJECT_NAME:?PROJECT_NAME is required}"
VERSION="${VERSION:?VERSION is required}"
REGISTRY_OWNER="${REGISTRY_OWNER:?REGISTRY_OWNER is required}"
REGISTRY_URL="${REGISTRY_URL:?REGISTRY_URL is required}"

# Optional inputs with defaults
OUTPUT_PATH="${OUTPUT_PATH:-target}"

# Build output structure
PUBLISH_PATH="$OUTPUT_PATH/publish/npm"

# Normalize owner to lowercase (npm requires lowercase scope)
OWNER_LOWER=$(echo "$REGISTRY_OWNER" | tr '[:upper:]' '[:lower:]')

# Package name: @owner/project-manifests
PACKAGE_NAME="@${OWNER_LOWER}/${PROJECT_NAME}-manifests"

output_var() {
  local name="$1"
  local value="$2"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "$GITHUB_OUTPUT"
  fi
}

main() {
  echo "=== Kubernetes Manifests Repo Provider Package: npm ===" >&2
  echo "Manifests zip: $MANIFESTS_ZIP_PATH" >&2
  echo "Package name: $PACKAGE_NAME" >&2
  echo "Version: $VERSION" >&2
  echo "========================================================" >&2

  # Check npm is available
  if ! command -v npm &>/dev/null; then
    echo "${LOG_ERROR_PREFIX}npm is required but not found in PATH${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Validate zip exists
  if [[ ! -f "$MANIFESTS_ZIP_PATH" ]]; then
    echo "${LOG_ERROR_PREFIX}Manifests zip not found: $MANIFESTS_ZIP_PATH${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Create publish build directory
  rm -rf "$PUBLISH_PATH"
  mkdir -p "$PUBLISH_PATH"

  # Copy zip to publish dir
  cp "$MANIFESTS_ZIP_PATH" "$PUBLISH_PATH/$MANIFESTS_ZIP_NAME"

  # Generate package.json
  cat > "$PUBLISH_PATH/package.json" <<EOF
{
  "name": "${PACKAGE_NAME}",
  "version": "${VERSION}",
  "description": "Kubernetes manifests for ${PROJECT_NAME}",
  "files": [
    "${MANIFESTS_ZIP_NAME}"
  ],
  "publishConfig": {
    "registry": "${REGISTRY_URL}"
  }
}
EOF

  echo "Generated package.json" >&2

  # Run npm pack to create tarball
  echo "Creating npm tarball..." >&2
  local tarball_name
  # npm pack outputs the tarball name
  tarball_name=$(cd "$PUBLISH_PATH" && npm pack --quiet 2>/dev/null)

  local tarball_path="$PUBLISH_PATH/$tarball_name"
  if [[ ! -f "$tarball_path" ]]; then
    echo "${LOG_ERROR_PREFIX}Failed to create npm tarball${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  echo "Created: $tarball_name" >&2

  output_var "MANIFESTS_ARTIFACT_PATH" "$tarball_path"
  output_var "MANIFESTS_URI" "npm:${PACKAGE_NAME}@${VERSION}"

  echo "Kubernetes Manifests Repo Provider Package: npm complete" >&2
}

main "$@"
