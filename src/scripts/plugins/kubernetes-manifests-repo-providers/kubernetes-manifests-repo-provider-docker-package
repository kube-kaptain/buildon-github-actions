#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-repo-provider-docker-package - Packages manifests zip as a Docker image
#
# Uses a minimal base image, stores zip at /<original-filename>
# Builds the image but does NOT push. Pair with kubernetes-manifests-repo-provider-docker-publish.
#
# Inputs (environment variables - REPO_PROVIDER_* API):
#   REPO_PROVIDER_URL       - Container registry (required, e.g., ghcr.io)
#   REPO_PROVIDER_NAMESPACE - Path between registry and image name (optional)
#   REPO_PROVIDER_NAME      - Image name (required)
#   REPO_PROVIDER_VERSION   - Tag for the image (required, e.g., 1.2.3-manifests)
#   MANIFESTS_ZIP_SUB_PATH      - Path to the zip file location (required)
#   MANIFESTS_ZIP_FILE_NAME      - Filename of the zip (required)
#   OUTPUT_SUB_PATH         - Build output directory (default: target)
#   MANIFESTS_PACKAGING_BASE_IMAGE - Base image for manifest packaging (default: ghcr.io/kube-kaptain/image/image-pause:3.10.2)
#
# Outputs:
#   MANIFESTS_URI           - Full image reference (for use by publish step)
#
set -euo pipefail

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# =============================================================================
# Map REPO_PROVIDER_* â†’ Docker terminology
# =============================================================================
registry="${REPO_PROVIDER_URL:?REPO_PROVIDER_URL (registry) is required}"
base_path="${REPO_PROVIDER_NAMESPACE:-}"
image_name="${REPO_PROVIDER_NAME:?REPO_PROVIDER_NAME (image name) is required}"
tag="${REPO_PROVIDER_VERSION:?REPO_PROVIDER_VERSION (tag) is required}"

# =============================================================================
# Other inputs
# =============================================================================
MANIFESTS_ZIP_SUB_PATH="${MANIFESTS_ZIP_SUB_PATH:?MANIFESTS_ZIP_SUB_PATH is required}"
MANIFESTS_ZIP_FILE_NAME="${MANIFESTS_ZIP_FILE_NAME:?MANIFESTS_ZIP_FILE_NAME is required}"
OUTPUT_SUB_PATH="${OUTPUT_SUB_PATH:-target}"

# Base image for manifest packaging
BASE_IMAGE="${MANIFESTS_PACKAGING_BASE_IMAGE:-ghcr.io/kube-kaptain/image/image-pause:3.10.2}"

# Build output structure
PUBLISH_SUB_PATH="${OUTPUT_SUB_PATH}/publish/docker"

# Assemble full image URI
if [[ -n "${base_path}" ]]; then
  image_uri="${registry}/${base_path}/${image_name}:${tag}"
else
  image_uri="${registry}/${image_name}:${tag}"
fi

confirm_image_doesnt_exist() {
  local image="${1}"

  if docker manifest inspect "${image}" &>/dev/null; then
    echo "${LOG_ERROR_PREFIX}Target image already exists in registry: ${image}${LOG_ERROR_SUFFIX}" >&2
    return 1
  fi

  echo "Confirmed image does not exist in registry (safe to push)" >&2
  return 0
}

output_var() {
  local name="${1}"
  local value="${2}"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "${GITHUB_OUTPUT}"
  fi
}

main() {
  echo "=== Kubernetes Manifests Repo Provider Package: Docker ===" >&2
  echo "Manifests zip path: ${MANIFESTS_ZIP_SUB_PATH}" >&2
  echo "Manifests zip name: ${MANIFESTS_ZIP_FILE_NAME}" >&2
  echo "Base image: ${BASE_IMAGE}" >&2
  echo "Target: ${image_uri}" >&2
  echo "===========================================================" >&2

  # Validate zip exists
  if [[ ! -f "${MANIFESTS_ZIP_SUB_PATH}/${MANIFESTS_ZIP_FILE_NAME}" ]]; then
    echo "${LOG_ERROR_PREFIX}Manifests zip not found: ${MANIFESTS_ZIP_SUB_PATH}/${MANIFESTS_ZIP_FILE_NAME}${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Confirm target doesn't exist (fail fast)
  confirm_image_doesnt_exist "${image_uri}" || exit 1

  # Create publish build directory (instead of temp dir)
  rm -rf "${PUBLISH_SUB_PATH}"
  mkdir -p "${PUBLISH_SUB_PATH}"

  # Copy zip to publish dir
  cp "${MANIFESTS_ZIP_SUB_PATH}/${MANIFESTS_ZIP_FILE_NAME}" "${PUBLISH_SUB_PATH}/"

  # Create Dockerfile
  cat > "${PUBLISH_SUB_PATH}/Dockerfile" <<EOF
FROM ${BASE_IMAGE}
COPY ${MANIFESTS_ZIP_FILE_NAME} /${MANIFESTS_ZIP_FILE_NAME}
EOF

  echo "Building manifest image..." >&2
  docker build -t "${image_uri}" "${PUBLISH_SUB_PATH}"

  output_var "MANIFESTS_URI" "${image_uri}"

  echo "Kubernetes Manifests Repo Provider Package: Docker complete" >&2
}

main "$@"
