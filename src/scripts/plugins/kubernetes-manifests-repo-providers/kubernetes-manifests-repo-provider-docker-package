#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-repo-provider-docker-package - Packages manifests zip as a Docker image
#
# Prepares the content directory with the manifests zip, then delegates to
# docker-package-multi-arch for multi-architecture builds.
# Does NOT push. Pair with kubernetes-manifests-repo-provider-docker-publish.
#
# Inputs (environment variables - REPO_PROVIDER_* API):
#   REPO_PROVIDER_URL       - Container registry (required, e.g., ghcr.io)
#   REPO_PROVIDER_NAMESPACE - Path between registry and image name (optional)
#   REPO_PROVIDER_NAME      - Image name (required)
#   REPO_PROVIDER_VERSION   - Tag for the image (required, e.g., 1.2.3-manifests)
#   MANIFESTS_ZIP_SUB_PATH      - Path to the zip file location (required)
#   MANIFESTS_ZIP_FILE_NAME      - Filename of the zip (required)
#   OUTPUT_SUB_PATH         - Build output directory (default: target)
#   MANIFESTS_PACKAGING_BASE_IMAGE - Base image for manifest packaging (default: scratch)
#
# Outputs:
#   MANIFESTS_URI           - Full image reference (for use by publish step)
#
set -euo pipefail

# shellcheck source=src/scripts/defaults/docker-common.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../defaults/docker-common.bash"
# shellcheck source=src/scripts/defaults/platform.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../defaults/platform.bash"
# shellcheck source=src/scripts/lib/log.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../lib/log.bash"

# =============================================================================
# Map REPO_PROVIDER_* â†’ Docker terminology
# =============================================================================
registry="${REPO_PROVIDER_URL:?REPO_PROVIDER_URL (registry) is required}"
namespace="${REPO_PROVIDER_NAMESPACE:-}"
image_name="${REPO_PROVIDER_NAME:?REPO_PROVIDER_NAME (image name) is required}"
tag="${REPO_PROVIDER_VERSION:?REPO_PROVIDER_VERSION (tag) is required}"

# =============================================================================
# Other inputs
# =============================================================================
MANIFESTS_ZIP_SUB_PATH="${MANIFESTS_ZIP_SUB_PATH:?MANIFESTS_ZIP_SUB_PATH is required}"
MANIFESTS_ZIP_FILE_NAME="${MANIFESTS_ZIP_FILE_NAME:?MANIFESTS_ZIP_FILE_NAME is required}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=src/scripts/defaults/output-sub-path.bash
source "${SCRIPT_DIR}/../../defaults/output-sub-path.bash"
# shellcheck source=src/scripts/defaults/manifests-repo-provider.bash
source "${SCRIPT_DIR}/../../defaults/manifests-repo-provider.bash"
# shellcheck source=src/scripts/lib/output-var.bash
source "${SCRIPT_DIR}/../../lib/output-var.bash"

# Build output structure
PUBLISH_SUB_PATH="${OUTPUT_SUB_PATH}/publish/docker"

# Assemble full image URI
if [[ -n "${namespace}" ]]; then
  image_uri="${registry}/${namespace}/${image_name}:${tag}"
else
  image_uri="${registry}/${image_name}:${tag}"
fi

confirm_image_doesnt_exist() {
  local image="${1}"

  if ${IMAGE_BUILD_COMMAND} manifest inspect "${image}" &>/dev/null; then
    log_error "Target image already exists in registry: ${image}"
    return 1
  fi

  log "Confirmed image does not exist in registry (safe to push)"
  return 0
}

main() {
  log "=== Kubernetes Manifests Repo Provider Package: Docker ==="
  log "Manifests zip path: ${MANIFESTS_ZIP_SUB_PATH}"
  log "Manifests zip name: ${MANIFESTS_ZIP_FILE_NAME}"
  log "Base image: ${BASE_IMAGE}"
  log "Target: ${image_uri}"
  log "==========================================================="

  # Validate zip exists
  if [[ ! -f "${MANIFESTS_ZIP_SUB_PATH}/${MANIFESTS_ZIP_FILE_NAME}" ]]; then
    log_error "Manifests zip not found: ${MANIFESTS_ZIP_SUB_PATH}/${MANIFESTS_ZIP_FILE_NAME}"
    exit 1
  fi

  # Confirm target doesn't exist (fail fast)
  confirm_image_doesnt_exist "${image_uri}" || exit 1

  # Create publish build directory
  rm -rf "${PUBLISH_SUB_PATH}"
  mkdir -p "${PUBLISH_SUB_PATH}"

  # Copy zip to publish dir
  cp "${MANIFESTS_ZIP_SUB_PATH}/${MANIFESTS_ZIP_FILE_NAME}" "${PUBLISH_SUB_PATH}/"

  # Delegate to multi-arch packager
  PACKAGE_BASE_IMAGE="${BASE_IMAGE}" \
    "${SCRIPT_DIR}/../../util/docker-package-multi-arch" "${PUBLISH_SUB_PATH}" "${image_uri}"

  output_var "MANIFESTS_URI" "${image_uri}"

  log "Kubernetes Manifests Repo Provider Package: Docker complete"
}

main "$@"
