#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-repo-provider-github-release-package - Prepares manifests for GitHub release
#
# Validates the manifests zip exists and is ready for upload.
# For GitHub releases, there's no intermediate artifact to build - this just validates.
# Pair with kubernetes-manifests-repo-provider-github-release-publish.
#
# Inputs (environment variables - REPO_PROVIDER_* API):
#   REPO_PROVIDER_URL       - Releases URL (informational)
#   REPO_PROVIDER_NAMESPACE - Repository (owner/repo)
#   REPO_PROVIDER_NAME      - Asset base name
#   REPO_PROVIDER_VERSION   - Release tag (required)
#   MANIFESTS_ZIP_SUB_PATH      - Path to the zip file location (required)
#   MANIFESTS_ZIP_FILE_NAME      - Filename of the zip (required)
#
# Outputs:
#   MANIFESTS_ZIP_SUB_PATH      - Path to zip file (pass through for publish step)
#   MANIFESTS_ZIP_FILE_NAME      - Filename for upload (pass through for publish step)
#   VERSION                 - Release tag (pass through for publish step)
#
set -euo pipefail

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# =============================================================================
# Map REPO_PROVIDER_* â†’ GitHub Release terminology
# =============================================================================
release_tag="${REPO_PROVIDER_VERSION:?REPO_PROVIDER_VERSION (release tag) is required}"
# Note: REPO_PROVIDER_URL, REPO_PROVIDER_NAMESPACE, REPO_PROVIDER_NAME are available
# but not needed for package step (just validates zip exists)

# =============================================================================
# Other inputs
# =============================================================================
MANIFESTS_ZIP_SUB_PATH="${MANIFESTS_ZIP_SUB_PATH:?MANIFESTS_ZIP_SUB_PATH is required}"
MANIFESTS_ZIP_FILE_NAME="${MANIFESTS_ZIP_FILE_NAME:?MANIFESTS_ZIP_FILE_NAME is required}"

output_var() {
  local name="$1"
  local value="$2"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "$GITHUB_OUTPUT"
  fi
}

main() {
  echo "=== Kubernetes Manifests Repo Provider Package: GitHub Release ===" >&2
  echo "Manifests zip path: $MANIFESTS_ZIP_SUB_PATH" >&2
  echo "Manifests zip name: $MANIFESTS_ZIP_FILE_NAME" >&2
  echo "Release tag: $release_tag" >&2
  echo "===================================================================" >&2

  # Validate zip exists
  if [[ ! -f "$MANIFESTS_ZIP_SUB_PATH/$MANIFESTS_ZIP_FILE_NAME" ]]; then
    echo "${LOG_ERROR_PREFIX}Manifests zip not found: $MANIFESTS_ZIP_SUB_PATH/$MANIFESTS_ZIP_FILE_NAME${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Pass through values for publish step
  output_var "MANIFESTS_ZIP_SUB_PATH" "$MANIFESTS_ZIP_SUB_PATH"
  output_var "MANIFESTS_ZIP_FILE_NAME" "$MANIFESTS_ZIP_FILE_NAME"
  output_var "VERSION" "$release_tag"

  echo "Kubernetes Manifests Repo Provider Package: GitHub Release complete" >&2
}

main "$@"
