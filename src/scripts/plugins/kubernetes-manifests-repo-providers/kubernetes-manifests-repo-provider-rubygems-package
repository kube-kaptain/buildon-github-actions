#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifests-repo-provider-rubygems-package - Packages manifests zip as a RubyGem
#
# Creates a RubyGem containing the manifests zip for publishing to a gem registry.
# Generates a gemspec and runs gem build to create the .gem file.
# Pair with kubernetes-manifests-repo-provider-rubygems-publish.
#
# Inputs (environment variables):
#   MANIFESTS_ZIP_PATH  - Path to zip file (required)
#   MANIFESTS_ZIP_NAME  - Filename of the zip (required)
#   PROJECT_NAME        - Project name for gem (required)
#   VERSION             - Gem version (required)
#   REGISTRY_OWNER      - Package namespace/owner (required)
#   HOMEPAGE_URL        - Gem homepage URL (optional)
#   OUTPUT_PATH         - Build output directory (default: target)
#
# Outputs:
#   MANIFESTS_ARTIFACT_PATH   - Path to the .gem file
#   MANIFESTS_URI             - gem package reference (gem:owner/name:version)
#
set -euo pipefail

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# Required inputs
MANIFESTS_ZIP_PATH="${MANIFESTS_ZIP_PATH:?MANIFESTS_ZIP_PATH is required}"
MANIFESTS_ZIP_NAME="${MANIFESTS_ZIP_NAME:?MANIFESTS_ZIP_NAME is required}"
PROJECT_NAME="${PROJECT_NAME:?PROJECT_NAME is required}"
VERSION="${VERSION:?VERSION is required}"
REGISTRY_OWNER="${REGISTRY_OWNER:?REGISTRY_OWNER is required}"

# Optional inputs with defaults
OUTPUT_PATH="${OUTPUT_PATH:-target}"
HOMEPAGE_URL="${HOMEPAGE_URL:-}"

# Build output structure
PUBLISH_PATH="$OUTPUT_PATH/publish/rubygems"

# Gem name: project-manifests
GEM_NAME="${PROJECT_NAME}-manifests"

output_var() {
  local name="$1"
  local value="$2"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "$GITHUB_OUTPUT"
  fi
}

main() {
  echo "=== Kubernetes Manifests Repo Provider Package: RubyGems ===" >&2
  echo "Manifests zip: $MANIFESTS_ZIP_PATH" >&2
  echo "Gem name: $GEM_NAME" >&2
  echo "Version: $VERSION" >&2
  echo "=============================================================" >&2

  # Check gem is available
  if ! command -v gem &>/dev/null; then
    echo "${LOG_ERROR_PREFIX}gem is required but not found in PATH${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Validate zip exists
  if [[ ! -f "$MANIFESTS_ZIP_PATH" ]]; then
    echo "${LOG_ERROR_PREFIX}Manifests zip not found: $MANIFESTS_ZIP_PATH${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Create publish build directory
  rm -rf "$PUBLISH_PATH"
  mkdir -p "$PUBLISH_PATH"

  # Copy zip to publish dir
  cp "$MANIFESTS_ZIP_PATH" "$PUBLISH_PATH/$MANIFESTS_ZIP_NAME"

  # Generate gemspec
  local homepage_line=""
  local metadata_line=""
  if [[ -n "$HOMEPAGE_URL" ]]; then
    homepage_line="  s.homepage    = '${HOMEPAGE_URL}'"
    metadata_line="  s.metadata    = { 'source_code_uri' => '${HOMEPAGE_URL}' }"
  fi

  cat > "$PUBLISH_PATH/${GEM_NAME}.gemspec" <<EOF
Gem::Specification.new do |s|
  s.name        = '${GEM_NAME}'
  s.version     = '${VERSION}'
  s.summary     = 'Kubernetes manifests for ${PROJECT_NAME}'
  s.description = 'Kubernetes manifests package for ${PROJECT_NAME}'
  s.authors     = ['${REGISTRY_OWNER}']
  s.files       = ['${MANIFESTS_ZIP_NAME}']
  s.license     = 'MIT'
${homepage_line}
${metadata_line}
end
EOF

  echo "Generated gemspec" >&2

  # Run gem build to create .gem file
  echo "Building gem..." >&2
  local gem_file="${GEM_NAME}-${VERSION}.gem"
  (cd "$PUBLISH_PATH" && gem build "${GEM_NAME}.gemspec" --quiet)

  local gem_path="$PUBLISH_PATH/$gem_file"
  if [[ ! -f "$gem_path" ]]; then
    echo "${LOG_ERROR_PREFIX}Failed to create gem file${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  echo "Created: $gem_file" >&2

  output_var "MANIFESTS_ARTIFACT_PATH" "$gem_path"
  output_var "MANIFESTS_URI" "gem:${REGISTRY_OWNER}/${GEM_NAME}:${VERSION}"

  echo "Kubernetes Manifests Repo Provider Package: RubyGems complete" >&2
}

main "$@"
