#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# docker-login-username-password - Login with username and password
#
# Usage: docker-login-username-password <secret-method> <registry> <username-secret> <password-secret>
#
# Arguments:
#   secret-method   - Secret retrieval method (github, env)
#   registry        - Registry URL (e.g., docker.io, quay.io)
#   username-secret - Name of secret containing username
#   password-secret - Name of secret containing password
#
set -euo pipefail

# shellcheck source=src/scripts/defaults/docker-common.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../defaults/docker-common.bash"
# shellcheck source=src/scripts/defaults/platform.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../defaults/platform.bash"
# shellcheck source=src/scripts/lib/log.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../lib/log.bash"

SCRIPT_DIR="$(dirname "${0}")"
PLUGINS_DIR="${SCRIPT_DIR}/.."

secret_method="${1}"
registry="${2}"
username_secret="${3}"
password_secret="${4}"

get_secret="${PLUGINS_DIR}/secret-value-providers/get-secret-${secret_method}"

username=$("${get_secret}" "${username_secret}") || exit 1
password=$("${get_secret}" "${password_secret}") || exit 1

log "Logging in to ${registry} with username/password..."
echo "${password}" | ${IMAGE_BUILD_COMMAND} login "${registry}" -u "${username}" --password-stdin
