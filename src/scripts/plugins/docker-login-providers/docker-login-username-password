#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
#
# docker-login-username-password - Login with username and password
#
# Usage: docker-login-username-password <secret-method> <registry> <username-secret> <password-secret>
#
# Arguments:
#   secret-method   - Secret retrieval method (github, env)
#   registry        - Registry URL (e.g., docker.io, quay.io)
#   username-secret - Name of secret containing username
#   password-secret - Name of secret containing password
#
set -euo pipefail

SCRIPT_DIR="$(dirname "$0")"
PLUGINS_DIR="$SCRIPT_DIR/.."

secret_method="$1"
registry="$2"
username_secret="$3"
password_secret="$4"

get_secret="$PLUGINS_DIR/secret-value-providers/get-secret-$secret_method"

username=$("$get_secret" "$username_secret") || exit 1
password=$("$get_secret" "$password_secret") || exit 1

echo "Logging in to $registry with username/password..." >&2
echo "$password" | docker login "$registry" -u "$username" --password-stdin
