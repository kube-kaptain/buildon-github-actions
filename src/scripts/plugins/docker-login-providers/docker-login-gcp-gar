#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
#
# docker-login-gcp-gar - Login to Google Artifact Registry with service account key
#
# Usage: docker-login-gcp-gar <secret-method> <registry> <service-account-key-secret>
#
# Arguments:
#   secret-method              - Secret retrieval method (github, env)
#   registry                   - GAR registry URL (e.g., us-docker.pkg.dev)
#   service-account-key-secret - Name of secret containing service account JSON key
#
set -euo pipefail

SCRIPT_DIR="$(dirname "${0}")"
PLUGINS_DIR="${SCRIPT_DIR}/.."

secret_method="${1}"
registry="${2}"
service_account_key_secret="${3}"

key_json=$("${PLUGINS_DIR}/secret-value-providers/get-secret-${secret_method}" "${service_account_key_secret}") || exit 1

echo "Logging in to Google Artifact Registry ${registry}..." >&2
echo "${key_json}" | docker login -u _json_key --password-stdin "https://${registry}"
