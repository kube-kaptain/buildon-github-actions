#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# docker-login-gcp-gar - Login to Google Artifact Registry with service account key
#
# Usage: docker-login-gcp-gar <secret-method> <registry> <service-account-key-secret>
#
# Arguments:
#   secret-method              - Secret retrieval method (github, env)
#   registry                   - GAR registry URL (e.g., us-docker.pkg.dev)
#   service-account-key-secret - Name of secret containing service account JSON key
#
set -euo pipefail

# shellcheck source=src/scripts/defaults/docker-common.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../defaults/docker-common.bash"
# shellcheck source=src/scripts/defaults/platform.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../defaults/platform.bash"
# shellcheck source=src/scripts/lib/log.bash
source "$(dirname "${BASH_SOURCE[0]}")/../../lib/log.bash"

SCRIPT_DIR="$(dirname "${0}")"
PLUGINS_DIR="${SCRIPT_DIR}/.."

secret_method="${1}"
registry="${2}"
service_account_key_secret="${3}"

key_json=$("${PLUGINS_DIR}/secret-value-providers/get-secret-${secret_method}" "${service_account_key_secret}") || exit 1

log "Logging in to Google Artifact Registry ${registry}..."
echo "${key_json}" | ${IMAGE_BUILD_COMMAND} login -u _json_key --password-stdin "https://${registry}"
