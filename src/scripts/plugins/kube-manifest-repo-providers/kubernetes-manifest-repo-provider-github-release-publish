#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
#
# kubernetes-manifest-repo-provider-github-release-publish - Publishes manifest zip as GitHub release asset
#
# Inputs (environment variables):
#   MANIFEST_ZIP_PATH - Path to zip file (required)
#   MANIFEST_ZIP_NAME - Filename for upload (required)
#   VERSION           - Release tag (required)
#   IS_RELEASE        - "true" to upload (default: false)
#   GITHUB_TOKEN      - For gh CLI authentication (required if IS_RELEASE=true)
#
# Outputs (GITHUB_OUTPUT):
#   MANIFEST_URI       - URL to the release
#   MANIFEST_PUBLISHED - Whether manifests were published
#
set -euo pipefail

# Logging configuration (CI-agnostic)
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

# Required inputs
MANIFEST_ZIP_PATH="${MANIFEST_ZIP_PATH:?MANIFEST_ZIP_PATH is required}"
MANIFEST_ZIP_NAME="${MANIFEST_ZIP_NAME:?MANIFEST_ZIP_NAME is required}"
VERSION="${VERSION:?VERSION is required}"

# Optional inputs with defaults
IS_RELEASE="${IS_RELEASE:-false}"

output_var() {
  local name="$1"
  local value="$2"

  echo "${name}=${value}"

  if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
    echo "${name}=${value}" >> "$GITHUB_OUTPUT"
  fi
}

main() {
  echo "=== Kubernetes Manifest Publish: GitHub Release ===" >&2
  echo "Manifest zip: $MANIFEST_ZIP_PATH" >&2
  echo "Manifest zip name: $MANIFEST_ZIP_NAME" >&2
  echo "Version: $VERSION" >&2
  echo "Is Release: $IS_RELEASE" >&2
  echo "======================================================" >&2

  # Validate zip exists
  if [[ ! -f "$MANIFEST_ZIP_PATH" ]]; then
    echo "${LOG_ERROR_PREFIX}Manifest zip not found: $MANIFEST_ZIP_PATH${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  if [[ "$IS_RELEASE" != "true" ]]; then
    echo "Skipping upload (IS_RELEASE=$IS_RELEASE)" >&2
    output_var "MANIFEST_PUBLISHED" "false"
    output_var "MANIFEST_URI" ""
    echo "Kubernetes Manifest Publish: GitHub Release complete (skipped)" >&2
    return 0
  fi

  # Check GITHUB_TOKEN is set
  if [[ -z "${GITHUB_TOKEN:-}" ]]; then
    echo "${LOG_ERROR_PREFIX}GITHUB_TOKEN is required for release upload${LOG_ERROR_SUFFIX}" >&2
    exit 1
  fi

  # Check if release exists
  echo "Checking for existing release: $VERSION" >&2
  local release_url
  if gh release view "$VERSION" --json url -q '.url' &>/dev/null; then
    release_url=$(gh release view "$VERSION" --json url -q '.url')
    echo "Found existing release: $release_url" >&2
  else
    echo "Creating release: $VERSION" >&2
    gh release create "$VERSION" --title "$VERSION" --notes "Release $VERSION"
    release_url=$(gh release view "$VERSION" --json url -q '.url')
    echo "Created release: $release_url" >&2
  fi

  # Upload asset
  echo "Uploading: $MANIFEST_ZIP_NAME" >&2
  gh release upload "$VERSION" "$MANIFEST_ZIP_PATH" --clobber

  output_var "MANIFEST_URI" "$release_url"
  output_var "MANIFEST_PUBLISHED" "true"

  echo "Kubernetes Manifest Publish: GitHub Release complete" >&2
}

main "$@"
