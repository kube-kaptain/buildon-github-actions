# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)

- name: Checkout
  uses: actions/checkout@v4.2.2
  with:
    fetch-depth: 0
    fetch-tags: true
    ref: ${{ github.event.pull_request.head.sha }}

- name: Parse workflow ref
  id: parse
  run: |
    # Extract caller's workflow file path from github.workflow_ref
    # Format: owner/repo/.github/workflows/file.yaml@ref
    workflow_path="${GITHUB_WORKFLOW_REF%%@*}"
    workflow_file=".github/workflows/${workflow_path##*/}"

    echo "Resolving ref for reusable workflow: ${WORKFLOW_NAME}.yaml"
    echo "Caller workflow: $workflow_file"

    # Check for local call (dogfooding) - uses: ./.github/workflows/...
    if grep -q 'uses:[[:space:]]*\./.github/workflows/${WORKFLOW_NAME}\.yaml[[:space:]]*$' "$workflow_file" || \
       grep -q 'uses:[[:space:]]*\./.github/workflows/${WORKFLOW_NAME}\.yaml[[:space:]]*#' "$workflow_file"; then
      echo "Local workflow call detected (dogfooding)"
      echo "ref=LOCAL" >> "$GITHUB_OUTPUT"
      exit 0
    fi

    # Find all uses lines that call this workflow and extract refs
    refs=$(grep -o 'buildon-github-actions/.github/workflows/${WORKFLOW_NAME}\.yaml@[^[:space:]"'"'"']*' "$workflow_file" | sed 's/.*@//')

    if [ -z "$refs" ]; then
      echo "::error::Could not find buildon-github-actions ref in $workflow_file"
      exit 1
    fi

    # Check all refs are identical
    unique_refs=$(echo "$refs" | sort -u)
    ref_count=$(echo "$unique_refs" | wc -l | tr -d ' ')
    echo "Found $ref_count unique ref(s): $(echo "$unique_refs" | tr '\n' ' ')"

    if [ "$ref_count" -gt 1 ]; then
      echo "::error::Multiple different refs found in $workflow_file: $(echo "$unique_refs" | tr '\n' ' ')"
      exit 1
    fi

    echo "Resolved ref: $unique_refs"
    echo "ref=$unique_refs" >> "$GITHUB_OUTPUT"
  env:
    GITHUB_WORKFLOW_REF: ${{ github.workflow_ref }}

- name: Checkout actions
  if: steps.parse.outputs.ref != 'LOCAL'
  uses: actions/checkout@v4.2.2
  with:
    repository: kube-kaptain/buildon-github-actions
    ref: ${{ steps.parse.outputs.ref }}
    path: .github/buildon-github-actions

- name: Link local actions
  if: steps.parse.outputs.ref == 'LOCAL'
  run: |
    echo "Linking local actions for dogfooding"
    ln -s "$(pwd)" .github/buildon-github-actions
