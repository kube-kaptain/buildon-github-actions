# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)

- name: Compute release notes
  id: release-notes
  if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true'
  shell: bash
  env:
    USER_NOTES: ${{ inputs.github-release-notes }}
    USER_NOTES_FILE: ${{ inputs.github-release-notes-file }}
    VERSION: ${{ steps.versions.outputs.version }}
    PROJECT_NAME: ${{ steps.versions.outputs.project-name }}
    MANIFESTS_URI: ${{ steps.manifest-repo-provider-publish.outputs.manifests-uri }}
    MANIFESTS_ZIP_FILE_NAME: ${{ steps.manifest-package.outputs.manifests-zip-file-name }}
    RELEASE_CHANGE_DATA_URI: ${{ steps.release-change-data-oci-package.outputs.release-change-data-image-uri }}
    OUTPUT_SUB_PATH: ${{ inputs.output-sub-path }}
    GITHUB_SERVER_URL: ${{ github.server_url }}
    GITHUB_REPOSITORY: ${{ github.repository }}
    BUILD_PLATFORM: github-actions
    BUILD_PLATFORM_LOG_PROVIDER: github-actions
  run: |
    display_name=$(./.github/buildon-github-actions/src/scripts/util/format-project-title "${PROJECT_NAME}")
    echo "title=${VERSION} â€” ${display_name}" >> "${GITHUB_OUTPUT}"

    if [[ -n "${USER_NOTES_FILE}" ]]; then
      # Notes come from file, skip inline notes computation
      echo "notes=" >> "${GITHUB_OUTPUT}"
    elif [[ -n "${USER_NOTES}" ]]; then
      # User provided notes override entirely
      {
        echo "notes<<NOTES_EOF"
        echo "${USER_NOTES}"
        echo "NOTES_EOF"
      } >> "${GITHUB_OUTPUT}"
    else
      # Default format
      release_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/download/${VERSION}"
      {
        echo "notes<<NOTES_EOF"
        echo "Automatic Kube Manifests release for version ${VERSION} of ${PROJECT_NAME} by Kaptain build script. This release page has the manifest zip attached as well as the manifests docker image with the same zip inside for automatic consumption."
        echo ""
        echo "### Release Assets"
        echo "* Kube Manifests: [${MANIFESTS_ZIP_FILE_NAME}](${release_url}/${MANIFESTS_ZIP_FILE_NAME})"
        echo "* Manifests Image: [${MANIFESTS_URI}](https://${MANIFESTS_URI})"
        echo "* Release Change Data: [release-change-data-${VERSION}.yaml](${release_url}/release-change-data-${VERSION}.yaml)"
        echo "* Release Change Data Image: [${RELEASE_CHANGE_DATA_URI}](https://${RELEASE_CHANGE_DATA_URI})"
        ./.github/buildon-github-actions/src/scripts/util/format-release-image-list "${OUTPUT_SUB_PATH}" "${VERSION}"
        echo "NOTES_EOF"
      } >> "${GITHUB_OUTPUT}"
    fi

- name: GitHub Release
  if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true'
  uses: ./.github/buildon-github-actions/src/actions/github-release
  with:
    github-release-enabled: ${{ inputs.github-release-enabled }}
    output-sub-path: ${{ inputs.output-sub-path }}
    github-release-tag: ${{ steps.versions.outputs.version }}
    github-release-notes: ${{ steps.release-notes.outputs.notes }}
    github-release-notes-file: ${{ inputs.github-release-notes-file }}
    github-release-title: ${{ steps.release-notes.outputs.title }}
