# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)

- name: Compute release notes
  id: release-notes
  if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true'
  shell: bash
  env:
    USER_NOTES: ${{ inputs.github-release-notes }}
    USER_NOTES_FILE: ${{ inputs.github-release-notes-file }}
    VERSION: ${{ steps.versions.outputs.version }}
    PROJECT_NAME: ${{ steps.versions.outputs.project-name }}
  run: |
    display_name=$(./.github/buildon-github-actions/src/scripts/util/format-project-title "${PROJECT_NAME}")
    echo "title=${VERSION} â€” ${display_name}" >> "${GITHUB_OUTPUT}"

    if [[ -n "${USER_NOTES_FILE}" ]]; then
      # Notes come from file, skip inline notes computation
      echo "notes=" >> "${GITHUB_OUTPUT}"
    elif [[ -n "${USER_NOTES}" ]]; then
      # User provided notes override entirely
      {
        echo "notes<<NOTES_EOF"
        echo "${USER_NOTES}"
        echo "NOTES_EOF"
      } >> "${GITHUB_OUTPUT}"
    else
      # Default format
      {
        echo "notes<<NOTES_EOF"
        echo "Automatic release for version ${VERSION} of ${PROJECT_NAME} by Kaptain build script."
        echo "NOTES_EOF"
      } >> "${GITHUB_OUTPUT}"
    fi

- name: GitHub Release
  if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true'
  uses: ./.github/buildon-github-actions/src/actions/github-release
  with:
    github-release-enabled: ${{ inputs.github-release-enabled }}
    output-sub-path: ${{ inputs.output-sub-path }}
    github-release-tag: ${{ steps.versions.outputs.version }}
    github-release-notes: ${{ steps.release-notes.outputs.notes }}
    github-release-notes-file: ${{ inputs.github-release-notes-file }}
    github-release-title: ${{ steps.release-notes.outputs.title }}
