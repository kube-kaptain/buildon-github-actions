# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)

- name: Compute release notes
  id: release-notes
  if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true'
  shell: bash
  env:
    USER_NOTES: ${{ inputs.github-release-notes }}
    VERSION: ${{ steps.versions.outputs.version }}
    PROJECT_NAME: ${{ steps.versions.outputs.project-name }}
    DOCKER_URI: ${{ steps.docker-build.outputs.docker-target-image-full-uri }}
    MANIFESTS_URI: ${{ steps.manifest-repo-provider-publish.outputs.manifests-uri }}
    MANIFESTS_ZIP_FILE_NAME: ${{ steps.manifest-package.outputs.manifests-zip-file-name }}
    GITHUB_SERVER_URL: ${{ github.server_url }}
    GITHUB_REPOSITORY: ${{ github.repository }}
  run: |
    display_name=$(./.github/buildon-github-actions/src/scripts/util/format-project-title "${PROJECT_NAME}")
    echo "title=${VERSION} â€” ${display_name}" >> "${GITHUB_OUTPUT}"

    if [[ -n "${USER_NOTES}" ]]; then
      # User provided notes override entirely
      {
        echo "notes<<NOTES_EOF"
        echo "${USER_NOTES}"
        echo "NOTES_EOF"
      } >> "${GITHUB_OUTPUT}"
    else
      # Default format
      release_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/download/${VERSION}"
      {
        echo "notes<<NOTES_EOF"
        echo "Automatic Kube App release for version ${VERSION} of ${PROJECT_NAME} by Kaptain build script. This release page has the manifest zip attached as well as the main docker image, and the manifests docker image with the same zip inside for automatic consumption."
        echo ""
        echo "### Release Assets"
        echo "* Kube Manifests: [${MANIFESTS_ZIP_FILE_NAME}](${release_url}/${MANIFESTS_ZIP_FILE_NAME})"
        echo "* Docker Image: [${DOCKER_URI}](https://${DOCKER_URI})"
        echo "* Manifests Image: [${MANIFESTS_URI}](https://${MANIFESTS_URI})"
        echo "NOTES_EOF"
      } >> "${GITHUB_OUTPUT}"
    fi

- name: GitHub Release
  if: inputs.github-release-enabled == true && steps.versions.outputs.is-release == 'true'
  uses: ./.github/buildon-github-actions/src/actions/github-release
  with:
    github-release-enabled: ${{ inputs.github-release-enabled }}
    output-sub-path: ${{ inputs.output-sub-path }}
    github-release-tag: ${{ steps.versions.outputs.version }}
    github-release-notes: ${{ steps.release-notes.outputs.notes }}
    github-release-title: ${{ steps.release-notes.outputs.title }}
