# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)

name: 'Kubernetes Manifest Publish'
description: 'Publishes manifest zip via pluggable repo provider (docker, github-release)'
author: 'kube-kaptain'

inputs:
  manifest-repo-provider-type:
    description: 'Manifest repo provider type (required): docker, github-release'
    required: true
  manifest-zip-path:
    description: 'Path to the manifest zip file'
    required: true
  manifest-zip-name:
    description: 'Filename for the manifest zip (required for github-release)'
    required: false
    default: ''
  output-path:
    description: 'Build output directory'
    required: false
    default: 'target'
  # Docker repo provider inputs
  target-registry:
    description: 'Target container registry (docker repo provider)'
    required: false
    default: 'ghcr.io'
  target-base-path:
    description: 'Path between registry and image name (docker repo provider)'
    required: false
    default: ''
  target-image-name:
    description: 'Target image name (docker repo provider)'
    required: false
    default: ''
  docker-tag:
    description: 'Tag for target image (docker repo provider)'
    required: false
    default: ''
  confirm-image-doesnt-exist:
    description: 'Fail if target image already exists in registry (docker repo provider)'
    required: false
    default: 'true'
  # GitHub release repo provider inputs
  version:
    description: 'Release tag/version (github-release repo provider)'
    required: false
    default: ''
  # Common inputs
  is-release:
    description: 'Whether to push/upload'
    required: true

outputs:
  manifest-uri:
    description: 'Reference to published manifests (format depends on repo provider)'
    value: ${{ steps.publish.outputs.MANIFEST_URI }}
  manifest-published:
    description: 'Whether manifests were published'
    value: ${{ steps.publish.outputs.MANIFEST_PUBLISHED }}

runs:
  using: 'composite'
  steps:
    - name: Compute target base path
      id: base-path
      shell: bash
      run: |
        # Auto-set base path for GHCR if not explicitly provided
        if [[ "${{ inputs.target-registry }}" == "ghcr.io" && -z "${{ inputs.target-base-path }}" ]]; then
          echo "path=${{ github.repository_owner }}" >> "$GITHUB_OUTPUT"
        else
          echo "path=${{ inputs.target-base-path }}" >> "$GITHUB_OUTPUT"
        fi

    - name: Publish manifests
      id: publish
      shell: bash
      env:
        LOG_ERROR_PREFIX: '::error::'
        MANIFEST_REPO_PROVIDER_TYPE: ${{ inputs.manifest-repo-provider-type }}
        MANIFEST_ZIP_PATH: ${{ inputs.manifest-zip-path }}
        MANIFEST_ZIP_NAME: ${{ inputs.manifest-zip-name }}
        OUTPUT_PATH: ${{ inputs.output-path }}
        TARGET_REGISTRY: ${{ inputs.target-registry }}
        TARGET_BASE_PATH: ${{ steps.base-path.outputs.path }}
        TARGET_IMAGE_NAME: ${{ inputs.target-image-name }}
        DOCKER_TAG: ${{ inputs.docker-tag }}
        CONFIRM_IMAGE_DOESNT_EXIST: ${{ inputs.confirm-image-doesnt-exist }}
        VERSION: ${{ inputs.version }}
        IS_RELEASE: ${{ inputs.is-release }}
        GITHUB_TOKEN: ${{ github.token }}
      run: "${{ github.action_path }}/../../scripts/main/kubernetes-manifest-publish"
